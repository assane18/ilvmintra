Directory structure:
└── assane18-ilvmintra/
    ├── config.py
    ├── run.py
    ├── setup.sh
    ├── start.sh
    ├── app/
    │   ├── __init__.py
    │   ├── emails.py
    │   ├── models.py
    │   ├── routes/
    │   │   ├── api.py
    │   │   ├── auth.py
    │   │   ├── fcpi.py
    │   │   ├── inventaire.py
    │   │   ├── main.py
    │   │   ├── prets.py
    │   │   ├── tickets.py
    │   │   └── users.py
    │   ├── static/
    │   │   └── uploads/
    │   │       ├── Export_Prets_20260114_1106.xlsx
    │   │       ├── Export_Stock_20260114_1106.xlsx
    │   │       ├── Historique_Tickets_20260114_1127.xlsx
    │   │       └── tickets/
    │   │           └── 20251230-001/
    │   │               └── Export_Prets_20251223.xlsx
    │   └── templates/
    │       ├── admin_users.html
    │       ├── base.html
    │       ├── inventaire.html
    │       ├── my_history.html
    │       ├── portal.html
    │       ├── prets.html
    │       ├── tickets.html
    │       ├── auth/
    │       │   └── login.html
    │       ├── emails/
    │       │   └── notification.html
    │       ├── errors/
    │       │   └── catdance.html
    │       ├── fcpi/
    │       │   ├── new_fcpi.html
    │       │   └── view_fcpi.html
    │       └── tickets/
    │           ├── detail.html
    │           ├── historique_tickets.html
    │           ├── manager_dashboard.html
    │           ├── new_fcpi.html
    │           ├── new_ticket.html
    │           ├── service_dashboard.html
    │           └── solver_dashboard.html
    └── migrations/
        ├── README
        ├── alembic.ini
        ├── env.py
        ├── script.py.mako
        └── versions/
            ├── 068a52b5c548_maj_formulaire_daf.py
            ├── 0901c63adb4b_maj_formulaire_daf.py
            ├── 114d53f55048_creation_formulaire_fcpi.py
            ├── 118a1f52bf93_maj_formulaire_daf.py
            ├── 153533dd96a0_maj_formulaire_daf.py
            ├── 2eecb37fbc37_ajout_groupes_json_et_workflow_n2.py
            ├── 4acfea4b356b_maj_formulaire_daf.py
            ├── a0c4c67305ee_creation_formulaire_fcpi.py
            ├── a7f8fe4f2491_maj_formulaire_fcpi.py
            ├── bf90708aee1c_creation_formulaire_fcpi.py
            ├── f94c753e54db_maj_formulaire_daf.py
            └── faea908d11f5_reset_full_schema.py

================================================
FILE: config.py
================================================
import os
import os
from dotenv import load_dotenv
import os
from dotenv import load_dotenv

basedir = os.path.abspath(os.path.dirname(__file__))
load_dotenv(os.path.join(basedir, '.env'))

class Config:
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'dev-key-tres-secrete-a-changer'
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    
    # Configuration Uploads
    UPLOAD_FOLDER = os.path.join(basedir, 'app/static/uploads')
    MAX_CONTENT_LENGTH = 20 * 1024 * 1024  # 20MB max

    MAIL_SERVER = os.environ.get('MAIL_SERVER') or '192.168.1.4'
    MAIL_PORT = int(os.environ.get('MAIL_PORT') or 25)
    MAIL_USE_TLS = False
    MAIL_USERNAME = None
    MAIL_PASSWORD = None
    MAIL_DEFAULT_SENDER = os.environ.get('MAIL_DEFAULT_SENDER') or 'no-reply-intranet@ilvm.lan'
    MAIL_DEBUG = False


class DevelopmentConfig(Config):
    DEBUG = True
    # SQLite local pour le dev WSL
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or \
        'sqlite:///' + os.path.join(basedir, 'dev_intranet_v2.db')

class ProductionConfig(Config):
    DEBUG = False
    # PostgreSQL pour la prod (Debian)
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL')

config = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
    'default': DevelopmentConfig
}



================================================
FILE: run.py
================================================
import os
from app import create_app, db
from app.models import User, Ticket, UserRole, ServiceType

app = create_app(os.getenv('FLASK_CONFIG') or 'default')

# Context Processor pour le shell flask
@app.shell_context_processor
def make_shell_context():
    return dict(db=db, User=User, Ticket=Ticket, UserRole=UserRole, ServiceType=ServiceType)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)



================================================
FILE: setup.sh
================================================
#!/bin/bash

# Script d'installation TOTAL pour Debian 12
# À lancer depuis le dossier contenant les fichiers du projet sur le serveur
# Usage: sudo ./setup_production.sh

# --- VARIABLES ---
TARGET_DIR="/var/www/intranet"
DB_NAME="intranet_db"
DB_USER="intranet_user"
# Nouveau mot de passe sans '@' pour éviter les erreurs de parsing d'URL SQLAlchemy
DB_PASS="y89#nC$*Xt_Hur" 
DOMAIN_NAME="ilvmintra1" # Nom machine/Domaine
SERVER_IP="192.168.1.25"
LDAP_SERVER="192.168.1.9"

# Couleurs
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

# Vérification Root
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}Erreur : Ce script doit être lancé avec sudo.${NC}"
  exit 1
fi

echo -e "${BLUE}=== 1. MISE À JOUR ET DÉPENDANCES ===${NC}"
apt-get update
apt-get install -y python3-pip python3-dev python3-venv build-essential \
    libldap2-dev libsasl2-dev libssl-dev \
    libpq-dev postgresql postgresql-contrib \
    nginx git curl dnsutils acl

echo -e "${BLUE}=== 2. PRÉPARATION DES FICHIERS ===${NC}"
# Création du dossier cible
mkdir -p $TARGET_DIR

# Copie des fichiers du dossier courant vers /var/www/intranet
echo "Copie des fichiers vers $TARGET_DIR..."
cp -r . $TARGET_DIR/

# Nettoyage des fichiers inutiles copiés (venv local, git, etc)
rm -rf $TARGET_DIR/venv
rm -rf $TARGET_DIR/.git
rm -rf $TARGET_DIR/__pycache__
rm -f $TARGET_DIR/dev_intranet_v2.db

# Permissions
echo "Configuration des permissions..."
# On donne la propriété à l'utilisateur courant (pour l'édition) et au groupe www-data
REAL_USER=$(logname)
chown -R $REAL_USER:www-data $TARGET_DIR
chmod -R 775 $TARGET_DIR

echo -e "${BLUE}=== 3. ENVIRONNEMENT PYTHON ===${NC}"
cd $TARGET_DIR

# Création venv
if [ ! -d "venv" ]; then
    python3 -m venv venv
fi
source venv/bin/activate

# Installation dépendances
echo "Installation des librairies Python..."
# On s'assure que pip est à jour
pip install --upgrade pip
# Installation des paquets requis
pip install flask flask-sqlalchemy flask-login flask-migrate python-dotenv pandas openpyxl psycopg2-binary gunicorn ldap3

echo -e "${BLUE}=== 4. BASE DE DONNÉES POSTGRESQL ===${NC}"
# Configuration PostgreSQL
# On vérifie si l'utilisateur existe déjà pour éviter les erreurs
# Note: Si l'utilisateur existe déjà avec l'ancien mot de passe, on le met à jour
sudo -u postgres psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='$DB_USER'" | grep -q 1 || sudo -u postgres psql -c "CREATE USER $DB_USER WITH PASSWORD '$DB_PASS';"
# Force la mise à jour du mot de passe pour être sûr qu'il correspond à celui du script
sudo -u postgres psql -c "ALTER USER $DB_USER WITH PASSWORD '$DB_PASS';"

sudo -u postgres psql -tAc "SELECT 1 FROM pg_database WHERE datname='$DB_NAME'" | grep -q 1 || sudo -u postgres psql -c "CREATE DATABASE $DB_NAME OWNER $DB_USER;"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;"

echo -e "${BLUE}=== 5. CONFIGURATION .ENV ===${NC}"
# Génération du fichier .env de production avec vos infos LDAP
cat > .env <<EOL
FLASK_APP=run.py
FLASK_DEBUG=0
SECRET_KEY=$(openssl rand -hex 32)
DATABASE_URL=postgresql://$DB_USER:$DB_PASS@localhost/$DB_NAME
# Important pour que Flask sache qu'il est dans un sous-dossier /intranet
SCRIPT_NAME=/intranet

# Configuration LDAP ($DOMAIN_NAME)
LDAP_HOST=$LDAP_SERVER
LDAP_DOMAIN=ilvm.lan
LDAP_BASE_DN=DC=ilvm,DC=lan
# Compte de service AD (aintra)
LDAP_USER_DN='CN=Admin Intra,CN=Users,DC=ilvm,DC=lan'
LDAP_USER_PASSWORD='gq!nsXPYsM!LmFh4'
EOL

# Permissions sur le .env (sensible)
chmod 640 .env
chown $REAL_USER:www-data .env

echo -e "${BLUE}=== 6. INITIALISATION BDD (MIGRATIONS) ===${NC}"
# On tente d'initialiser la structure
export FLASK_APP=run.py
if [ -d "migrations" ]; then
    echo "Dossier migrations existant, on tente une mise à jour..."
    flask db upgrade
else
    echo "Initialisation complète de la BDD..."
    flask db init
    flask db migrate -m "Initial Deploy"
    flask db upgrade
fi

# Création d'un admin de secours si la table est vide
echo "Vérification Admin..."
python3 -c "
from app import create_app, db
from app.models import User, UserRole
app = create_app('production')
with app.app_context():
    try:
        if not User.query.filter_by(username='admin').first():
            u = User(username='admin', role=UserRole.ADMIN, fullname='Super Admin Local')
            db.session.add(u)
            db.session.commit()
            print('Admin local créé (user: admin).')
    except Exception as e:
        print(f'Erreur lors de la création de l\'admin: {e}')
"

echo -e "${BLUE}=== 7. CONFIGURATION SYSTEMD (GUNICORN) ===${NC}"
cat > /etc/systemd/system/intranet.service <<EOL
[Unit]
Description=Gunicorn instance to serve Intranet V2
After=network.target

[Service]
User=$REAL_USER
Group=www-data
WorkingDirectory=$TARGET_DIR
Environment="PATH=$TARGET_DIR/venv/bin"
EnvironmentFile=$TARGET_DIR/.env
# On ajoute SCRIPT_NAME pour le routage Flask
Environment="SCRIPT_NAME=/intranet"
ExecStart=$TARGET_DIR/venv/bin/gunicorn --workers 3 --bind unix:intranet.sock -m 007 run:app

[Install]
WantedBy=multi-user.target
EOL

systemctl daemon-reload
systemctl enable intranet
systemctl restart intranet

echo -e "${BLUE}=== 8. CONFIGURATION NGINX ===${NC}"
cat > /etc/nginx/sites-available/intranet <<EOL
server {
    listen 80;
    server_name $DOMAIN_NAME $SERVER_IP ilvm.lan;

    # Accès via /intranet
    location /intranet {
        include proxy_params;
        proxy_pass http://unix:$TARGET_DIR/intranet.sock;
        
        # Réglages importants pour le sous-répertoire
        proxy_set_header X-Script-Name /intranet;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header Host \$host;
        proxy_redirect off;
    }

    # Fichiers statiques (CSS, JS, Images)
    location /intranet/static {
        alias $TARGET_DIR/app/static;
    }
    
    # Redirection racine vers /intranet (Optionnel)
    location = / {
        return 301 /intranet;
    }
}
EOL

# Activation
ln -sf /etc/nginx/sites-available/intranet /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default
nginx -t && systemctl restart nginx

echo -e "${GREEN}=== DÉPLOIEMENT TERMINÉ AVEC SUCCÈS ===${NC}"
echo "L'application est en ligne sur http://$DOMAIN_NAME/intranet (ou http://$SERVER_IP/intranet)"
echo "Les fichiers sont installés dans $TARGET_DIR"



================================================
FILE: start.sh
================================================
#!/bin/bash

# Script de lancement automatique Intranet V2 (Mode Reset Total)
# Usage: ./launch.sh

echo "=== Démarrage Intranet V2 (Mode Reset) ==="

# 1. Vérifier/Créer l'environnement virtuel
if [ ! -d "venv" ]; then
    echo ">> Création de l'environnement virtuel..."
    python3 -m venv venv
fi

# 2. Activer l'environnement
source venv/bin/activate

# 3. Installer les dépendances (y compris pandas et openpyxl)
echo ">> Installation des librairies..."
pip install flask flask-sqlalchemy flask-login flask-migrate python-dotenv pandas openpyxl > /dev/null

# 4. Vérifier les dossiers critiques
if [ ! -f "app/templates/base.html" ]; then
    echo "ERREUR : Le fichier app/templates/base.html est manquant !"
    exit 1
fi

# 5. REINITIALISATION FORCEE DE LA BDD (Pour corriger l'erreur 'no such table')
echo ">> Nettoyage et Réinitialisation de la Base de Données..."
if [ -f "dev_intranet_v2.db" ]; then
    rm dev_intranet_v2.db
    echo "   - Ancienne base supprimée."
fi

if [ -d "migrations" ]; then
    rm -rf migrations
    echo "   - Anciennes migrations supprimées."
fi

export FLASK_APP=run.py
flask db init > /dev/null
flask db migrate -m "Reset Full Schema" > /dev/null
flask db upgrade > /dev/null
echo ">> Nouvelle base de données générée avec succès (Tables: users, tickets, materiels, prets...)."

# 6. Lancement du serveur
echo ">> Lancement du serveur..."
echo "Accédez à : http://localhost:5000"
echo "Utilisez l'utilisateur 'admin' (mdp: password) pour tester l'inventaire."
export FLASK_APP=run.py
export FLASK_DEBUG=1
flask run --host=0.0.0.0



================================================
FILE: app/__init__.py
================================================
import os
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager
from flask_migrate import Migrate
from flask_mail import Mail
from config import config


db = SQLAlchemy()
migrate = Migrate()
login_manager = LoginManager()
mail = Mail() 
login_manager.login_view = 'auth.login'

@login_manager.user_loader
def load_user(user_id):
    from .models import User
    return User.query.get(int(user_id))

def create_app(config_name='default'):
    app = Flask(__name__)
    app.config.from_object(config[config_name])
    
    if not app.config.get('SECRET_KEY'):
        app.config['SECRET_KEY'] = 'dev-key-fixe-pour-test'

    db.init_app(app)
    migrate.init_app(app, db)
    login_manager.init_app(app)
    mail.init_app(app)

    # Enregistrement OBLIGATOIRE des 3 Blueprints
    from .routes.auth import auth_bp
    app.register_blueprint(auth_bp, url_prefix='/auth')
    
    from .routes.main import main_bp
    app.register_blueprint(main_bp)
    
    from .routes.tickets import tickets_bp
    app.register_blueprint(tickets_bp, url_prefix='/tickets')

    # NOUVEAU : Module Inventaire
    from .routes.inventaire import inventaire_bp
    app.register_blueprint(inventaire_bp) # Pas de préfixe pour garder /inventaire direct

    from .routes.prets import prets_bp
    app.register_blueprint(prets_bp)

    # NOUVEAU : Module Users
    from .routes.users import users_bp
    app.register_blueprint(users_bp)

    from .routes.api import api_bp
    app.register_blueprint(api_bp)

    # NOUVEAU : Module FCPI
    from .routes.fcpi import fcpi_bp
    app.register_blueprint(fcpi_bp)

    return app



================================================
FILE: app/emails.py
================================================
from threading import Thread
from flask import current_app, render_template
from flask_mail import Message
from . import mail

def send_async_email(app, msg):
    """Envoie le mail dans un thread séparé"""
    with app.app_context():
        try:
            mail.send(msg)
            print(f"EMAIL SENT: {msg.subject} to {msg.recipients}")
        except Exception as e:
            print(f"EMAIL ERROR: {e}")

def send_email(to, subject, template, **kwargs):
    """
    Prépare et envoie un email.
    :param to: Email destinataire
    :param subject: Sujet
    :param template: Nom du template HTML (sans extension) dans templates/emails/
    :param kwargs: Variables passées au template (user, ticket, etc.)
    """
    app = current_app._get_current_object()
    
    msg = Message(
        subject=f"[INTRANET] {subject}",
        recipients=[to],
        sender=app.config['MAIL_DEFAULT_SENDER']
    )
    
    # On charge le corps du mail depuis un template HTML
    msg.html = render_template(f'emails/{template}.html', **kwargs)
    
    thr = Thread(target=send_async_email, args=(app, msg))
    thr.start()
    return thr



================================================
FILE: app/models.py
================================================
from . import db
from flask_login import UserMixin
from datetime import datetime
import enum
import json

class UserRole(str, enum.Enum):
    USER = "USER"
    MANAGER = "MANAGER"
    DIRECTEUR = "DIRECTEUR"
    SOLVER = "SOLVER"
    ADMIN = "ADMIN"

class TicketStatus(str, enum.Enum):
    VALIDATION_N1 = "VALIDATION_HIERARCHIQUE"
    VALIDATION_N2 = "VALIDATION_TECHNIQUE"
    DAF_SIGNATURE = "SIGNATURE_DIRECTEUR"
    PENDING = "EN_ATTENTE_TRAITEMENT"
    IN_PROGRESS = "EN_COURS"
    WAITING_USER = "EN_ATTENTE_USER"
    REFUSED = "REFUSE"
    DONE = "TERMINE"

class ServiceType(str, enum.Enum):
    # Services Historiques
    INFO = "INFORMATIQUE"
    DAF = "DAF"
    GEN = "GENERAUX"
    TECH = "TECHNIQUE"
    DRH = "DRH"
    SECU = "SECU" # Badge / Accès
    AUTRE = "AUTRE"

    # Nouveaux Services Ajoutés
    IMAGO = "IMAGO"  
    ACCUEIL = "Accueil"
    ARCHIPELLE = "Archipelle"
    CELLULE_PARCOURS = "Cellule Parcours"
    CSD = "CSD"
    DG = "DG"
    EAM_DRAVEIL = "EAM Draveil"
    ESAT = "ESAT"
    ESPACE_LOISIRS = "Espace Loisirs"
    FH = "FH"
    FJ = "FJ"
    FV = "FV"
    GITE = "Gite"
    IME_CORBEIL = "IME Corbeil"
    MAGASIN = "Magasin"
    MAS = "MAS"
    MAS_EXTERNAT = "MAS Externat"
    MAS_INCLUSIVE = "MAS Inclusive"
    PATRIMOINE = "Patrimoine"
    QUALITE = "Qualite"
    SACAT = "SACAT"
    SAMSAH = "SAMSAH"
    SAVIE = "SAVIE"
    SECURITE_INCENDIE = "Sécurité Incendie"
    SESSAD_CORBEIL = "SESSAD Corbeil"
    SESSAD_CRETEIL = "SESSAD Créteil"
    SESSAD_TSA = "SESSAD TSA"
    SG = "SG"
    SRU = "SRU"
    SYNDICAT = "Syndicat"
    TKITOI = "TKITOI"
    UEEA = "UEEA"
    UEMA = "UEMA"

class RecruitmentStatus(str, enum.Enum):
    WAITING_RH_MGR = "VALIDATION_RH_MANAGER"
    WAITING_RH_DIR = "VALIDATION_RH_DIRECTEUR"
    REFUSED = "REFUSE"
    DISPATCHED = "DISPATCHE_AUX_SERVICES" 
    DONE = "TERMINE"

class User(UserMixin, db.Model):
    __tablename__ = 'users'
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(64), unique=True, index=True)
    fullname = db.Column(db.String(120))
    email = db.Column(db.String(120))
    role = db.Column(db.Enum(UserRole), default=UserRole.USER)
    origin_services_json = db.Column(db.Text, default='[]')
    allowed_services_json = db.Column(db.Text, default='[]')
    location = db.Column(db.String(100), nullable=True)
    notifications = db.relationship('Notification', backref='user', lazy='dynamic')

    def set_origin_services(self, services_list):
        try: self.origin_services_json = json.dumps(services_list)
        except: self.origin_services_json = '[]'

    def get_origin_services(self):
        try: return json.loads(self.origin_services_json) or []
        except: return []

    def set_allowed_services(self, services_list):
        try: self.allowed_services_json = json.dumps(services_list)
        except: self.allowed_services_json = '[]'

    def get_allowed_services(self):
        try: return json.loads(self.allowed_services_json) or []
        except: return []

    def __repr__(self):
        return f'<User {self.username}>'

class Ticket(db.Model):
    __tablename__ = 'tickets'
    id = db.Column(db.Integer, primary_key=True)
    uid_public = db.Column(db.String(30), unique=True, index=True)
    title = db.Column(db.String(200), nullable=False)
    description = db.Column(db.Text, nullable=False)
    author_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    author = db.relationship('User', foreign_keys=[author_id], backref='my_tickets')
    target_service = db.Column(db.Enum(ServiceType), nullable=False)
    status = db.Column(db.Enum(TicketStatus), default=TicketStatus.VALIDATION_N1)
    solver_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=True)
    solver = db.relationship('User', foreign_keys=[solver_id], backref='assigned_tickets')
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    closed_at = db.Column(db.DateTime, nullable=True)
    category_ticket = db.Column(db.String(50)) 
    hostname = db.Column(db.String(64), nullable=True)
    service_demandeur = db.Column(db.String(100), nullable=True)
    tel_demandeur = db.Column(db.String(20), nullable=True)
    lieu_installation = db.Column(db.String(100), nullable=True)
    new_user_fullname = db.Column(db.String(150), nullable=True)
    new_user_service = db.Column(db.String(100), nullable=True)
    new_user_acces = db.Column(db.String(255), nullable=True)
    new_user_date = db.Column(db.DateTime, nullable=True)
    materiel_list = db.Column(db.Text, nullable=True)
    destinataire_materiel = db.Column(db.String(150), nullable=True)
    service_destinataire = db.Column(db.String(100), nullable=True)
    daf_lieu_livraison = db.Column(db.String(100))
    daf_fournisseur_nom = db.Column(db.String(100))
    daf_fournisseur_tel = db.Column(db.String(50))
    daf_fournisseur_fax = db.Column(db.String(50))
    daf_fournisseur_email = db.Column(db.String(100))
    daf_type_prix = db.Column(db.String(10))
    daf_lignes_json = db.Column(db.Text) 
    daf_files_json = db.Column(db.Text)
    daf_uf = db.Column(db.String(50), nullable=True)
    daf_budget_affecte = db.Column(db.String(100), nullable=True)
    daf_new_supplier = db.Column(db.Boolean, default=False)
    daf_siret = db.Column(db.String(50), nullable=True)
    daf_fournisseur_tel_comment = db.Column(db.String(100), nullable=True)
    daf_rib_file = db.Column(db.String(255), nullable=True)
    daf_solver_file = db.Column(db.String(255), nullable=True)
    daf_signed_file = db.Column(db.String(255), nullable=True)

    def get_safe_status(self):
        if self.status is None: return "INCONNU"
        if hasattr(self.status, 'value'): return str(self.status.value)
        return str(self.status)

    def get_safe_target_service(self):
        if self.target_service is None: return "AUTRE"
        if hasattr(self.target_service, 'value'): return str(self.target_service.value)
        return str(self.target_service)

    def get_daf_lignes(self):
        if not self.daf_lignes_json: return []
        try: return json.loads(self.daf_lignes_json)
        except: return []

    def get_daf_files(self):
        if not self.daf_files_json: return []
        try: return json.loads(self.daf_files_json)
        except: return []

class Recruitment(db.Model):
    __tablename__ = 'recruitments'
    id = db.Column(db.Integer, primary_key=True)
    uid_public = db.Column(db.String(20), unique=True, index=True)
    author_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    author = db.relationship('User', backref='my_recruitments')
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    status = db.Column(db.Enum(RecruitmentStatus), default=RecruitmentStatus.WAITING_RH_MGR)
    
    # --- Données Agent ---
    date_entree = db.Column(db.DateTime)
    nom_agent = db.Column(db.String(100))
    prenom_agent = db.Column(db.String(100))
    fonction = db.Column(db.String(100))
    service_agent = db.Column(db.String(100))
    uf_agent = db.Column(db.String(50))
    
    # --- DRH ---
    contractuel = db.Column(db.Boolean, default=False)
    date_debut_contrat = db.Column(db.DateTime, nullable=True)
    date_fin_contrat = db.Column(db.DateTime, nullable=True)
    condition_recrutement = db.Column(db.String(50)) 
    temps_travail = db.Column(db.String(50)) 
    pourcentage_temps = db.Column(db.String(20), nullable=True)
    motif_recrutement = db.Column(db.String(50)) 
    simulation_salaire = db.Column(db.Boolean, default=False)
    
    # --- Badge & Clefs ---
    localisation_poste = db.Column(db.String(100))
    commentaire_securite = db.Column(db.Text)
    
    # --- Imago ---
    imago_active = db.Column(db.Boolean, default=False)
    imago_mobilite = db.Column(db.String(200), nullable=True)
    
    # --- Informatique ---
    materiels_demandes = db.Column(db.String(255))
    acces_informatique = db.Column(db.Text)
    
    # --- Fichiers ---
    file_cv = db.Column(db.String(255))
    file_fiche_poste = db.Column(db.String(255))
    file_photo = db.Column(db.String(255))
    
    # --- Workflow ---
    refusal_reason = db.Column(db.Text)
    child_tickets_ids = db.Column(db.Text, default='[]') 

    def get_child_tickets(self):
        try: return json.loads(self.child_tickets_ids)
        except: return []

    # --- AJOUTS POUR LE SUIVI ---
    def get_child_tickets_objects(self):
        """Retourne la liste des objets Ticket réels pour affichage statut"""
        ids = self.get_child_tickets()
        if not ids: return []
        return Ticket.query.filter(Ticket.id.in_(ids)).all()

    @property
    def is_fully_completed(self):
        """Vérifie si tous les sous-tickets sont terminés"""
        tickets = self.get_child_tickets_objects()
        if not tickets: return False
        return all(t.status == TicketStatus.DONE for t in tickets)

class TicketMessage(db.Model):
    __tablename__ = 'ticket_messages'
    id = db.Column(db.Integer, primary_key=True)
    content = db.Column(db.Text, nullable=False)
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)
    ticket_id = db.Column(db.Integer, db.ForeignKey('tickets.id'))
    ticket = db.relationship('Ticket', backref='messages')
    author_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    author = db.relationship('User')

class TeamMessage(db.Model):
    __tablename__ = 'team_messages'
    id = db.Column(db.Integer, primary_key=True)
    service = db.Column(db.Enum(ServiceType), nullable=False)
    content = db.Column(db.Text, nullable=False)
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)
    author_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    author = db.relationship('User')

class Materiel(db.Model):
    __tablename__ = 'materiels'
    id = db.Column(db.Integer, primary_key=True)
    categorie = db.Column(db.String(50))
    modele = db.Column(db.String(100))
    sn = db.Column(db.String(100), unique=True)
    hostname = db.Column(db.String(100))
    imei = db.Column(db.String(100))
    statut = db.Column(db.String(50), default='Disponible')
    historique_prets = db.relationship('Pret', backref='materiel_rel', lazy='dynamic')

class Pret(db.Model):
    __tablename__ = 'prets'
    id = db.Column(db.Integer, primary_key=True)
    materiel_id = db.Column(db.Integer, db.ForeignKey('materiels.id'))
    technicien_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    technicien = db.relationship('User', backref='prets_geres')
    nom_emprunteur = db.Column(db.String(100))
    prenom_emprunteur = db.Column(db.String(100))
    service_emprunteur = db.Column(db.String(100))
    date_sortie = db.Column(db.DateTime, default=datetime.utcnow)
    date_retour_prevue = db.Column(db.DateTime, nullable=True)
    date_retour_reelle = db.Column(db.DateTime, nullable=True)
    statut_dossier = db.Column(db.String(20), default='En cours')
    type_pret = db.Column(db.String(50))
    accessoires = db.Column(db.String(255))
    etat_ecran_sortie = db.Column(db.String(50))
    etat_clavier_sortie = db.Column(db.String(50))
    etat_coque_sortie = db.Column(db.String(50))
    etat_ecran_retour = db.Column(db.String(50))
    etat_clavier_retour = db.Column(db.String(50))
    etat_coque_retour = db.Column(db.String(50))

class Notification(db.Model):
    __tablename__ = 'notifications'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    message = db.Column(db.String(255), nullable=False)
    category = db.Column(db.String(20), default='info')
    link = db.Column(db.String(255))
    is_read = db.Column(db.Boolean, default=False)
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)

    def to_dict(self):
        return {
            'id': self.id,
            'message': self.message,
            'category': self.category,
            'link': self.link,
            'is_read': self.is_read,
            'timestamp': self.timestamp.isoformat()
        }



================================================
FILE: app/routes/api.py
================================================
from flask import Blueprint, jsonify, request
from flask_login import login_required, current_user
from app.models import Notification, TeamMessage, ServiceType
from app import db
from datetime import datetime

api_bp = Blueprint('api', __name__)

# --- NOTIFICATIONS ---

# Route principale (Liste + Count)
@api_bp.route('/api/notifications', methods=['GET'])
@login_required
def get_notifications():
    try:
        notifs = current_user.notifications.filter_by(is_read=False).order_by(Notification.timestamp.desc()).limit(10).all()
        count = current_user.notifications.filter_by(is_read=False).count()
        return jsonify({'count': count, 'notifications': [n.to_dict() for n in notifs]})
    except Exception as e:
        print(f"API NOTIF ERROR: {e}")
        return jsonify({'count': 0, 'notifications': []})

# Route spécifique COUNT (Ajoutée pour corriger l'erreur 404)
@api_bp.route('/api/notifications/count', methods=['GET'])
@login_required
def get_notifications_count():
    try:
        count = current_user.notifications.filter_by(is_read=False).count()
        return jsonify({'count': count})
    except Exception as e:
        return jsonify({'count': 0})

@api_bp.route('/api/notifications/read/<int:id>', methods=['POST'])
@login_required
def mark_read(id):
    notif = Notification.query.get_or_404(id)
    if notif.user_id != current_user.id: return jsonify({'error': 'Unauthorized'}), 403
    notif.is_read = True
    db.session.commit()
    return jsonify({'success': True})

@api_bp.route('/api/notifications/read_all', methods=['POST'])
@login_required
def mark_all_read():
    current_user.notifications.filter_by(is_read=False).update({'is_read': True})
    db.session.commit()
    return jsonify({'success': True})

# --- TEAM CHAT ---

@api_bp.route('/api/team_chat', methods=['GET'])
@login_required
def get_team_messages():
    try:
        # CORRECTION : Utilisation de get_allowed_services() au lieu de service_department
        my_services = current_user.get_allowed_services()
        
        if not my_services:
            return jsonify([]) # Pas de service technique = Pas de chat
            
        main_service_name = my_services[0]
        
        # Recherche de l'Enum
        svc_enum = None
        for s in ServiceType:
            if s.value == main_service_name or s.name == main_service_name:
                svc_enum = s
                break
        
        if not svc_enum: 
            return jsonify([])

        messages = TeamMessage.query.filter_by(service=svc_enum)\
            .order_by(TeamMessage.timestamp.desc())\
            .limit(50).all()
        
        msgs_data = []
        for m in reversed(messages):
            d = {
                'id': m.id,
                'content': m.content,
                'user': m.author.fullname,
                'is_me': (m.author_id == current_user.id),
                'time': m.timestamp.strftime('%H:%M')
            }
            msgs_data.append(d)
            
        return jsonify(msgs_data)

    except Exception as e:
        print(f"CHAT ERROR (GET): {e}")
        return jsonify([])

@api_bp.route('/api/team_chat', methods=['POST'])
@login_required
def post_team_message():
    try:
        my_services = current_user.get_allowed_services()
        if not my_services:
            return jsonify({'error': 'No service'}), 403
            
        main_service_name = my_services[0]
        data = request.get_json()
        content = data.get('content')
        
        if not content:
            return jsonify({'error': 'Empty content'}), 400

        svc_enum = None
        for s in ServiceType:
            if s.value == main_service_name or s.name == main_service_name:
                svc_enum = s
                break
        
        if svc_enum:
            msg = TeamMessage(service=svc_enum, content=content, author=current_user)
            db.session.add(msg)
            db.session.commit()
            return jsonify({'success': True})
        else:
            return jsonify({'error': 'Invalid Service'}), 400

    except Exception as e:
        print(f"CHAT ERROR (POST): {e}")
        return jsonify({'error': 'Internal Error'}), 500



================================================
FILE: app/routes/auth.py
================================================
from flask import Blueprint, render_template, redirect, url_for, flash, request, current_app, make_response, session
from flask_login import login_user, logout_user, login_required, current_user
from app.models import User, UserRole, ServiceType
from app import db
from ldap3 import Server, Connection, ALL, SIMPLE
from functools import wraps
from sqlalchemy.exc import DataError, StatementError
import unicodedata

auth_bp = Blueprint('auth', __name__)

# --- ANTI-CACHE RENFORCÉ ---
def nocache(view):
    @wraps(view)
    def no_cache(*args, **kwargs):
        response = make_response(view(*args, **kwargs))
        response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate, private, max-age=0'
        response.headers['Pragma'] = 'no-cache'
        response.headers['Expires'] = '0'
        return response
    return no_cache

def normalize_text(text):
    """Supprime les accents et met en majuscules pour la comparaison"""
    if not text: return ""
    text = unicodedata.normalize('NFD', text).encode('ascii', 'ignore').decode('utf-8')
    return text.upper().replace(' ', '_').replace('-', '_')

def get_ldap_connection(username, password):
    LDAP_SERVER_URL = current_app.config.get('LDAP_SERVER', 'ldap://192.168.1.9') 
    LDAP_DOMAIN_PREFIX = current_app.config.get('LDAP_DOMAIN', 'ILVM\\') 
    LDAP_BASE_DN = current_app.config.get('LDAP_BASE_DN', 'dc=ilvm,dc=lan')
    
    try:
        server = Server(LDAP_SERVER_URL, get_info=ALL, connect_timeout=5)
        clean_username = username.split('@')[0].split('\\')[-1]
        user_dn = f"{LDAP_DOMAIN_PREFIX}{clean_username}"
        conn = Connection(server, user=user_dn, password=password, authentication=SIMPLE, auto_bind=True)
        return conn, LDAP_BASE_DN, None
    except Exception as e:
        return None, None, str(e)

def parse_ad_groups(groups_entry):
    # On met tout en MAJUSCULES pour simplifier les comparaisons
    groups_list = [str(g).upper().split(',')[0].replace('CN=', '') for g in groups_entry]
    role = UserRole.USER
    origin_services = []
    allowed_services = []

    for group in groups_list:
        # 1. RÔLES (GR-)
        if group.startswith('GR-'):
            role_suffix = group.replace('GR-', '')
            if role_suffix == 'DIRECTEUR': role = UserRole.DIRECTEUR
            elif role_suffix == 'MANAGER' and role != UserRole.DIRECTEUR: role = UserRole.MANAGER
            elif role_suffix == 'SOLVER' and role != UserRole.DIRECTEUR and role != UserRole.MANAGER: role = UserRole.SOLVER
            elif role_suffix == 'ADMIN': role = UserRole.ADMIN

        # 2. SERVICES GÉRÉS (GS-)
        elif group.startswith('GS-'):
            svc_name = group.replace('GS-', '') # ex: 'SESSAD CRETEIL' ou 'INFORMATIQUE'
            
            # --- MAPPING MANUEL COMPLET ---
            # Services Historiques / Techniques
            if svc_name in ['INFORMATIQUE', 'INFO']: allowed_services.append(ServiceType.INFO.value)
            elif svc_name == 'DAF': allowed_services.append(ServiceType.DAF.value)
            elif svc_name in ['TECHNIQUE', 'TECH']: allowed_services.append(ServiceType.TECH.value)
            elif svc_name in ['GENERAUX', 'GEN']: allowed_services.append(ServiceType.GEN.value)
            elif svc_name == 'DRH': allowed_services.append(ServiceType.DRH.value)
            elif svc_name == 'SECU': allowed_services.append(ServiceType.SECU.value)
            
            # Services Ajoutés (Mapping explicite pour éviter les erreurs de syntaxe AD)
            elif svc_name == 'IMAGO': allowed_services.append(ServiceType.IMAGO.value)
            elif svc_name == 'ACCUEIL': allowed_services.append(ServiceType.ACCUEIL.value)
            elif svc_name == 'ARCHIPELLE': allowed_services.append(ServiceType.ARCHIPELLE.value)
            elif svc_name == 'CELLULE PARCOURS': allowed_services.append(ServiceType.CELLULE_PARCOURS.value)
            elif svc_name == 'CSD': allowed_services.append(ServiceType.CSD.value)
            elif svc_name == 'DG': allowed_services.append(ServiceType.DG.value)
            elif svc_name == 'EAM DRAVEIL': allowed_services.append(ServiceType.EAM_DRAVEIL.value)
            elif svc_name == 'ESAT': allowed_services.append(ServiceType.ESAT.value)
            elif svc_name == 'ESPACE LOISIRS': allowed_services.append(ServiceType.ESPACE_LOISIRS.value)
            elif svc_name == 'FH': allowed_services.append(ServiceType.FH.value)
            elif svc_name == 'FJ': allowed_services.append(ServiceType.FJ.value)
            elif svc_name == 'FV': allowed_services.append(ServiceType.FV.value)
            elif svc_name == 'GITE': allowed_services.append(ServiceType.GITE.value)
            elif svc_name == 'IME CORBEIL': allowed_services.append(ServiceType.IME_CORBEIL.value)
            elif svc_name == 'MAGASIN': allowed_services.append(ServiceType.MAGASIN.value)
            elif svc_name == 'MAS': allowed_services.append(ServiceType.MAS.value)
            elif svc_name == 'MAS EXTERNAT': allowed_services.append(ServiceType.MAS_EXTERNAT.value)
            elif svc_name == 'MAS INCLUSIVE': allowed_services.append(ServiceType.MAS_INCLUSIVE.value)
            elif svc_name == 'PATRIMOINE': allowed_services.append(ServiceType.PATRIMOINE.value)
            elif svc_name == 'QUALITE': allowed_services.append(ServiceType.QUALITE.value)
            elif svc_name == 'SACAT': allowed_services.append(ServiceType.SACAT.value)
            elif svc_name == 'SAMSAH': allowed_services.append(ServiceType.SAMSAH.value)
            elif svc_name == 'SAVIE': allowed_services.append(ServiceType.SAVIE.value)
            elif svc_name == 'SECURITE INCENDIE': allowed_services.append(ServiceType.SECURITE_INCENDIE.value)
            elif svc_name == 'SESSAD CORBEIL': allowed_services.append(ServiceType.SESSAD_CORBEIL.value)
            elif svc_name == 'SESSAD CRETEIL': allowed_services.append(ServiceType.SESSAD_CRETEIL.value)
            elif svc_name == 'SESSAD TSA': allowed_services.append(ServiceType.SESSAD_TSA.value)
            elif svc_name == 'SG': allowed_services.append(ServiceType.SG.value)
            elif svc_name == 'SRU': allowed_services.append(ServiceType.SRU.value)
            elif svc_name == 'SYNDICAT': allowed_services.append(ServiceType.SYNDICAT.value)
            elif svc_name == 'TKITOI': allowed_services.append(ServiceType.TKITOI.value)
            elif svc_name == 'UEEA': allowed_services.append(ServiceType.UEEA.value)
            elif svc_name == 'UEMA': allowed_services.append(ServiceType.UEMA.value)
            
            # Fallback (Au cas où un nouveau service arrive sans mapping)
            else:
                allowed_services.append(svc_name)

        # 3. SERVICES D'ORIGINE (GU-)
        elif group.startswith('GU-'):
            origin_services.append(group.replace('GU-', ''))

    if role == UserRole.SOLVER and not allowed_services: role = UserRole.USER
    return role, origin_services, allowed_services

@auth_bp.route('/login', methods=['GET', 'POST'])
@nocache 
def login():
    if current_user.is_authenticated:
        return redirect_by_role(current_user)

    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        conn, base_dn, error_msg = get_ldap_connection(username, password)
        
        if conn:
            try:
                clean_user = username.split('@')[0].split('\\')[-1]
                search_filter = f'(sAMAccountName={clean_user})'
                conn.search(base_dn, search_filter, attributes=['memberOf', 'displayName', 'mail'])
                
                if not conn.entries:
                    flash("Utilisateur introuvable.", "warning")
                    return render_template('auth/login.html')
                    
                user_entry = conn.entries[0]
                role, origins, alloweds = parse_ad_groups(user_entry.memberOf)
                
                user = User.query.filter_by(username=clean_user).first()
                if not user:
                    user = User(username=clean_user)
                    db.session.add(user)
                
                user.fullname = str(user_entry.displayName) if user_entry.displayName else clean_user
                user.email = str(user_entry.mail) if user_entry.mail else f"{clean_user}@ilvm.lan"
                
                # Mise à jour des droits
                user.role = role
                user.set_origin_services(origins)
                user.set_allowed_services(alloweds)
                
                if clean_user.lower() == 'administrateur': user.role = UserRole.ADMIN
                
                try:
                    db.session.commit()
                except (DataError, StatementError) as db_err:
                    db.session.rollback()
                    flash(f"Erreur Base de Données (Enum) : {db_err}", "danger")
                    print(f"ERREUR BDD: {db_err}")
                    return render_template('auth/login.html')

                login_user(user)
                return redirect_by_role(user)
                
            except Exception as e:
                flash(f"Erreur technique : {e}", "danger")
                print(f"ERREUR CONNEXION: {e}")
        else:
            flash(f"Échec connexion : {error_msg}", "danger")

    return render_template('auth/login.html')

@auth_bp.route('/logout')
@login_required
@nocache
def logout():
    session.clear()
    logout_user()
    flash("Déconnecté.", "info")
    return redirect(url_for('auth.login'))

def redirect_by_role(user):
    role = str(user.role.value).upper() if hasattr(user.role, 'value') else str(user.role).upper()
    if 'ADMIN' in role: return redirect(url_for('tickets.solver_dashboard'))
    if 'DIRECTEUR' in role or 'MANAGER' in role: return redirect(url_for('tickets.manager_dashboard'))
    if 'SOLVER' in role: return redirect(url_for('tickets.solver_dashboard'))
    return redirect(url_for('main.user_portal'))



================================================
FILE: app/routes/fcpi.py
================================================
from flask import Blueprint, render_template, redirect, url_for, flash, request, current_app
from flask_login import login_required, current_user
from app.models import Recruitment, RecruitmentStatus, UserRole, ServiceType, Ticket, TicketStatus, User, Notification
from app import db
from werkzeug.utils import secure_filename
import os, json
from datetime import datetime

fcpi_bp = Blueprint('fcpi', __name__)

def create_sub_ticket(recruitment, target_service, title, description, custom_suffix=None):
    """
    Crée un ticket sans commiter la transaction immédiatement.
    Utilise db.session.flush() pour générer l'ID.
    """
    # Si aucun suffixe n'est fourni, on prend les 3 premières lettres du service
    suffix = custom_suffix if custom_suffix else target_service.value[:3]
    
    t = Ticket(
        uid_public=f"{recruitment.uid_public}-{suffix}",
        title=f"[FCPI] {title} - {recruitment.nom_agent} {recruitment.prenom_agent}",
        description=description,
        author_id=recruitment.author_id,
        target_service=target_service,
        status=TicketStatus.PENDING,
        category_ticket="Nouvel Utilisateur"
    )
    db.session.add(t)
    db.session.flush() # <-- On flush pour avoir l'ID, mais on ne commit pas encore
    return t.id

@fcpi_bp.route('/fcpi/check_access')
@login_required
def check_access():
    role = str(current_user.role.value).upper()
    if 'MANAGER' in role or 'DIRECTEUR' in role or 'ADMIN' in role:
        return redirect(url_for('fcpi.new_fcpi'))
    else:
        return render_template('errors/catdance.html'), 403

@fcpi_bp.route('/fcpi/new', methods=['GET', 'POST'])
@login_required
def new_fcpi():
    role = str(current_user.role.value).upper()
    if not ('MANAGER' in role or 'DIRECTEUR' in role or 'ADMIN' in role):
        return render_template('errors/catdance.html'), 403

    if request.method == 'POST':
        today_str = datetime.now().strftime('%Y%m%d')
        try:
            count = Recruitment.query.filter(Recruitment.uid_public.like(f"FCPI-{today_str}%")).count() + 1
        except:
            count = 1
        uid = f"FCPI-{today_str}-{str(count).zfill(3)}"
        
        upload_path = os.path.join(current_app.root_path, 'static', 'uploads', 'fcpi', uid)
        os.makedirs(upload_path, exist_ok=True)
        
        def save_file(key):
            f = request.files.get(key)
            if f and f.filename:
                fname = secure_filename(f.filename)
                f.save(os.path.join(upload_path, fname))
                return fname
            return None

        rec = Recruitment(
            uid_public=uid,
            author=current_user,
            status=RecruitmentStatus.WAITING_RH_MGR,
            date_entree=datetime.strptime(request.form.get('date_entree'), '%Y-%m-%d'),
            nom_agent=request.form.get('nom'),
            prenom_agent=request.form.get('prenom'),
            fonction=request.form.get('fonction'),
            service_agent=request.form.get('service'),
            uf_agent=request.form.get('uf'),
            contractuel=(request.form.get('contractuel') == 'oui'),
            condition_recrutement=request.form.get('condition'),
            temps_travail=request.form.get('temps_travail'),
            pourcentage_temps=request.form.get('pourcentage'),
            motif_recrutement=request.form.get('motif'),
            simulation_salaire=(request.form.get('simulation') == 'oui'),
            localisation_poste=request.form.get('localisation'),
            commentaire_securite=request.form.get('commentaire_secu'),
            imago_active=(request.form.get('imago') == 'oui'),
            imago_mobilite=request.form.get('imago_mobilite'),
            materiels_demandes=",".join(request.form.getlist('materiel_type')),
            acces_informatique=request.form.get('acces_info'),
            file_cv=save_file('cv_file'),
            file_fiche_poste=save_file('fiche_poste_file'),
            file_photo=save_file('photo_file')
        )
        
        if request.form.get('date_debut_contrat'):
            try: rec.date_debut_contrat = datetime.strptime(request.form.get('date_debut_contrat'), '%Y-%m-%d')
            except: pass
        if request.form.get('date_fin_contrat'):
            try: rec.date_fin_contrat = datetime.strptime(request.form.get('date_fin_contrat'), '%Y-%m-%d')
            except: pass

        db.session.add(rec)
        db.session.commit()
        
        candidates = User.query.filter((User.role == UserRole.MANAGER) | (User.role == UserRole.ADMIN)).all()
        rh_users = [u for u in candidates if 'DRH' in u.get_allowed_services() or 'RH' in u.get_allowed_services()]

        for u in rh_users:
            if 'MANAGER' in str(u.role.value).upper() or 'ADMIN' in str(u.role.value).upper():
                n = Notification(user=u, message=f"Nouveau FCPI à valider : {uid}", link=url_for('fcpi.view_fcpi', id=rec.id))
                db.session.add(n)
        db.session.commit()

        flash("Demande FCPI créée. En attente de validation RH Manager.", "success")
        return redirect(url_for('main.user_portal'))

    return render_template('fcpi/new_fcpi.html')

@fcpi_bp.route('/fcpi/view/<int:id>', methods=['GET'])
@login_required
def view_fcpi(id):
    rec = Recruitment.query.get_or_404(id)
    user_svcs = current_user.get_allowed_services()
    is_rh = 'DRH' in user_svcs or 'RH' in user_svcs
    is_admin = 'ADMIN' in str(current_user.role.value).upper()
    
    if rec.author_id != current_user.id and not is_rh and not is_admin:
        flash("Accès non autorisé.", "danger")
        return redirect(url_for('main.user_portal'))
        
    return render_template('fcpi/view_fcpi.html', rec=rec)

@fcpi_bp.route('/fcpi/validate/<int:id>/<action>', methods=['POST'])
@login_required
def validate_fcpi(id, action):
    try:
        rec = Recruitment.query.get_or_404(id)
        comment = request.form.get('refusal_comment', '')
        
        user_services = current_user.get_allowed_services()
        is_rh = 'DRH' in user_services or 'RH' in user_services
        is_admin = 'ADMIN' in str(current_user.role.value).upper()
        role = str(current_user.role.value).upper()
        
        if not (is_rh or is_admin):
            flash("Action réservée au service RH.", "danger")
            return redirect(url_for('main.user_portal'))

        # LOGIQUE REFUS
        if action == 'refuse':
            rec.status = RecruitmentStatus.REFUSED
            rec.refusal_reason = f"Refusé par {current_user.fullname} : {comment}"
            n = Notification(user=rec.author, message=f"Votre FCPI {rec.uid_public} a été refusée.", category='danger', link=url_for('fcpi.view_fcpi', id=rec.id))
            db.session.add(n)
            db.session.commit()
            flash("Demande refusée et renvoyée au demandeur.", "warning")
            return redirect(url_for('main.user_portal'))

        # LOGIQUE VALIDATION
        if rec.status == RecruitmentStatus.WAITING_RH_MGR:
            if 'MANAGER' in role or 'ADMIN' in role:
                rec.status = RecruitmentStatus.WAITING_RH_DIR
                flash("Validé par Manager RH. En attente Directeur RH.", "success")
                
                dir_rh = User.query.filter((User.role == UserRole.DIRECTEUR) | (User.role == UserRole.ADMIN)).all()
                for u in dir_rh:
                     if 'DRH' in u.get_allowed_services() or 'RH' in u.get_allowed_services() or 'ADMIN' in str(u.role.value):
                         n = Notification(user=u, message=f"FCPI {rec.uid_public} (Validé N1) en attente signature.", link=url_for('fcpi.view_fcpi', id=rec.id))
                         db.session.add(n)
            else:
                 flash("Droit Manager RH requis.", "danger")

        elif rec.status == RecruitmentStatus.WAITING_RH_DIR:
            if 'DIRECTEUR' in role or 'ADMIN' in role:
                # VALIDATION FINALE -> DISPATCH
                rec.status = RecruitmentStatus.DISPATCHED
                child_ids = []
                
                def file_link(filename):
                    if not filename: return "Aucun"
                    return f"/static/uploads/fcpi/{rec.uid_public}/{filename}"

                # 1. DRH
                desc_drh = (
                    f"--- NOUVEAU RECRUTEMENT ---\n"
                    f"Agent: {rec.nom_agent} {rec.prenom_agent}\n"
                    f"Date entrée: {rec.date_entree.strftime('%d/%m/%Y')}\n"
                    f"Contrat: {'Contractuel' if rec.contractuel else 'Titulaire'}\n"
                    f"Du {rec.date_debut_contrat.strftime('%d/%m/%Y') if rec.date_debut_contrat else '?'} au {rec.date_fin_contrat.strftime('%d/%m/%Y') if rec.date_fin_contrat else '?'}\n"
                    f"Salaire simu: {'OUI' if rec.simulation_salaire else 'NON'}\n\n"
                    f"--- PIÈCES JOINTES (Copier le lien) ---\n"
                    f"CV: {request.host_url}{file_link(rec.file_cv)}\n"
                    f"Fiche Poste: {request.host_url}{file_link(rec.file_fiche_poste)}"
                )
                child_ids.append(create_sub_ticket(rec, ServiceType.DRH, "Dossier Administratif", desc_drh))
                
                # 2. SÉCURITÉ
                desc_secu = (
                    f"Agent: {rec.nom_agent} {rec.prenom_agent}\n"
                    f"Service: {rec.service_agent}\n"
                    f"Date entrée: {rec.date_entree.strftime('%d/%m/%Y')}\n"
                    f"Localisation: {rec.localisation_poste}\n"
                    f"Besoins Badge/Clés: {rec.commentaire_securite}\n\n"
                    f"PHOTO AGENT (Copier le lien): {request.host_url}{file_link(rec.file_photo)}"
                )
                child_ids.append(create_sub_ticket(rec, ServiceType.SECU, "Badge & Accès", desc_secu))
                
                # 3. INFORMATIQUE
                desc_info = (
                    f"Agent: {rec.nom_agent} {rec.prenom_agent}\n"
                    f"Service: {rec.service_agent}\n"
                    f"Date entrée: {rec.date_entree.strftime('%d/%m/%Y')}\n"
                    f"Matériel demandé: {rec.materiels_demandes}\n"
                    f"Accès logiciels/réseaux: {rec.acces_informatique}\n"
                )
                child_ids.append(create_sub_ticket(rec, ServiceType.INFO, "Matériel & Accès", desc_info))
                
                # 4. IMAGO (Sécurisé avec ServiceType.INFO + Suffixe IMA)
                if rec.imago_active:
                    desc_imago = (
                        f"Création compte Imago pour {rec.nom_agent} {rec.prenom_agent}.\n"
                        f"Mobilité (Sites): {rec.imago_mobilite}"
                    )
                    # ON UTILISE INFO PAR SÉCURITÉ POUR ÉVITER L'ERREUR DE TYPE ENUM
                    child_ids.append(create_sub_ticket(rec, ServiceType.INFO, "Compte Imago", desc_imago, custom_suffix="IMA"))
                
                rec.child_tickets_ids = json.dumps(child_ids)
                
                n = Notification(user=rec.author, message=f"FCPI {rec.uid_public} validée ! Les services sont informés.", category='success', link=url_for('fcpi.view_fcpi', id=rec.id))
                db.session.add(n)
                
                flash("FCPI Validée ! Les tickets ont été envoyés aux services.", "success")
                
            else:
                flash("Droit Directeur RH requis.", "danger")

        # COMMIT FINAL UNIQUE
        db.session.commit()
        return redirect(url_for('main.user_portal'))

    except Exception as e:
        db.session.rollback() # Annule tout si une erreur survient
        current_app.logger.error(f"Erreur validation FCPI: {e}")
        flash(f"Erreur serveur lors de la validation : {e}", "danger")
        return redirect(url_for('fcpi.view_fcpi', id=id))



================================================
FILE: app/routes/inventaire.py
================================================
from flask import Blueprint, render_template, redirect, url_for, flash, request, send_file, current_app
from flask_login import login_required, current_user
from app.models import Materiel, Pret, UserRole, ServiceType
from app import db
import pandas as pd
import os
from datetime import datetime
from sqlalchemy.exc import IntegrityError

inventaire_bp = Blueprint('inventaire', __name__)

@inventaire_bp.route('/inventaire', methods=['GET', 'POST'])
@login_required
def liste():
    # SÉCURITÉ : Admin ou (Tech/Manager/Directeur) du service INFO
    user_role = str(current_user.role.value).upper() if hasattr(current_user.role, 'value') else str(current_user.role).upper()
    user_services = current_user.get_allowed_services()
    
    is_admin = 'ADMIN' in user_role
    
    # CORRECTION : On autorise SOLVER, MANAGER et DIRECTEUR s'ils sont du service INFO
    is_allowed_role = 'SOLVER' in user_role or 'MANAGER' in user_role or 'DIRECTEUR' in user_role
    is_tech_info = is_allowed_role and ('INFORMATIQUE' in user_services or 'INFO' in user_services)
    
    if not (is_admin or is_tech_info):
        flash("Accès réservé au service Informatique.", "danger")
        return redirect(url_for('main.user_portal'))

    materiels = Materiel.query.all()
    return render_template('inventaire.html', materiels=materiels)

@inventaire_bp.route('/inventaire/add', methods=['POST'])
@login_required
def ajouter():
    # Vérification droits pour l'ajout
    user_role = str(current_user.role.value).upper() if hasattr(current_user.role, 'value') else str(current_user.role).upper()
    user_services = current_user.get_allowed_services()

    is_admin = 'ADMIN' in user_role
    is_allowed_role = 'SOLVER' in user_role or 'MANAGER' in user_role or 'DIRECTEUR' in user_role
    is_tech_info = is_allowed_role and ('INFORMATIQUE' in user_services or 'INFO' in user_services)

    if not (is_admin or is_tech_info):
        return redirect(url_for('main.user_portal'))

    categorie = request.form.get('categorie')
    modele = request.form.get('modele')
    sn = request.form.get('sn')
    hostname = request.form.get('hostname')
    imei = request.form.get('imei')

    if Materiel.query.filter_by(sn=sn).first():
        flash(f'Erreur : Le numéro de série {sn} existe déjà.', 'danger')
    else:
        new_mat = Materiel(categorie=categorie, modele=modele, sn=sn, hostname=hostname, imei=imei)
        db.session.add(new_mat)
        db.session.commit()
        flash('Matériel ajouté.', 'success')

    return redirect(url_for('inventaire.liste'))

@inventaire_bp.route('/inventaire/edit/<int:id>', methods=['POST'])
@login_required
def modifier(id):
    mat = Materiel.query.get_or_404(id)
    mat.categorie = request.form.get('categorie')
    mat.modele = request.form.get('modele')
    mat.sn = request.form.get('sn')
    mat.hostname = request.form.get('hostname')
    mat.imei = request.form.get('imei')
    db.session.commit()
    flash('Matériel modifié.', 'success')
    return redirect(url_for('inventaire.liste'))

@inventaire_bp.route('/inventaire/delete/<int:id>')
@login_required
def supprimer(id):
    mat = Materiel.query.get_or_404(id)
    db.session.delete(mat)
    db.session.commit()
    flash('Matériel supprimé.', 'success')
    return redirect(url_for('inventaire.liste'))

@inventaire_bp.route('/export/stock')
@login_required
def export_stock():
    materiels = Materiel.query.all()
    data = []
    for m in materiels:
        data.append({
            'Categorie': m.categorie,
            'Modele': m.modele,
            'SN': m.sn,
            'Hostname': m.hostname,
            'IMEI': m.imei,
            'Statut': m.statut
        })
    
    df = pd.DataFrame(data)
    export_dir = os.path.join(current_app.root_path, 'static', 'uploads')
    os.makedirs(export_dir, exist_ok=True)
    filename = f'Export_Stock_{datetime.now().strftime("%Y%m%d_%H%M")}.xlsx'
    path = os.path.join(export_dir, filename)
    
    df.to_excel(path, index=False)
    return send_file(path, as_attachment=True)

@inventaire_bp.route('/import/stock', methods=['POST'])
@login_required
def import_stock():
    if 'file' not in request.files: return redirect(url_for('inventaire.liste'))
    file = request.files['file']
    if file.filename == '': return redirect(url_for('inventaire.liste'))
        
    try:
        df = pd.read_excel(file)
        if 'SN' not in df.columns:
            flash('Erreur format : Colonne "SN" manquante.', 'danger')
            return redirect(url_for('inventaire.liste'))
            
        count = 0
        for _, row in df.iterrows():
            sn_val = str(row['SN']).strip()
            if not Materiel.query.filter_by(sn=sn_val).first():
                db.session.add(Materiel(
                    categorie=row.get('Categorie','Autre'), 
                    modele=row.get('Modele','Inconnu'), 
                    sn=sn_val, 
                    hostname=row.get('Hostname',''), 
                    imei=str(row.get('IMEI','')), 
                    statut='Disponible'
                ))
                count += 1
        db.session.commit()
        flash(f'Import terminé : {count} matériels ajoutés.', 'success')
    except Exception as e:
        flash(f'Erreur import : {e}', 'danger')
        
    return redirect(url_for('inventaire.liste'))



================================================
FILE: app/routes/main.py
================================================
from flask import Blueprint, render_template, redirect, url_for, flash
from flask_login import login_required, current_user
from app.models import UserRole, Ticket

main_bp = Blueprint('main', __name__)

@main_bp.route('/')
def index():
    if not current_user.is_authenticated:
        return redirect(url_for('auth.login'))
    return redirect(url_for('main.user_portal'))

@main_bp.route('/portal')
@login_required
def user_portal():
    # Récupérer les 15 derniers tickets de l'utilisateur connecté
    recent_tickets = Ticket.query.filter_by(author_id=current_user.id)\
                                 .order_by(Ticket.created_at.desc())\
                                 .limit(15).all()
    
    return render_template('portal.html', user=current_user, tickets=recent_tickets)

@main_bp.route('/my_history')
@login_required
def my_history():
    # Historique complet
    tickets = Ticket.query.filter_by(author_id=current_user.id).order_by(Ticket.created_at.desc()).all()
    return render_template('my_history.html', tickets=tickets)

@main_bp.route('/admin/dashboard')
@login_required
def admin_dashboard():
    # Sécurité : Admin Only
    if 'ADMIN' not in str(current_user.role.value).upper():
        return redirect(url_for('main.user_portal'))
    return redirect(url_for('users.list_users'))

@main_bp.route('/dashboard')
@login_required
def dashboard():
    # Redirection intelligente selon le rôle
    role = str(current_user.role.value).upper() if hasattr(current_user.role, 'value') else str(current_user.role).upper()
    
    if 'ADMIN' in role:
        return redirect(url_for('tickets.solver_dashboard'))
    elif 'MANAGER' in role or 'DIRECTEUR' in role:
        return redirect(url_for('tickets.manager_dashboard'))
    elif 'SOLVER' in role:
        return redirect(url_for('tickets.solver_dashboard'))
    
    return redirect(url_for('main.user_portal'))




================================================
FILE: app/routes/prets.py
================================================
from flask import Blueprint, render_template, redirect, url_for, flash, request, send_file, current_app
from flask_login import login_required, current_user
from app.models import Materiel, Pret
from app import db
import pandas as pd
import os
from datetime import datetime

prets_bp = Blueprint('prets', __name__)

@prets_bp.route('/prets', methods=['GET', 'POST'])
@login_required
def liste_prets():
    if request.method == 'POST':
        if 'action_pret' in request.form:
            materiel_id = request.form.get('materiel_id')
            mat = Materiel.query.get(materiel_id)
            
            if mat and mat.statut == 'Disponible':
                try:
                    d_out = datetime.strptime(request.form.get('custom_date_sortie'), '%Y-%m-%dT%H:%M') if request.form.get('custom_date_sortie') else datetime.now()
                except:
                    d_out = datetime.now()
                
                pret = Pret(
                    materiel_id=mat.id,
                    technicien_id=current_user.id,
                    nom_emprunteur=request.form.get('nom'),
                    prenom_emprunteur=request.form.get('prenom'),
                    service_emprunteur=request.form.get('service'),
                    type_pret=request.form.get('type_pret'),
                    accessoires=", ".join(request.form.getlist('accessoires')),
                    date_sortie=d_out,
                    etat_ecran_sortie=request.form.get('etat_ecran'),
                    etat_clavier_sortie=request.form.get('etat_clavier'),
                    etat_coque_sortie=request.form.get('etat_coque'),
                    statut_dossier='En cours'
                )
                mat.statut = 'En pret'
                db.session.add(pret)
                db.session.commit()
                flash('Prêt enregistré avec succès.', 'success')
            else:
                flash('Erreur: Matériel non disponible.', 'danger')

    materiels_dispo = Materiel.query.filter_by(statut='Disponible').all()
    liste_prets = Pret.query.order_by(Pret.date_sortie.desc()).all()
    return render_template('prets.html', materiels=materiels_dispo, prets=liste_prets)

@prets_bp.route('/pret/<int:id>/retour', methods=['POST'])
@login_required
def valider_retour(id):
    pret = Pret.query.get_or_404(id)
    if pret.statut_dossier == 'En cours':
        try:
            d_ret = datetime.strptime(request.form.get('custom_date_retour'), '%Y-%m-%dT%H:%M') if request.form.get('custom_date_retour') else datetime.now()
        except:
            d_ret = datetime.now()
            
        pret.date_retour_reelle = d_ret
        pret.etat_ecran_retour = request.form.get('etat_ecran_retour')
        pret.etat_clavier_retour = request.form.get('etat_clavier_retour')
        pret.etat_coque_retour = request.form.get('etat_coque_retour')
        pret.statut_dossier = 'Terminé'
        
        if pret.materiel:
            pret.materiel.statut = 'Disponible'
            
        db.session.commit()
        flash('Retour matériel validé.', 'success')
        
    return redirect(url_for('prets.liste_prets'))

@prets_bp.route('/pret/<int:id>/delete')
@login_required
def delete_pret(id):
    pret = Pret.query.get_or_404(id)
    if pret.materiel and pret.statut_dossier == 'En cours':
        pret.materiel.statut = 'Disponible'
    db.session.delete(pret)
    db.session.commit()
    flash('Dossier de prêt supprimé.', 'success')
    return redirect(url_for('prets.liste_prets'))

# --- EXPORT / IMPORT PRÊTS ---

@prets_bp.route('/export/prets')
@login_required
def export_prets():
    prets = Pret.query.all()
    data = []
    for p in prets:
        data.append({
            'ID_Pret': p.id,
            'Materiel_SN': p.materiel.sn if p.materiel else 'Inconnu',
            'Materiel_Modele': p.materiel.modele if p.materiel else 'Inconnu',
            'Emprunteur': f"{p.nom_emprunteur} {p.prenom_emprunteur}",
            'Service': p.service_emprunteur,
            'Date_Sortie': p.date_sortie.strftime('%Y-%m-%d %H:%M') if p.date_sortie else '',
            'Date_Retour': p.date_retour_reelle.strftime('%Y-%m-%d %H:%M') if p.date_retour_reelle else '',
            'Statut': p.statut_dossier
        })
    
    df = pd.DataFrame(data)
    export_dir = os.path.join(current_app.root_path, 'static', 'uploads')
    os.makedirs(export_dir, exist_ok=True)
    filename = f'Export_Prets_{datetime.now().strftime("%Y%m%d_%H%M")}.xlsx'
    path = os.path.join(export_dir, filename)
    
    df.to_excel(path, index=False)
    return send_file(path, as_attachment=True)

@prets_bp.route('/import/prets', methods=['POST'])
@login_required
def import_prets():
    if 'file' not in request.files: return redirect(url_for('prets.liste_prets'))
    file = request.files['file']
    if file.filename == '': return redirect(url_for('prets.liste_prets'))
    
    try:
        df = pd.read_excel(file)
        count = 0
        # Colonnes attendues : SN, Nom, Prenom, Service, Date_Sortie (YYYY-MM-DD)
        for _, row in df.iterrows():
            sn = str(row.get('SN', '')).strip()
            mat = Materiel.query.filter_by(sn=sn).first()
            
            if mat and mat.statut == 'Disponible':
                try:
                    d_out = pd.to_datetime(row.get('Date_Sortie', datetime.now()))
                except:
                    d_out = datetime.now()

                pret = Pret(
                    materiel_id=mat.id,
                    technicien_id=current_user.id,
                    nom_emprunteur=row.get('Nom', 'Import'),
                    prenom_emprunteur=row.get('Prenom', 'Import'),
                    service_emprunteur=row.get('Service', 'Import'),
                    statut_dossier='En cours',
                    date_sortie=d_out
                )
                mat.statut = 'En pret'
                db.session.add(pret)
                count += 1
                
        db.session.commit()
        flash(f'Import terminé : {count} prêts créés.', 'success')
    except Exception as e:
        flash(f'Erreur import : {e}', 'danger')
        
    return redirect(url_for('prets.liste_prets'))



================================================
FILE: app/routes/tickets.py
================================================
from flask import Blueprint, render_template, redirect, url_for, flash, request, current_app, make_response, send_file
from flask_login import login_required, current_user
from app.models import Ticket, ServiceType, TicketStatus, UserRole, TicketMessage, Materiel, Pret, Notification, User, Recruitment, RecruitmentStatus
from app import db
from datetime import datetime
import json
import os
import socket
import pandas as pd
from werkzeug.utils import secure_filename
from sqlalchemy.exc import IntegrityError
from functools import wraps
from app.emails import send_email 

tickets_bp = Blueprint('tickets', __name__)

# --- UTILITAIRES ---
def nocache(view):
    """Décorateur pour empêcher la mise en cache navigateur."""
    @wraps(view)
    def no_cache(*args, **kwargs):
        response = make_response(view(*args, **kwargs))
        response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate, private, max-age=0'
        return response
    return no_cache

def create_notification(user, message, category='info', link=None):
    if user:
        n = Notification(user=user, message=message, category=category, link=link)
        db.session.add(n)

def get_hostname_from_ip(ip_address):
    try: return socket.gethostbyaddr(ip_address)[0]
    except: return ip_address

def check_permission(required_roles):
    try:
        current_role = str(current_user.role.value).upper() if hasattr(current_user.role, 'value') else str(current_user.role).upper()
        if 'ADMIN' in current_role: return True
        for req in required_roles:
            if req in current_role: return True
    except Exception as e:
        return False
    return False

# --- ROUTES ---

@tickets_bp.route('/new/<service_name>', methods=['GET', 'POST'])
@login_required
@nocache
def new_ticket(service_name):
    # ... (Code existant inchangé jusqu'au return du POST) ...
    # Je copie le code existant et j'indique où il se termine pour être concis
    # LE CODE EXISTANT DE new_ticket RESTE IDENTIQUE A CELUI QUE TU AS DÉJA
    try:
        service_enum = ServiceType[service_name.upper()]
    except KeyError:
        return redirect(url_for('main.user_portal'))

    user_origins = current_user.get_origin_services()

    if request.method == 'POST':
        category = request.form.get('category_ticket', 'Standard')

        if service_name == 'DAF' and category == 'Standard':
            category = 'Bon de Commande'

        selected_origin = request.form.get('selected_origin')
        if not selected_origin:
            selected_origin = user_origins[0] if user_origins else "INCONNU"
            
        hostname_saisi = request.form.get('hostname')
        final_hostname = hostname_saisi if hostname_saisi else get_hostname_from_ip(request.remote_addr)

        title = request.form.get('title')
        description = request.form.get('description')
        
        if service_name == 'DAF' and category == 'Bon de Commande':
             fournisseur = request.form.get('daf_fournisseur_nom', 'Inconnu')
             title = f"Bon de Commande - {fournisseur}"
             description = request.form.get('description_daf', '')

        role = current_user.role
        if service_enum == ServiceType.INFO and category == "Incident Standard":
            status = TicketStatus.PENDING
        else:
            if role == UserRole.USER: status = TicketStatus.VALIDATION_N1
            elif role == UserRole.MANAGER: status = TicketStatus.VALIDATION_N1
            elif role == UserRole.DIRECTEUR: status = TicketStatus.VALIDATION_N2
            elif role == UserRole.ADMIN: status = TicketStatus.PENDING
            else: status = TicketStatus.VALIDATION_N1

        today_str = datetime.now().strftime('%Y%m%d')
        base_query = Ticket.query.filter(Ticket.uid_public.like(f"{today_str}%"))
        count = base_query.count()
        
        saved = False
        attempts = 0
        while not saved and attempts < 5:
            attempts += 1
            count += 1
            uid = f"{today_str}-{str(count).zfill(3)}"
            
            daf_lignes = []
            if service_name == 'DAF':
                for i in range(1, 51):
                    des = request.form.get(f'daf_designation_{i}')
                    if des: daf_lignes.append({'designation': des, 'ref': request.form.get(f'daf_ref_{i}'), 'qte': request.form.get(f'daf_qte_{i}'), 'pu': request.form.get(f'daf_pu_{i}'), 'total': request.form.get(f'daf_total_{i}')})
            
            daf_files = []
            daf_rib_filename = None
            
            if request.files and service_name == 'DAF':
                upload_path = os.path.join(current_app.root_path, 'static', 'uploads', 'tickets', uid)
                os.makedirs(upload_path, exist_ok=True)
                
                for i in range(1, 5):
                    file = request.files.get(f'devis_{i}')
                    if file and file.filename != '':
                        filename = secure_filename(file.filename)
                        file.save(os.path.join(upload_path, filename))
                        daf_files.append(filename)
                
                file_rib = request.files.get('daf_rib')
                if file_rib and file_rib.filename != '':
                    daf_rib_filename = secure_filename(f"RIB_{file_rib.filename}")
                    file_rib.save(os.path.join(upload_path, daf_rib_filename))

            supplier_status = request.form.get('supplier_status')
            is_new_supplier = True if supplier_status == 'new' else False

            t = Ticket(
                title=title,
                description=description,
                author=current_user,
                target_service=service_enum,
                status=status,
                uid_public=uid,
                category_ticket=category,
                service_demandeur=selected_origin,
                tel_demandeur=request.form.get('tel_demandeur'),
                hostname=final_hostname,
                lieu_installation=request.form.get('lieu_installation_user') or request.form.get('lieu_installation_mat'),
                new_user_fullname=f"{request.form.get('new_user_nom')} {request.form.get('new_user_prenom')}",
                new_user_service=request.form.get('new_user_service'),
                new_user_acces=request.form.get('new_user_acces'),
                materiel_list=request.form.get('materiel_list'),
                destinataire_materiel=request.form.get('destinataire_materiel'),
                service_destinataire=request.form.get('service_destinataire'),
                daf_lieu_livraison=request.form.get('daf_lieu_livraison'),
                daf_fournisseur_nom=request.form.get('daf_fournisseur_nom'),
                daf_fournisseur_email=request.form.get('daf_fournisseur_email'),
                daf_type_prix=request.form.get('daf_type_prix'),
                daf_uf=request.form.get('daf_uf'),
                daf_budget_affecte=request.form.get('daf_budget'),
                daf_new_supplier=is_new_supplier,
                daf_siret=request.form.get('daf_siret'),
                daf_fournisseur_tel_comment=request.form.get('daf_fournisseur_tel'),
                daf_rib_file=daf_rib_filename,
                daf_lignes_json=json.dumps(daf_lignes),
                daf_files_json=json.dumps(daf_files)
            )
            
            if request.form.get('new_user_date'):
                try: t.new_user_date = datetime.strptime(request.form.get('new_user_date'), '%Y-%m-%d')
                except: pass
from flask import Blueprint, render_template, redirect, url_for, flash, request, current_app, make_response, send_file
from flask_login import login_required, current_user
from app.models import Ticket, ServiceType, TicketStatus, UserRole, TicketMessage, Materiel, Pret, Notification, User, Recruitment, RecruitmentStatus
from app import db
from datetime import datetime
import json
import os
import socket
import pandas as pd
from werkzeug.utils import secure_filename
from sqlalchemy.exc import IntegrityError
from functools import wraps

tickets_bp = Blueprint('tickets', __name__)

# --- HELPERS ---

def nocache(view):
    @wraps(view)
    def no_cache(*args, **kwargs):
        response = make_response(view(*args, **kwargs))
        response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate, private, max-age=0'
        return response
    return no_cache

def create_notification(user, message, category='info', link=None):
    if user:
        try:
            n = Notification(user=user, message=message, category=category, link=link)
            db.session.add(n)
        except: pass

def get_hostname_from_ip(ip_address):
    try: return socket.gethostbyaddr(ip_address)[0]
    except: return ip_address

def safe_role_str(user):
    if not user or not user.role: return ""
    if hasattr(user.role, 'value'): return str(user.role.value).upper()
    return str(user.role).upper()

def check_permission(required_roles):
    try:
        current_role = safe_role_str(current_user)
        if 'ADMIN' in current_role: return True
        for req in required_roles:
            if req in current_role: return True
    except: return False
    return False

# --- ROUTES ---

@tickets_bp.route('/new/<service_name>', methods=['GET', 'POST'])
@login_required
@nocache
def new_ticket(service_name):
    try:
        service_enum = ServiceType[service_name.upper()]
    except KeyError:
        return redirect(url_for('main.user_portal'))

    user_origins = current_user.get_origin_services()

    if request.method == 'POST':
        category = request.form.get('category_ticket', 'Standard')
        selected_origin = request.form.get('selected_origin')
        if not selected_origin:
            selected_origin = user_origins[0] if user_origins else "INCONNU"
            
        hostname_saisi = request.form.get('hostname')
        final_hostname = hostname_saisi if hostname_saisi else get_hostname_from_ip(request.remote_addr)

        title = request.form.get('title')
        description = request.form.get('description')
        
        if service_name == 'DAF' and category == 'Bon de Commande':
             fournisseur = request.form.get('daf_fournisseur_nom', 'Inconnu')
             title = f"Bon de Commande - {fournisseur}"
             description = request.form.get('description_daf', '')

        role = current_user.role
        
        # --- LOGIQUE DE WORKFLOW (MODIFIÉE) ---
        
        # 1. Workflow Simplifié INFORMATIQUE (Incident / Standard)
        # On saute les validations N1/N2, direct au pool technique.
        if service_enum == ServiceType.INFO and category in ["Standard", "Incident Standard"]:
            status = TicketStatus.PENDING
            
        # 2. Workflow Standard (DAF, Services Généraux, etc.)
        else:
            if role == UserRole.USER: status = TicketStatus.VALIDATION_N1
            elif role == UserRole.MANAGER: status = TicketStatus.VALIDATION_N1
            elif role == UserRole.DIRECTEUR: status = TicketStatus.VALIDATION_N2
            elif role == UserRole.ADMIN: status = TicketStatus.PENDING
            else: status = TicketStatus.VALIDATION_N1

        # Génération UID
        today_str = datetime.now().strftime('%Y%m%d')
        base_query = Ticket.query.filter(Ticket.uid_public.like(f"{today_str}%"))
        count = base_query.count() + 1
        uid = f"{today_str}-{str(count).zfill(3)}"
            
        daf_lignes = []
        if service_name == 'DAF':
            for i in range(1, 51):
                des = request.form.get(f'daf_designation_{i}')
                if des: daf_lignes.append({
                    'designation': des, 
                    'ref': request.form.get(f'daf_ref_{i}'), 
                    'qte': request.form.get(f'daf_qte_{i}'), 
                    'pu': request.form.get(f'daf_pu_{i}'), 
                    'total': request.form.get(f'daf_total_{i}')
                })
        
        daf_files = []
        daf_rib_filename = None
        
        if request.files and service_name == 'DAF':
            upload_path = os.path.join(current_app.root_path, 'static', 'uploads', 'tickets', uid)
            os.makedirs(upload_path, exist_ok=True)
            
            for i in range(1, 5):
                file = request.files.get(f'devis_{i}')
                if file and file.filename != '':
                    try:
                        filename = secure_filename(file.filename)
                        file.save(os.path.join(upload_path, filename))
                        daf_files.append(filename)
                    except: pass
            
            file_rib = request.files.get('daf_rib')
            if file_rib and file_rib.filename != '':
                try:
                    daf_rib_filename = secure_filename(f"RIB_{file_rib.filename}")
                    file_rib.save(os.path.join(upload_path, daf_rib_filename))
                except: pass

        supplier_status = request.form.get('supplier_status')
        is_new_supplier = True if supplier_status == 'new' else False

        t = Ticket(
            title=title,
            description=description,
            author=current_user,
            target_service=service_enum,
            status=status,
            uid_public=uid,
            category_ticket=category,
            service_demandeur=selected_origin,
            tel_demandeur=request.form.get('tel_demandeur'),
            hostname=final_hostname,
            lieu_installation=request.form.get('lieu_installation_user') or request.form.get('lieu_installation_mat'),
            daf_lieu_livraison=request.form.get('daf_lieu_livraison'),
            daf_fournisseur_nom=request.form.get('daf_fournisseur_nom'),
            daf_fournisseur_email=request.form.get('daf_fournisseur_email'),
            daf_type_prix=request.form.get('daf_type_prix'),
            daf_uf=request.form.get('daf_uf'),
            daf_budget_affecte=request.form.get('daf_budget'),
            daf_new_supplier=is_new_supplier,
            daf_siret=request.form.get('daf_siret'),
            daf_fournisseur_tel_comment=request.form.get('daf_fournisseur_tel'),
            daf_rib_file=daf_rib_filename,
            daf_lignes_json=json.dumps(daf_lignes),
            daf_files_json=json.dumps(daf_files)
        )
        
        if request.form.get('new_user_date'):
            try: t.new_user_date = datetime.strptime(request.form.get('new_user_date'), '%Y-%m-%d')
            except: pass

        try:
            db.session.add(t)
            db.session.commit()
        except Exception as e:
            db.session.rollback()
            flash(f"Erreur DB: {e}", "danger")
            return redirect(url_for('main.user_portal'))

        # NOTIFICATIONS AUTOMATIQUES SELON STATUT
        if status == TicketStatus.VALIDATION_N1:
            managers = User.query.filter(User.role.in_([UserRole.MANAGER, UserRole.DIRECTEUR])).all()
            for mgr in managers:
                if selected_origin in mgr.get_origin_services():
                    create_notification(mgr, f"Validation requise : {uid}", 'warning', url_for('tickets.manager_dashboard'))
                    
        elif status == TicketStatus.PENDING:
            # Pour l'INFO simplifiée, on notifie directement les techs
            solvers = User.query.filter(User.role.in_([UserRole.SOLVER, UserRole.ADMIN])).all()
            for s in solvers:
                 if s.role == UserRole.ADMIN or service_name in s.get_allowed_services():
                    create_notification(s, f"Nouveau ticket : {uid}", 'info', url_for('tickets.solver_dashboard'))

        flash(f'Demande {uid} enregistrée.', 'success')
        return redirect(url_for('main.user_portal'))

    return render_template('tickets/new_ticket.html', service=service_enum, service_name=service_name, user_origins=user_origins)

@tickets_bp.route('/view/<string:ticket_uid>', methods=['GET', 'POST'])
@login_required
@nocache
def view_ticket(ticket_uid):
    try:
        ticket = Ticket.query.filter_by(uid_public=ticket_uid).first_or_404()
        user_role = safe_role_str(current_user)
        target_svc = ticket.get_safe_target_service()
        
        can_view = False
        if 'ADMIN' in user_role: can_view = True
        elif ticket.author_id == current_user.id: can_view = True
        elif 'SOLVER' in user_role and target_svc in current_user.get_allowed_services(): can_view = True
        elif 'MANAGER' in user_role or 'DIRECTEUR' in user_role:
            if ticket.service_demandeur in current_user.get_origin_services(): can_view = True
            if target_svc in current_user.get_allowed_services(): can_view = True
        
        if not can_view:
            flash("Accès non autorisé à ce ticket.", "warning")
            return redirect(url_for('main.user_portal'))

        if request.method == 'POST' and request.form.get('message'):
            msg = TicketMessage(content=request.form.get('message'), ticket=ticket, author=current_user)
            db.session.add(msg)
            db.session.commit()
            return redirect(url_for('tickets.view_ticket', ticket_uid=ticket_uid))
            
        return render_template('tickets/detail.html', ticket=ticket)

    except Exception as e:
        print(f"ERREUR VIEW TICKET: {e}")
        flash(f"Erreur d'affichage : {str(e)}", "danger")
        return redirect(url_for('main.user_portal'))

@tickets_bp.route('/manager/dashboard')
@login_required
@nocache
def manager_dashboard():
    try:
        # Vérif Droits
        role_str = safe_role_str(current_user)
        if not ('MANAGER' in role_str or 'DIRECTEUR' in role_str or 'ADMIN' in role_str):
            if 'SOLVER' in role_str: return redirect(url_for('tickets.solver_dashboard'))
            return render_template('errors/catdance.html'), 403
        
        my_origins = current_user.get_origin_services() 
        my_targets = current_user.get_allowed_services()
        
        # 1. Tickets Classiques N1
        tickets_n1 = []
        if my_origins: 
            tickets_n1 = Ticket.query.filter(
                Ticket.status == TicketStatus.VALIDATION_N1,
                Ticket.service_demandeur.in_(my_origins),
                Ticket.author_id != current_user.id
            ).all()

        # 2. Tickets Classiques N2
        tickets_n2 = []
        if my_targets:
            try:
                base_query = Ticket.query.filter(Ticket.target_service.in_(my_targets))
                if 'DAF' in my_targets:
                    if 'DIRECTEUR' in role_str:
                        candidates = base_query.filter(Ticket.status.in_([TicketStatus.VALIDATION_N2, TicketStatus.DAF_SIGNATURE])).all()
                    else:
                        candidates = base_query.filter(Ticket.status == TicketStatus.VALIDATION_N2).all()
                else:
                    candidates = base_query.filter(Ticket.status == TicketStatus.VALIDATION_N2).all()
                tickets_n2 = candidates
            except Exception:
                tickets_n2 = []

        # --- 3. PARTIE FCPI (RECRUTEMENTS) ---
        # C'est ici qu'on récupère les demandes pour l'onglet RH
        fcpi_requests = []
        role = str(current_user.role.value).upper()
        user_services = current_user.get_allowed_services()
        
        # Vérifie si l'utilisateur fait partie des RH (ou est Admin)
        is_rh_team = 'DRH' in user_services or 'RH' in user_services or 'ADMIN' in role

        if is_rh_team:
            # Si Manager RH -> Voit les "Waiting RH Mgr"
            if 'MANAGER' in role or 'ADMIN' in role:
                mgr_fcpi = Recruitment.query.filter_by(status=RecruitmentStatus.WAITING_RH_MGR).all()
                fcpi_requests.extend(mgr_fcpi)
            
            # Si Directeur RH -> Voit les "Waiting RH Dir"
            if 'DIRECTEUR' in role or 'ADMIN' in role:
                dir_fcpi = Recruitment.query.filter_by(status=RecruitmentStatus.WAITING_RH_DIR).all()
                fcpi_requests.extend(dir_fcpi)
        
        # Dédoublonnage (au cas où un admin récupère deux fois la même liste)
        fcpi_requests = list({r.id: r for r in fcpi_requests}.values())
        # Tri par date (plus récent en premier)
        fcpi_requests.sort(key=lambda x: x.created_at, reverse=True)

        return render_template('tickets/manager_dashboard.html', 
                            tickets_n1=tickets_n1, 
                            tickets_n2=tickets_n2, 
                            fcpi_requests=fcpi_requests)

    except Exception as e:
        flash(f"Erreur Dashboard: {e}", "danger")
        return redirect(url_for('main.user_portal'))

@tickets_bp.route('/solver/take/<int:ticket_id>')
@login_required
def take_ticket(ticket_id):
    try:
        if not check_permission(['SOLVER', 'ADMIN', 'MANAGER', 'DIRECTEUR']): 
            flash("Droits insuffisants.", "danger")
            return redirect(url_for('main.user_portal'))
            
        t = Ticket.query.get_or_404(ticket_id)
        t.solver = current_user
        t.status = TicketStatus.IN_PROGRESS
        create_notification(t.author, f"Pris en charge par {current_user.fullname}", 'success', url_for('tickets.view_ticket', ticket_uid=t.uid_public))
        db.session.commit()
        return redirect(url_for('tickets.view_ticket', ticket_uid=t.uid_public))
    except Exception as e:
        flash(f"Erreur prise en charge: {e}", "danger")
        return redirect(url_for('main.user_portal'))

@tickets_bp.route('/solver/daf_submit/<int:ticket_id>', methods=['POST'])
@login_required
def daf_solver_submit(ticket_id):
    try:
        t = Ticket.query.get_or_404(ticket_id)
        if 'daf_prepared_file' in request.files:
            file = request.files['daf_prepared_file']
            if file and file.filename != '':
                filename = secure_filename(f"PREPA_{t.uid_public}_{file.filename}")
                upload_path = os.path.join(current_app.root_path, 'static', 'uploads', 'tickets', t.uid_public)
                os.makedirs(upload_path, exist_ok=True)
                file.save(os.path.join(upload_path, filename))
                t.daf_solver_file = filename
                t.status = TicketStatus.VALIDATION_N2
                db.session.commit()
                flash("Bon transmis au Manager.", "success")
        return redirect(url_for('tickets.view_ticket', ticket_uid=t.uid_public))
    except Exception as e:
        flash(f"Erreur: {e}", "danger")
        return redirect(url_for('main.user_portal'))

@tickets_bp.route('/director/daf_sign/<int:ticket_id>', methods=['POST'])
@login_required
def daf_director_sign(ticket_id):
    try:
        t = Ticket.query.get_or_404(ticket_id)
        if 'daf_signed_file' in request.files:
            file = request.files['daf_signed_file']
            if file and file.filename != '':
                filename = secure_filename(f"SIGNE_{t.uid_public}_{file.filename}")
                upload_path = os.path.join(current_app.root_path, 'static', 'uploads', 'tickets', t.uid_public)
                os.makedirs(upload_path, exist_ok=True)
                file.save(os.path.join(upload_path, filename))
                t.daf_signed_file = filename
                t.status = TicketStatus.DONE
                t.closed_at = datetime.now()
                db.session.commit()
                flash("Bon signé. Ticket clôturé.", "success")
        return redirect(url_for('tickets.manager_dashboard'))
    except Exception as e:
        flash(f"Erreur: {e}", "danger")
        return redirect(url_for('main.user_portal'))

@tickets_bp.route('/solver/close/<int:ticket_id>')
@login_required
def close_ticket(ticket_id):
    try:
        t = Ticket.query.get_or_404(ticket_id)
        t.status = TicketStatus.DONE
        t.closed_at = datetime.now()
        db.session.commit()
        return redirect(url_for('tickets.solver_dashboard'))
    except Exception as e:
        flash(f"Erreur fermeture: {e}", "danger")
        return redirect(url_for('main.user_portal'))

@tickets_bp.route('/manager/action/<int:ticket_id>/<action>')
@login_required
def manager_action(ticket_id, action):
    try:
        t = Ticket.query.get_or_404(ticket_id)
        if action == 'validate':
            if t.status == TicketStatus.VALIDATION_N1:
                if t.target_service == ServiceType.DAF: t.status = TicketStatus.PENDING
                else: t.status = TicketStatus.VALIDATION_N2
            elif t.status == TicketStatus.VALIDATION_N2:
                if t.target_service == ServiceType.DAF: t.status = TicketStatus.DAF_SIGNATURE
                else: t.status = TicketStatus.PENDING
        elif action == 'refuse':
            if t.target_service == ServiceType.DAF and t.status in [TicketStatus.VALIDATION_N2, TicketStatus.DAF_SIGNATURE]:
                t.status = TicketStatus.IN_PROGRESS
            else:
                t.status = TicketStatus.REFUSED
        db.session.commit()
        return redirect(url_for('tickets.manager_dashboard'))
    except Exception as e:
        flash(f"Erreur action: {e}", "danger")
        return redirect(url_for('tickets.manager_dashboard'))
        
@tickets_bp.route('/solver/dashboard')
@login_required
@nocache
def solver_dashboard():
    try:
        if not check_permission(['SOLVER', 'ADMIN', 'MANAGER', 'DIRECTEUR']):
            return render_template('errors/catdance.html'), 403

        my_targets = current_user.get_allowed_services() 
        user_role = safe_role_str(current_user)
        
        if user_role in ['MANAGER', 'DIRECTEUR'] and not my_targets:
             flash("Aucun service technique assigné.", "warning")
             return redirect(url_for('tickets.manager_dashboard'))

        query = Ticket.query.filter(Ticket.status != TicketStatus.DONE)
        
        if 'ADMIN' not in user_role and my_targets:
            tickets_all = query.all()
            tickets_pool = [t for t in tickets_all if t.get_safe_target_service() in my_targets]
        else:
            tickets_pool = query.all()

        pending_tickets = [t for t in tickets_pool if t.solver_id is None and t.get_safe_status() == 'EN_ATTENTE_TRAITEMENT']
        
        pool_standard = [t for t in pending_tickets if not t.category_ticket or t.category_ticket in ['Standard', 'Incident Standard']]
        pool_users = [t for t in pending_tickets if t.category_ticket == 'Nouvel Utilisateur']
        pool_materiel = [t for t in pending_tickets if t.category_ticket == 'Matériel']
        pool_bons = [t for t in pending_tickets if t.category_ticket == 'Bon de Commande']
        
        mine = Ticket.query.filter_by(solver_id=current_user.id, status=TicketStatus.IN_PROGRESS).all()
        
        hist_query = Ticket.query.filter_by(status=TicketStatus.DONE)
        history_all = hist_query.order_by(Ticket.closed_at.desc()).limit(20).all()
        if 'ADMIN' not in user_role and my_targets:
            history = [t for t in history_all if t.get_safe_target_service() in my_targets]
        else:
            history = history_all

        stats = {
            'active': len(mine),
            'done': len(history),
            'pending': len(pending_tickets),
            'stock': Materiel.query.filter_by(statut='Disponible').count(),
            'prets': Pret.query.filter_by(statut_dossier='En cours').count()
        }
        team_solvers = User.query.filter(User.role == UserRole.SOLVER).all()

        return render_template('tickets/service_dashboard.html', stats=stats, pool_standard=pool_standard, pool_users=pool_users, pool_materiel=pool_materiel, pool_bons=pool_bons, mine=mine, history=history, solvers=team_solvers, services=ServiceType)
    except Exception as e:
        return render_template('base.html', content=f"<h1>Erreur 500 Dashboard</h1><p>{e}</p>")
        
@tickets_bp.route('/historique', methods=['GET', 'POST'])
@login_required
@nocache
def historique_tickets():
    return render_template('tickets/historique_tickets.html', tickets=[]) 

@tickets_bp.route('/export/history')
@login_required
def export_history():
    return redirect(url_for('tickets.solver_dashboard')) 

@tickets_bp.route('/solver/assign/<int:ticket_id>', methods=['POST'])
@login_required
def assign_ticket(ticket_id):
    t = Ticket.query.get_or_404(ticket_id)
    sid = request.form.get('solver_id')
    if sid:
        u = User.query.get(sid)
        if u:
            t.solver = u
            t.status = TicketStatus.IN_PROGRESS
            db.session.commit()
    return redirect(url_for('tickets.solver_dashboard'))

@tickets_bp.route('/solver/transfer/<int:ticket_id>', methods=['POST'])
@login_required
def transfer_ticket(ticket_id):
    return redirect(url_for('tickets.solver_dashboard'))



================================================
FILE: app/routes/users.py
================================================
from flask import Blueprint, render_template, redirect, url_for, flash, request
from flask_login import login_required, current_user
from app.models import User, UserRole, ServiceType
from app import db

users_bp = Blueprint('users', __name__)

@users_bp.route('/admin/users')
@login_required
def list_users():
    # Sécurité : Admin Only
    if 'ADMIN' not in str(current_user.role.value).upper():
        flash("Accès réservé aux administrateurs.", "danger")
        return redirect(url_for('main.user_portal'))
    
    users = User.query.all()
    
    # Préparation des listes pour les menus déroulants
    roles = [r.value for r in UserRole]
    # On récupère juste les noms des services
    services = [s.value for s in ServiceType]
    
    return render_template('admin_users.html', users=users, roles=roles, services=services)

@users_bp.route('/admin/users/edit/<int:id>', methods=['POST'])
@login_required
def edit_user(id):
    if 'ADMIN' not in str(current_user.role.value).upper():
        return redirect(url_for('main.user_portal'))
        
    user = User.query.get_or_404(id)
    
    # Mise à jour du nom
    user.fullname = request.form.get('fullname')
    
    # Mise à jour du Rôle
    role_value = request.form.get('role')
    # On cherche l'Enum correspondant à la valeur
    for r in UserRole:
        if r.value == role_value:
            user.role = r
            break
            
    # Mise à jour du Service Technique (GS - Allowed Services)
    # Dans l'admin simple, on assigne un seul service principal pour l'instant
    service_value = request.form.get('service')
    
    if service_value and service_value != 'None':
        # On définit ce service comme le SEUL service autorisé et d'origine
        # C'est une simplification pour l'interface admin basique
        user.set_allowed_services([service_value])
        user.set_origin_services([service_value])
    else:
        # Si aucun service sélectionné, on vide les listes
        user.set_allowed_services([])
        # On ne vide pas forcément l'origine si on veut garder l'historique, mais ici on reset tout
        # user.set_origin_services([]) 
        
    db.session.commit()
    flash(f'Utilisateur {user.fullname} mis à jour.', 'success')
    return redirect(url_for('users.list_users'))

@users_bp.route('/admin/users/delete/<int:id>')
@login_required
def delete_user(id):
    if 'ADMIN' not in str(current_user.role.value).upper():
        return redirect(url_for('main.user_portal'))
        
    user = User.query.get_or_404(id)
    
    if user.id != current_user.id:
        db.session.delete(user)
        db.session.commit()
        flash('Utilisateur supprimé.', 'success')
    else:
        flash('Impossible de se supprimer soi-même.', 'danger')
        
    return redirect(url_for('users.list_users'))



================================================
FILE: app/static/uploads/Export_Prets_20260114_1106.xlsx
================================================
[Binary file]


================================================
FILE: app/static/uploads/Export_Stock_20260114_1106.xlsx
================================================
[Binary file]


================================================
FILE: app/static/uploads/Historique_Tickets_20260114_1127.xlsx
================================================
[Binary file]


================================================
FILE: app/static/uploads/tickets/20251230-001/Export_Prets_20251223.xlsx
================================================
[Binary file]


================================================
FILE: app/templates/admin_users.html
================================================
{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8 dark:bg-slate-950 min-h-screen transition-colors duration-300">
    
    <!-- En-tête -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-black text-slate-900 dark:text-white uppercase tracking-tight">Administration Utilisateurs</h1>
            <p class="text-slate-500 dark:text-slate-400 font-bold text-xs mt-1 uppercase tracking-wide">Gestion des accès et rôles</p>
        </div>
        <a href="{{ url_for('main.user_portal') }}" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 px-4 py-2 rounded-xl font-black text-xs uppercase shadow-sm flex items-center gap-2 transition">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> Retour Portail
        </a>
    </div>

    <!-- Tableau Utilisateurs -->
    <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-slate-600 dark:text-slate-300">
                <thead class="bg-slate-50 dark:bg-slate-900/50 border-b border-slate-100 dark:border-slate-700 text-slate-500 dark:text-slate-400 uppercase font-black text-[10px] tracking-wider">
                    <tr>
                        <th class="px-6 py-4">Utilisateur</th>
                        <th class="px-6 py-4">Email / Login</th>
                        <th class="px-6 py-4">Rôle Actuel</th>
                        <th class="px-6 py-4">Services (Tech)</th>
                        <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 dark:divide-slate-700 font-medium">
                    {% for user in users %}
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition group">
                        <td class="px-6 py-4">
                            <div class="font-bold text-slate-900 dark:text-white">{{ user.fullname }}</div>
                            <div class="text-[10px] text-slate-400 dark:text-slate-500 font-mono">ID: {{ user.id }}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-xs">{{ user.email }}</div>
                            <div class="text-[10px] text-slate-400 dark:text-slate-500 font-mono">{{ user.username }}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-black uppercase tracking-wide
                                {% if user.role.value == 'ADMIN' %}bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400
                                {% elif user.role.value == 'DIRECTEUR' %}bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400
                                {% elif user.role.value == 'MANAGER' %}bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400
                                {% elif user.role.value == 'SOLVER' %}bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400
                                {% else %}bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400{% endif %}">
                                {{ user.role.value }}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <!-- Affichage de la liste des services autorisés -->
                            {% set services_list = user.get_allowed_services() %}
                            {% if services_list %}
                                <div class="flex flex-wrap gap-1">
                                    {% for s in services_list %}
                                    <span class="bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 px-1.5 py-0.5 rounded text-[10px] font-mono text-slate-600 dark:text-slate-300">
                                        {{ s }}
                                    </span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <span class="text-slate-300 dark:text-slate-600 italic text-xs">-</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="openEditModal('{{ user.id }}', '{{ user.fullname }}', '{{ user.role.value }}', '{{ services_list[0] if services_list else '' }}')" 
                                class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-bold text-xs uppercase hover:underline mr-3">
                                Modifier
                            </button>
                            {% if user.id != current_user.id %}
                            <a href="{{ url_for('users.delete_user', id=user.id) }}" onclick="return confirm('Supprimer cet utilisateur ?')" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-bold text-xs uppercase hover:underline">
                                Supprimer
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL EDIT USER -->
<div id="editUserModal" class="hidden fixed inset-0 bg-slate-900/60 dark:bg-slate-950/80 z-50 flex items-center justify-center backdrop-blur-sm transition-opacity">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl w-full max-w-md m-4 shadow-2xl relative border border-slate-100 dark:border-slate-700">
        <button onclick="document.getElementById('editUserModal').classList.add('hidden')" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition">
            <i data-lucide="x" class="w-6 h-6"></i>
        </button>
        
        <h3 class="text-xl font-black text-slate-900 dark:text-white uppercase tracking-tight mb-6">Modifier Utilisateur</h3>
        
        <form id="editUserForm" method="POST" class="space-y-4">
            <div>
                <label class="label-tiny">Nom Complet</label>
                <input type="text" name="fullname" id="editFullname" class="input-field" required>
            </div>
            
            <div>
                <label class="label-tiny">Rôle</label>
                <select name="role" id="editRole" class="input-field">
                    {% for r in roles %}
                    <option value="{{ r }}">{{ r }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="label-tiny">Service Principal (Technique)</label>
                <select name="service" id="editService" class="input-field">
                    <option value="None">-- Aucun --</option>
                    {% for s in services %}
                    <option value="{{ s }}">{{ s }}</option>
                    {% endfor %}
                </select>
                <p class="text-[10px] text-slate-400 dark:text-slate-500 mt-1 italic">Note: Définit le service géré (GS) et d'origine (GU) pour simplifier.</p>
            </div>

            <button type="submit" class="w-full bg-blue-600 text-white font-black py-3 rounded-xl hover:bg-blue-500 transition shadow-lg text-xs uppercase tracking-widest mt-2">
                Enregistrer
            </button>
        </form>
    </div>
</div>

<script>
    lucide.createIcons();

    function openEditModal(id, fullname, role, service) {
        const modal = document.getElementById('editUserModal');
        const form = document.getElementById('editUserForm');
        
        // Pré-remplissage
        document.getElementById('editFullname').value = fullname;
        document.getElementById('editRole').value = role;
        
        // Sélection du service (si présent)
        const serviceSelect = document.getElementById('editService');
        if (service && service !== 'None') {
            serviceSelect.value = service;
        } else {
            serviceSelect.value = 'None';
        }
        
        // CORRECTION IMPORTANTE DE L'URL
        // On utilise la base de l'URL admin pour construire le chemin correct
        // Cela évite l'erreur 404 si l'app est dans un sous-dossier (/intranet)
        // flask génère /admin/users, on ajoute /edit/ID
        form.action = `{{ url_for('users.list_users') }}/edit/${id}`;
        
        modal.classList.remove('hidden');
    }
</script>

<style>
    .label-tiny { font-size: 10px; font-weight: 900; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.1em; margin-bottom: 4px; display: block; } 
    .dark .label-tiny { color: #94a3b8; }

    .input-field { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 0.75rem; border-radius: 0.5rem; outline: none; transition: all 0.2s; color: #1e293b; } 
    .input-field:focus { border-color: #3b82f6; background-color: white; }

    /* Dark Mode Inputs */
    .dark .input-field { background-color: #1e293b; border-color: #334155; color: #f1f5f9; }
    .dark .input-field:focus { border-color: #60a5fa; background-color: #0f172a; }
</style>
{% endblock %}



================================================
FILE: app/templates/base.html
================================================
<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ILVM - Intranet</title>
    <!-- Tailwind CSS (avec support Dark Mode) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b', // Couleur sombre custom
                            950: '#020617', // Très sombre
                        }
                    }
                }
            }
        }
    </script>
    <!--  LES ONGLETS 👇 -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Icônes Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Vos styles personnalisés conservés */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        .alert-error { background-color: #fee2e2; border-left: 4px solid #ef4444; color: #b91c1c; }
        .alert-success { background-color: #d1fae5; border-left: 4px solid #10b981; color: #047857; }
        .alert-warning { background-color: #ffedd5; border-left: 4px solid #f97316; color: #c2410c; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .anim-greeting { animation: fadeInUp 0.5s ease-out forwards; }
        
        /* Styles spécifiques Dark Mode pour les alertes */
        .dark .alert-error { background-color: #450a0a; border-left-color: #ef4444; color: #fca5a5; }
        .dark .alert-success { background-color: #022c22; border-left-color: #10b981; color: #6ee7b7; }
        .dark .alert-warning { background-color: #431407; border-left-color: #f97316; color: #fdba74; }
    </style>
    
    <!-- Script d'initialisation du thème (avant chargement du body pour éviter le flash) -->
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-slate-50 font-sans text-slate-900 antialiased selection:bg-blue-100 selection:text-blue-900 dark:bg-slate-950 dark:text-slate-100 dark:selection:bg-blue-900 dark:selection:text-blue-100 transition-colors duration-300">

    <!-- Flash Messages (Notifications) -->
    <div class="fixed top-4 right-4 z-50 w-96 space-y-2 pointer-events-none">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="pointer-events-auto shadow-lg rounded-lg p-4 mb-2 flex items-start transform transition-all duration-300 hover:scale-105 bg-white dark:bg-slate-800 border border-transparent
                    {% if category == 'danger' %}alert-error{% elif category == 'success' %}alert-success{% else %}alert-warning{% endif %}">
                    <div class="flex-1">
                        <p class="font-bold text-sm">{{ 'Succès' if category == 'success' else 'Attention' }}</p>
                        <p class="text-sm opacity-90">{{ message }}</p>
                    </div>
                    <button onclick="this.parentElement.remove()" class="ml-3 text-current opacity-50 hover:opacity-100 focus:outline-none">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Navigation Bar (Optionnelle, visible sauf sur Login) -->
    {% if current_user.is_authenticated and request.endpoint != 'auth.login' %}
    <nav class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center sticky top-0 z-40 shadow-sm dark:bg-slate-900 dark:border-slate-800 transition-colors duration-300">
        <div class="flex items-center gap-4">
            <a href="{{ url_for('main.user_portal') }}" class="flex items-center gap-2 group">
                <div class="bg-blue-600 text-white p-1.5 rounded-lg group-hover:bg-blue-700 transition">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-lg text-slate-800 tracking-tight group-hover:text-blue-600 dark:text-slate-100 dark:group-hover:text-blue-400 transition">Intranet</span>
            </a>
            
            <!-- Liens contextuels VISIBLES POUR TOUS (Sécurité gérée par redirection backend) -->
            <div class="hidden md:flex gap-1 ml-6">
                <!-- Bouton Espace Tech (Visible pour tous) -->
                <a href="{{ url_for('tickets.solver_dashboard') }}" class="px-3 py-1.5 rounded-md text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-blue-50 transition flex items-center gap-2 dark:text-slate-300 dark:hover:text-blue-400 dark:hover:bg-slate-800">
                    <i data-lucide="wrench" class="w-4 h-4"></i> Espace Tech
                </a>
                
                <!-- Bouton Validation (Visible pour tous) -->
                <a href="{{ url_for('tickets.manager_dashboard') }}" class="px-3 py-1.5 rounded-md text-sm font-medium text-slate-600 hover:text-purple-600 hover:bg-purple-50 transition flex items-center gap-2 dark:text-slate-300 dark:hover:text-purple-400 dark:hover:bg-slate-800">
                    <i data-lucide="check-circle" class="w-4 h-4"></i> Validation
                </a>
            </div>
        </div>

        <div class="flex items-center gap-4">
            
            <!-- BOUTON DARK MODE -->
            <button id="theme-toggle" class="p-2 text-slate-400 hover:text-yellow-500 hover:bg-slate-100 dark:hover:bg-slate-800 dark:hover:text-yellow-300 rounded-lg transition" title="Changer le thème">
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
            </button>

            <!-- Notifications -->
            <div class="relative" id="notif-container">
                <button onclick="toggleNotifs()" class="relative p-2 text-slate-400 hover:text-blue-600 transition rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 dark:hover:text-blue-400">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span id="notif-badge" class="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full hidden"></span>
                </button>
                
                <!-- Dropdown Notifs -->
                <div id="notif-dropdown" class="absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-2xl border border-slate-100 hidden transform origin-top-right transition-all z-50 dark:bg-slate-800 dark:border-slate-700">
                    <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl dark:bg-slate-700 dark:border-slate-600">
                        <span class="text-xs font-bold text-slate-500 uppercase tracking-wider dark:text-slate-300">Notifications</span>
                        <button onclick="markAllRead()" class="text-xs text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">Tout marquer lu</button>
                    </div>
                    <div id="notif-list" class="max-h-64 overflow-y-auto scrollbar-hide p-1 space-y-1">
                        <!-- JS injectera ici -->
                        <div class="p-4 text-center text-slate-400 text-xs italic">Chargement...</div>
                    </div>
                </div>
            </div>

            <!-- User Menu -->
            <div class="flex items-center gap-3 pl-4 border-l border-slate-200 dark:border-slate-700">
                <div class="text-right hidden sm:block">
                    <p class="text-sm font-bold text-slate-700 leading-none dark:text-slate-200">{{ current_user.fullname }}</p>
                    <p class="text-[10px] text-slate-400 font-mono mt-1 uppercase">{{ current_user.role.value }}</p>
                </div>
                <a href="{{ url_for('auth.logout') }}" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition dark:hover:bg-slate-800" title="Déconnexion">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </a>
            </div>
        </div>
    </nav>
    {% endif %}

    <!-- Main Content -->
    <main class="min-h-screen bg-slate-50 dark:bg-slate-950 transition-colors duration-300">
        {% block content %}{% endblock %}
    </main>

    <!-- Init Lucide Icons -->
    <script>
        lucide.createIcons();

        // --- GESTION DARK MODE ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeIconSun = document.querySelector('.dark\\:block'); // Soleil
        const themeIconMoon = document.querySelector('.dark\\:hidden'); // Lune

        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', function() {
                // Bascule la classe dark sur html
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.theme = 'light';
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.theme = 'dark';
                }
            });
        }

        // --- GESTION NOTIFICATIONS (CORRIGÉ) ---
        const notifBadge = document.getElementById('notif-badge');
        const notifDropdown = document.getElementById('notif-dropdown');
        const notifList = document.getElementById('notif-list');

        function toggleNotifs() {
            if (notifDropdown.classList.contains('hidden')) {
                notifDropdown.classList.remove('hidden');
                loadNotifications();
            } else {
                notifDropdown.classList.add('hidden');
            }
        }

        async function checkNotificationCount() {
            try {
                // CORRECTION : Utilisation de url_for pour la bonne route API
                const res = await fetch("{{ url_for('api.get_notifications_count') }}");
                const data = await res.json();
                if (data.count > 0) {
                    notifBadge.classList.remove('hidden');
                } else {
                    notifBadge.classList.add('hidden');
                }
            } catch (e) { console.error("Notif error", e); }
        }

        // Vérif toutes les 30s
        if(document.getElementById('notif-container')) {
            setInterval(checkNotificationCount, 30000);
            checkNotificationCount();
        }

        async function loadNotifications() {
            try {
                // CORRECTION : Utilisation de url_for
                const res = await fetch("{{ url_for('api.get_notifications') }}");
                const data = await res.json();
                notifList.innerHTML = '';
                
                if (data.notifications.length === 0) {
                    notifList.innerHTML = '<div class="p-4 text-center text-slate-400 text-xs dark:text-slate-500">Aucune notification.</div>';
                    return;
                }

                data.notifications.forEach(n => {
                    const item = document.createElement('div');
                    // Adaptation Dark Mode pour les items de notif
                    item.className = `p-3 rounded-lg hover:bg-slate-50 cursor-pointer transition border-l-2 dark:hover:bg-slate-700 ${n.is_read ? 'border-transparent opacity-50' : 'border-blue-500 bg-blue-50/50 dark:bg-blue-900/20'}`;
                    
                    let colorClass = 'bg-blue-500';
                    if (n.category === 'success') colorClass = 'bg-green-500';
                    if (n.category === 'warning' || n.category === 'danger') colorClass = 'bg-red-500';

                    item.innerHTML = `
                        <div class="flex gap-3 items-start">
                            <div class="w-2 h-2 mt-1.5 rounded-full ${colorClass}"></div>
                            <div class="flex-1">
                                <p class="text-xs font-bold text-slate-700 leading-tight dark:text-slate-200">${n.message}</p>
                                <p class="text-[10px] text-slate-400 mt-1">${new Date(n.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                            </div>
                        </div>
                    `;
                    item.onclick = () => {
                        markRead(n.id);
                        if (n.link) window.location.href = n.link;
                    };
                    notifList.appendChild(item);
                });
            } catch (e) {
                notifList.innerHTML = '<div class="p-4 text-center text-red-400 text-xs">Erreur de chargement.</div>';
            }
        }

        async function markRead(id) {
            // CORRECTION URL
            await fetch(`/api/notifications/read/${id}`, { method: 'POST' });
            checkNotificationCount();
        }

        async function markAllRead() {
            // CORRECTION URL (url_for serait mieux mais ici c'est plus complexe à injecter dans une string template JS pur, le hardcode relatif marche souvent si api_bp n'a pas de préfixe complexe)
            await fetch("{{ url_for('api.mark_all_read') }}", { method: 'POST' });
            checkNotificationCount();
            notifDropdown.classList.add('hidden');
        }
    </script>
</body>
</html>



================================================
FILE: app/templates/inventaire.html
================================================
{% extends "base.html" %}
{% block content %}
<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 px-6 pt-6">
    <div>
        <h1 class="text-3xl font-black text-slate-900 dark:text-white uppercase tracking-tight">Stock Matériel</h1>
        <p class="text-slate-500 dark:text-slate-400 font-bold text-xs mt-1 uppercase tracking-wide">Parc informatique</p>
    </div>
    <div class="flex flex-wrap gap-3">
        <!-- BOUTON RETOUR DASHBOARD -->
        <a href="{{ url_for('tickets.solver_dashboard') }}" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 px-4 py-3 rounded-xl font-black text-xs uppercase shadow-sm flex items-center gap-2 transition">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> Retour
        </a>

        <a href="{{ url_for('inventaire.export_stock') }}" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-3 rounded-xl font-black text-xs uppercase shadow-lg flex items-center gap-2">
            <i data-lucide="download"></i> Exporter
        </a>
        <button onclick="document.getElementById('importModal').classList.remove('hidden')" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-3 rounded-xl font-black text-xs uppercase shadow-lg flex items-center gap-2">
            <i data-lucide="upload"></i> Importer
        </button>
        <button onclick="document.getElementById('addModal').classList.remove('hidden')" class="bg-slate-900 dark:bg-slate-700 hover:bg-slate-800 dark:hover:bg-slate-600 text-white px-6 py-3 rounded-xl font-black text-xs uppercase shadow-lg flex items-center gap-2 hover:-translate-y-1 transition">
            <i data-lucide="plus-circle"></i> Ajouter
        </button>
    </div>
</div>

<div class="px-6 pb-20">
    <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
        <table class="w-full text-left text-sm text-slate-600 dark:text-slate-300">
            <thead class="bg-slate-50 dark:bg-slate-700 border-b border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400 uppercase font-black text-[10px] tracking-wider">
                <tr>
                    <th class="px-6 py-4">Type</th>
                    <th class="px-6 py-4">Modèle</th>
                    <th class="px-6 py-4">S/N</th>
                    <th class="px-6 py-4">Hostname</th>
                    <th class="px-6 py-4">Statut</th>
                    <th class="px-6 py-4 text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 dark:divide-slate-700 font-medium">
                {% for item in materiels %}
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                    <td class="px-6 py-4"><span class="bg-slate-100 dark:bg-slate-900 text-slate-600 dark:text-slate-400 px-2 py-1 rounded text-xs font-bold uppercase">{{ item.categorie }}</span></td>
                    <td class="px-6 py-4 text-slate-900 dark:text-white font-bold">{{ item.modele }}</td>
                    <td class="px-6 py-4 font-mono text-xs text-slate-500 dark:text-slate-400">{{ item.sn }}</td>
                    <td class="px-6 py-4 font-mono text-xs text-blue-600 dark:text-blue-400">{{ item.hostname or '-' }}</td>
                    <td class="px-6 py-4">
                        {% if item.statut == 'Disponible' %}
                        <span class="text-emerald-600 dark:text-emerald-400 text-xs font-black uppercase flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> Dispo</span>
                        {% else %}
                        <span class="text-orange-500 dark:text-orange-400 text-xs font-black uppercase flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-500"></span> {{ item.statut }}</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-right flex justify-end gap-2">
                        <button onclick="document.getElementById('edit-mat-{{ item.id }}').classList.remove('hidden')" class="p-2 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-lg"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        <a href="{{ url_for('inventaire.supprimer', id=item.id) }}" onclick="return confirm('Supprimer ?')" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg"><i data-lucide="trash" class="w-4 h-4"></i></a>
                    </td>
                </tr>

                <!-- MODAL EDIT (Pour chaque item) -->
                <div id="edit-mat-{{ item.id }}" class="hidden fixed inset-0 bg-slate-900/60 dark:bg-slate-950/80 z-50 flex items-center justify-center backdrop-blur-sm">
                    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl w-full max-w-md shadow-2xl relative border border-slate-100 dark:border-slate-700">
                        <h3 class="text-xl font-black text-slate-900 dark:text-white mb-4">Modifier {{ item.modele }}</h3>
                        <form action="{{ url_for('inventaire.modifier', id=item.id) }}" method="POST" class="space-y-4">
                            <input type="text" name="categorie" value="{{ item.categorie }}" class="input-field" placeholder="Catégorie">
                            <input type="text" name="modele" value="{{ item.modele }}" class="input-field" placeholder="Modèle">
                            <input type="text" name="sn" value="{{ item.sn }}" class="input-field font-mono" placeholder="S/N">
                            <input type="text" name="hostname" value="{{ item.hostname or '' }}" class="input-field font-mono" placeholder="Hostname">
                            <input type="text" name="imei" value="{{ item.imei or '' }}" class="input-field font-mono" placeholder="IMEI">
                            <div class="flex gap-2 mt-4">
                                <button type="button" onclick="document.getElementById('edit-mat-{{ item.id }}').classList.add('hidden')" class="flex-1 py-3 border border-slate-200 dark:border-slate-600 rounded-xl font-bold text-xs uppercase hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">Annuler</button>
                                <button type="submit" class="flex-1 bg-blue-600 text-white rounded-xl font-bold text-xs uppercase hover:bg-blue-700">Sauvegarder</button>
                            </div>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- MODAL ADD -->
<div id="addModal" class="hidden fixed inset-0 bg-slate-900/60 dark:bg-slate-950/80 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl w-full max-w-md shadow-2xl relative border border-slate-100 dark:border-slate-700">
        <button onclick="document.getElementById('addModal').classList.add('hidden')" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i data-lucide="x"></i></button>
        <h3 class="text-2xl font-black text-slate-900 dark:text-white uppercase tracking-tight mb-6">Ajouter Matériel</h3>
        <form action="{{ url_for('inventaire.ajouter') }}" method="POST" class="space-y-4">
            <select name="categorie" id="catSelect" onchange="toggleImei()" class="input-field">
                <option value="PC Portable">PC Portable</option>
                <option value="Ecran">Ecran</option>
                <option value="Telephone">Téléphone</option>
                <option value="Tablette">Tablette</option>
                <option value="Peripherique">Périphérique</option>
            </select>
            <input type="text" name="modele" class="input-field" placeholder="Modèle (ex: Dell Latitude)" required>
            <input type="text" name="sn" class="input-field font-mono" placeholder="Numéro Série (S/N)" required>
            <input type="text" name="hostname" class="input-field font-mono" placeholder="Hostname (ex: ILVMLT001)">
            <input type="text" name="imei" id="imeiField" class="input-field font-mono hidden" placeholder="IMEI (Si téléphone)">
            <button type="submit" class="w-full bg-slate-900 dark:bg-blue-600 text-white font-black py-4 rounded-xl hover:bg-slate-800 dark:hover:bg-blue-500 transition shadow-lg text-xs uppercase tracking-widest mt-2">Ajouter au stock</button>
        </form>
    </div>
</div>

<!-- MODAL IMPORT -->
<div id="importModal" class="hidden fixed inset-0 bg-slate-900/60 dark:bg-slate-950/80 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl w-full max-w-md shadow-2xl relative border border-slate-100 dark:border-slate-700">
        <button onclick="document.getElementById('importModal').classList.add('hidden')" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i data-lucide="x"></i></button>
        <h3 class="text-xl font-black text-slate-900 dark:text-white mb-4">Importer Excel</h3>
        <form action="{{ url_for('inventaire.import_stock') }}" method="POST" enctype="multipart/form-data" class="space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-xl text-xs text-blue-800 dark:text-blue-300 font-medium">Fichier .xlsx avec colonnes: Categorie, Modele, SN, Hostname, IMEI</div>
            <input type="file" name="file" accept=".xlsx" class="input-field bg-white dark:bg-slate-700" required>
            <button type="submit" class="w-full bg-blue-600 text-white font-black py-3 rounded-xl hover:bg-blue-700 shadow-lg text-xs uppercase tracking-widest">Lancer l'import</button>
        </form>
    </div>
</div>

<script>
    function toggleImei() { 
        const val = document.getElementById('catSelect').value;
        document.getElementById('imeiField').classList.toggle('hidden', val !== 'Telephone' && val !== 'Tablette'); 
    }
    lucide.createIcons();
</script>

<style>
    .label-tiny { font-size: 10px; font-weight: 900; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.1em; margin-bottom: 4px; display: block; }
    /* Dark mode override */
    .dark .label-tiny { color: #94a3b8; }

    .input-field { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.75rem; outline: none; transition: all 0.2s; color: #1e293b; }
    .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); background-color: white; }

    /* Dark Mode Inputs */
    .dark .input-field { background-color: #1e293b; border-color: #334155; color: #f1f5f9; }
    .dark .input-field:focus { border-color: #60a5fa; background-color: #0f172a; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
</style>
{% endblock %}



================================================
FILE: app/templates/my_history.html
================================================
{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto py-8">
    
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-black text-slate-900 uppercase tracking-tight">Mon Historique</h1>
            <p class="text-slate-500 font-bold text-xs mt-1 uppercase tracking-wide">Toutes mes demandes</p>
        </div>
        <a href="{{ url_for('main.user_portal') }}" class="bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 px-4 py-2 rounded-xl font-black text-xs uppercase shadow-sm flex items-center gap-2 transition">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> Retour Portail
        </a>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <table class="w-full text-left text-sm">
            <thead class="bg-slate-50 border-b border-slate-200">
                <tr class="text-slate-500 font-black uppercase text-[10px] tracking-wider">
                    <th class="px-6 py-4">Réf</th>
                    <th class="px-6 py-4">Date</th>
                    <th class="px-6 py-4">Service</th>
                    <th class="px-6 py-4">Sujet</th>
                    <th class="px-6 py-4">Statut</th>
                    <th class="px-6 py-4 text-right"></th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 font-medium text-slate-700">
                {% for ticket in tickets %}
                <tr class="hover:bg-slate-50 transition group">
                    <td class="px-6 py-4 font-mono text-slate-400 font-bold">{{ ticket.uid_public }}</td>
                    <td class="px-6 py-4 text-xs font-bold">{{ ticket.created_at.strftime('%d/%m/%Y') }}</td>
                    <td class="px-6 py-4"><span class="font-black text-[10px] uppercase text-slate-500 bg-slate-100 px-2 py-1 rounded">{{ ticket.target_service.value }}</span></td>
                    <td class="px-6 py-4 font-bold text-slate-900">{{ ticket.title }}</td>
                    <td class="px-6 py-4">
                        <span class="inline-block px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-wide 
                            {% if 'VALIDATION' in ticket.status.value %}bg-yellow-100 text-yellow-700
                            {% elif 'COURS' in ticket.status.value %}bg-blue-100 text-blue-700
                            {% elif 'TERMINE' in ticket.status.value %}bg-emerald-100 text-emerald-700
                            {% else %}bg-red-50 text-red-600{% endif %}">
                            {{ ticket.status.value }}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <a href="{{ url_for('tickets.view_ticket', ticket_uid=ticket.uid_public) }}" class="text-blue-600 hover:text-blue-800 font-bold uppercase text-xs">Voir</a>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="6" class="p-8 text-center text-slate-400 italic font-bold">Aucune demande enregistrée.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>
<script>lucide.createIcons();</script>
{% endblock %}



================================================
FILE: app/templates/portal.html
================================================
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portail Intranet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b', 
                            950: '#020617', 
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-service { transition: all 0.3s ease; }
        .card-service:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
    </style>
    <!-- Script d'initialisation du thème pour éviter le flash -->
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-slate-50 dark:bg-slate-950 min-h-screen transition-colors duration-300">

    <!-- BARRE DE NAVIGATION -->
    <nav class="bg-slate-900 text-white sticky top-0 z-50 border-b border-slate-800">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-8">
                <!-- Logo -->
                <span class="font-black text-xl tracking-tighter text-blue-500 italic flex items-center gap-2">
                    <i data-lucide="monitor-check"></i> ILVM<span class="text-white">PORTAIL</span>
                </span>

                <!-- AJOUT DES BOUTONS ICI (Visibles pour tous) -->
                <div class="hidden md:flex gap-1 ml-6">
                    <a href="{{ url_for('tickets.solver_dashboard') }}" class="px-3 py-1.5 rounded-md text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-800 transition flex items-center gap-2">
                        <i data-lucide="wrench" class="w-4 h-4"></i> Espace Tech
                    </a>
                    
                    <a href="{{ url_for('tickets.manager_dashboard') }}" class="px-3 py-1.5 rounded-md text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-800 transition flex items-center gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4"></i> Validation
                    </a>
                </div>
            </div>

            <!-- Menu Utilisateur + Dark Mode Toggle -->
            <div class="flex items-center gap-4">
                <!-- Toggle Dark Mode -->
                <button id="theme-toggle-portal" class="p-2 text-slate-400 hover:text-yellow-500 hover:bg-slate-800 rounded-lg transition" title="Changer le thème">
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                    <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                </button>

                <div class="text-right hidden sm:block">
                    <p class="text-xs font-bold text-white">{{ current_user.fullname }}</p>
                    <p class="text-[10px] text-slate-400 uppercase font-bold">{{ current_user.role.value }}</p>
                </div>
                <a href="{{ url_for('auth.logout') }}" class="bg-red-600 hover:bg-red-700 p-2 rounded-lg transition" title="Déconnexion">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- CONTENU PRINCIPAL -->
    <div class="container mx-auto px-4 py-12">
        <!-- Message de bienvenue -->
        <div class="mb-12 text-center">
            <h1 class="text-4xl font-black text-slate-900 dark:text-white mb-2">Bonjour, <span class="text-blue-600">{{ current_user.fullname.split()[0] }}</span> <br> comment pouvons-nous vous aider ? </h1>
            <p class="text-slate-500 dark:text-slate-400 font-medium">Sélectionnez un service pour créer une nouvelle demande</p>
        </div>

        <!-- Grille Services -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl mx-auto mb-16">
            
            <!-- Carte Informatique -->
            <a href="{{ url_for('tickets.new_ticket', service_name='INFO') }}" class="card-service bg-white dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 group cursor-pointer relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i data-lucide="monitor" class="w-24 h-24 text-blue-600"></i>
                </div>
                <div class="w-14 h-14 bg-blue-50 dark:bg-blue-900/30 rounded-2xl flex items-center justify-center mb-4 text-blue-600 dark:text-blue-400 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                    <i data-lucide="monitor" class="w-7 h-7"></i>
                </div>
                <h3 class="text-xl font-black text-slate-800 dark:text-white mb-1">Informatique</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-medium leading-relaxed">Problème PC, Internet, Logiciel, Imprimante...</p>
                <div class="mt-4 flex items-center text-blue-600 dark:text-blue-400 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity transform translate-y-2 group-hover:translate-y-0">
                    Faire une demande <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
                </div>
            </a>

            <!-- Carte DAF -->
            <a href="{{ url_for('tickets.new_ticket', service_name='DAF') }}" class="card-service bg-white dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 group cursor-pointer relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i data-lucide="banknote" class="w-24 h-24 text-purple-600"></i>
                </div>
                <div class="w-14 h-14 bg-purple-50 dark:bg-purple-900/30 rounded-2xl flex items-center justify-center mb-4 text-purple-600 dark:text-purple-400 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                    <i data-lucide="banknote" class="w-7 h-7"></i>
                </div>
                <h3 class="text-xl font-black text-slate-800 dark:text-white mb-1">DAF / Achats</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-medium leading-relaxed">Bons de commande, Factures, Budget...</p>
                <div class="mt-4 flex items-center text-purple-600 dark:text-purple-400 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity transform translate-y-2 group-hover:translate-y-0">
                    Faire une demande <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
                </div>
            </a>

            <!-- Carte Technique -->
            <a href="{{ url_for('tickets.new_ticket', service_name='TECH') }}" class="card-service bg-white dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 group cursor-pointer relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i data-lucide="wrench" class="w-24 h-24 text-orange-600"></i>
                </div>
                <div class="w-14 h-14 bg-orange-50 dark:bg-orange-900/30 rounded-2xl flex items-center justify-center mb-4 text-orange-600 dark:text-orange-400 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                    <i data-lucide="wrench" class="w-7 h-7"></i>
                </div>
                <h3 class="text-xl font-black text-slate-800 dark:text-white mb-1">Services Techniques</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-medium leading-relaxed">Travaux, Maintenance, Plomberie...</p>
                <div class="mt-4 flex items-center text-orange-600 dark:text-orange-400 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity transform translate-y-2 group-hover:translate-y-0">
                    Faire une demande <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
                </div>
            </a>

            <!-- Carte Généraux -->
            <a href="{{ url_for('tickets.new_ticket', service_name='GEN') }}" class="card-service bg-white dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 group cursor-pointer relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i data-lucide="file-plus" class="w-24 h-24 text-emerald-600"></i>
                </div>
                <div class="w-14 h-14 bg-emerald-50 dark:bg-emerald-900/30 rounded-2xl flex items-center justify-center mb-4 text-emerald-600 dark:text-emerald-400 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                    <i data-lucide="file-plus" class="w-7 h-7"></i>
                </div>
                <h3 class="text-xl font-black text-slate-800 dark:text-white mb-1">Services Généraux</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-medium leading-relaxed">Logistique, Courrier, Véhicules...</p>
                <div class="mt-4 flex items-center text-emerald-600 dark:text-emerald-400 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity transform translate-y-2 group-hover:translate-y-0">
                    Faire une demande <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
                </div>
            </a>

            <!-- Carte FCPI (Agent Recruté) - PIÈGE CATDANCE -->
            <a href="{{ url_for('fcpi.check_access') }}" class="card-service bg-white dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 group cursor-pointer relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i data-lucide="user-plus" class="w-24 h-24 text-pink-600"></i>
                </div>
                <div class="w-14 h-14 bg-pink-50 dark:bg-pink-900/30 rounded-2xl flex items-center justify-center mb-4 text-pink-600 dark:text-pink-400 group-hover:bg-pink-600 group-hover:text-white transition-colors">
                    <i data-lucide="user-plus" class="w-7 h-7"></i>
                </div>
                <h3 class="text-xl font-black text-slate-800 dark:text-white mb-1">Agent Recruté (FCPI)</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-medium leading-relaxed">Création de poste, arrivées...</p>
                <div class="mt-4 flex items-center gap-2">
                    <span class="bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 text-[10px] font-bold px-2 py-1 rounded border border-slate-200 dark:border-slate-600 uppercase">
                        Manager Only
                    </span>
                </div>
            </a>

        </div>


        <!-- Section "Mes dernières demandes" -->
        <div class="max-w-4xl mx-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <i data-lucide="history" class="text-slate-400"></i> Mes dernières demandes
                </h2>
                <a href="{{ url_for('main.my_history') }}" class="text-sm font-bold text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition">Voir tout l'historique -></a>
            </div>

            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                <table class="w-full text-left text-sm text-slate-600 dark:text-slate-300">
                    <thead class="bg-slate-50 dark:bg-slate-700 border-b border-slate-100 dark:border-slate-600 text-slate-500 dark:text-slate-300 uppercase font-bold text-xs tracking-wider">
                        <tr>
                            <th class="px-6 py-4">Service</th>
                            <th class="px-6 py-4">Sujet</th>
                            <th class="px-6 py-4">Statut</th>
                            <th class="px-6 py-4">Date</th>
                            <th class="px-6 py-4 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                        {% for ticket in tickets %}
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                            <td class="px-6 py-4"><span class="font-black text-[10px] uppercase text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-900 px-2 py-1 rounded">{{ ticket.target_service.value }}</span></td>
                            <td class="px-6 py-4 font-bold text-slate-900 dark:text-white">{{ ticket.title }}</td>
                            <td class="px-6 py-4">
                                <span class="inline-block px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest 
                                    {% if 'VALIDATION' in ticket.status.value %}bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300
                                    {% elif 'COURS' in ticket.status.value %}bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300
                                    {% elif 'TERMINE' in ticket.status.value %}bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300
                                    {% else %}bg-slate-100 text-slate-500 dark:bg-slate-700 dark:text-slate-400{% endif %}">
                                    {{ ticket.status.value }}
                                </span>
                            </td>
                            <td class="px-6 py-4 font-mono text-xs">{{ ticket.created_at.strftime('%d/%m/%Y') }}</td>
                            <td class="px-6 py-4 text-right">
                                <a href="{{ url_for('tickets.view_ticket', ticket_uid=ticket.uid_public) }}" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-bold text-xs uppercase">Voir</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="p-8 text-center text-slate-400 dark:text-slate-500 italic font-bold">
                                Vous n'avez pas encore fait de demande.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();

        // Script pour gérer le Dark Mode localement si non hérité de base.html
        const toggleBtn = document.getElementById('theme-toggle-portal');
        if (toggleBtn) {
            // Initialisation
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            // Click Handler
            toggleBtn.addEventListener('click', () => {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.theme = 'light';
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.theme = 'dark';
                }
            });
        }
    </script>
</body>
</html>



================================================
FILE: app/templates/prets.html
================================================
{% extends "base.html" %}

{% block content %}
<div class="flex flex-col gap-8 p-6 bg-slate-50 dark:bg-slate-950 min-h-screen transition-colors duration-300">

    <!-- En-tête -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-3xl font-black text-slate-900 dark:text-white uppercase tracking-tight">Gestion des Prêts</h1>
            <p class="text-slate-500 dark:text-slate-400 font-bold text-xs mt-1 uppercase tracking-wide">Suivi des sorties de matériel</p>
        </div>
        <div class="flex gap-3 flex-wrap">
            <a href="{{ url_for('tickets.solver_dashboard') }}" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 px-4 py-3 rounded-xl font-black text-xs uppercase shadow-sm flex items-center gap-2 transition">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Retour Dashboard
            </a>
            
            <!-- BOUTONS IMPORT / EXPORT -->
            <a href="{{ url_for('prets.export_prets') }}" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-3 rounded-xl font-black text-xs uppercase shadow-lg flex items-center gap-2 transition">
                <i data-lucide="download" class="w-4 h-4"></i> Exporter
            </a>
            <button onclick="document.getElementById('importPretModal').classList.remove('hidden')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-3 rounded-xl font-black text-xs uppercase shadow-lg flex items-center gap-2 transition">
                <i data-lucide="upload" class="w-4 h-4"></i> Importer
            </button>

            <button onclick="document.getElementById('newPretModal').classList.remove('hidden')" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg flex items-center gap-2 transition hover:-translate-y-1">
                <i data-lucide="plus-circle" class="w-4 h-4"></i> Nouveau Prêt
            </button>
        </div>
    </div>

    <!-- Stats Rapides -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm flex items-center justify-between">
            <div>
                <p class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wide">En cours</p>
                <p class="text-3xl font-black text-blue-600 dark:text-blue-400 mt-1">
                    {% set ns = namespace(count=0) %}
                    {% for p in prets if p.statut_dossier == 'En cours' %}{% set ns.count = ns.count + 1 %}{% endfor %}
                    {{ ns.count }}
                </p>
            </div>
            <div class="p-3 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-xl"><i data-lucide="clock" class="w-6 h-6"></i></div>
        </div>
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm flex items-center justify-between">
            <div>
                <p class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wide">Stock Disponible</p>
                <p class="text-3xl font-black text-emerald-600 dark:text-emerald-400 mt-1">{{ materiels|length }}</p>
            </div>
            <div class="p-3 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-xl"><i data-lucide="box" class="w-6 h-6"></i></div>
        </div>
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm flex items-center justify-between">
            <div>
                <p class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wide">Historique Total</p>
                <p class="text-3xl font-black text-slate-700 dark:text-white mt-1">{{ prets|length }}</p>
            </div>
            <div class="p-3 bg-slate-50 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-xl"><i data-lucide="archive" class="w-6 h-6"></i></div>
        </div>
    </div>

    <!-- Tableau -->
    <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-slate-600 dark:text-slate-300">
                <thead class="bg-slate-50 dark:bg-slate-700 border-b border-slate-200 dark:border-slate-600">
                    <tr class="text-slate-500 dark:text-slate-400 font-black uppercase text-[10px] tracking-wider">
                        <th class="px-6 py-4">Matériel</th>
                        <th class="px-6 py-4">Emprunteur</th>
                        <th class="px-6 py-4">Sortie</th>
                        <th class="px-6 py-4">Retour Prévu</th>
                        <th class="px-6 py-4 text-center">État</th>
                        <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                    {% for p in prets %}
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                        <td class="px-6 py-4">
                            <div class="font-bold text-slate-800 dark:text-white">{{ p.materiel.modele }}</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400 font-mono">{{ p.materiel.sn }}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-slate-700 dark:text-slate-200">{{ p.nom_emprunteur }} {{ p.prenom_emprunteur }}</div>
                            <div class="text-xs text-slate-400 dark:text-slate-500">{{ p.service_emprunteur }}</div>
                        </td>
                        <td class="px-6 py-4 text-slate-600 dark:text-slate-400 font-mono text-xs">{{ p.date_sortie.strftime('%d/%m/%Y') }}</td>
                        <td class="px-6 py-4 text-slate-600 dark:text-slate-400 font-mono text-xs">
                            {% if p.date_retour_prevue %}
                                {{ p.date_retour_prevue.strftime('%d/%m/%Y') }}
                            {% else %}
                                <span class="text-slate-300 dark:text-slate-600">-</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-center">
                            {% if p.statut_dossier == 'En cours' %}
                            <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-[10px] font-black uppercase tracking-wide border border-blue-100 dark:border-blue-800">
                                <span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span> Sorti
                            </span>
                            {% else %}
                            <span class="inline-block px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 text-[10px] font-black uppercase tracking-wide border border-slate-200 dark:border-slate-600">
                                Terminé
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-right flex justify-end gap-2">
                            {% if p.statut_dossier == 'En cours' %}
                            <button onclick="openRetourModal('{{ p.id }}', '{{ p.materiel.modele }}', '{{ p.nom_emprunteur }}')" class="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 p-2 rounded-lg hover:bg-emerald-200 dark:hover:bg-emerald-800 transition" title="Valider Retour">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </button>
                            {% endif %}
                            <a href="{{ url_for('prets.delete_pret', id=p.id) }}" class="bg-red-50 dark:bg-red-900/30 text-red-500 dark:text-red-400 p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-800 transition" onclick="return confirm('Supprimer ce dossier ?')" title="Supprimer">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="p-12 text-center text-slate-400 dark:text-slate-500 italic font-medium">
                            Aucun prêt enregistré pour le moment.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL IMPORT -->
<div id="importPretModal" class="hidden fixed inset-0 bg-slate-900/60 dark:bg-slate-950/80 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl w-full max-w-md shadow-2xl relative border border-slate-100 dark:border-slate-700">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-slate-800 dark:text-white">Importer des Prêts</h3>
            <button onclick="document.getElementById('importPretModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <form action="{{ url_for('prets.import_prets') }}" method="POST" enctype="multipart/form-data" class="space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-xl border border-blue-100 dark:border-blue-900/50 text-xs text-blue-700 dark:text-blue-300">
                <p class="font-bold mb-1">Format Excel (.xlsx) attendu :</p>
                <ul class="list-disc pl-4 space-y-1">
                    <li>Colonne <b>SN</b> (Numéro Série, doit exister en stock)</li>
                    <li>Colonnes <b>Nom</b>, <b>Prenom</b>, <b>Service</b></li>
                    <li>Colonne <b>Date_Sortie</b> (Optionnel)</li>
                </ul>
            </div>
            <input type="file" name="file" accept=".xlsx" class="input-field bg-white dark:bg-slate-700" required>
            <button type="submit" class="w-full bg-indigo-600 text-white font-black py-3 rounded-xl hover:bg-indigo-500 transition shadow-lg text-xs uppercase tracking-widest">
                Lancer l'import
            </button>
        </form>
    </div>
</div>

<!-- MODAL NOUVEAU PRET -->
<div id="newPretModal" class="hidden fixed inset-0 bg-slate-900/60 dark:bg-slate-950/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100 max-h-[90vh] overflow-y-auto custom-scroll border border-slate-100 dark:border-slate-700">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-slate-800 dark:text-white">Nouveau Prêt</h3>
            <button onclick="document.getElementById('newPretModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        
        <form method="POST" class="space-y-4">
            <input type="hidden" name="action_pret" value="create">
            
            <div>
                <label class="label-tiny">Matériel Disponible</label>
                <select name="materiel_id" class="input-field" required>
                    <option value="">-- Choisir --</option>
                    {% for m in materiels %}
                    <option value="{{ m.id }}">{{ m.modele }} ({{ m.sn }})</option>
                    {% endfor %}
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div><label class="label-tiny">Nom</label><input type="text" name="nom" class="input-field" required></div>
                <div><label class="label-tiny">Prénom</label><input type="text" name="prenom" class="input-field" required></div>
            </div>
            
            <div><label class="label-tiny">Service</label><input type="text" name="service" class="input-field" required></div>
            
            <div>
                <label class="label-tiny">Type de Prêt</label>
                <select name="type_pret" class="input-field">
                    <option value="Temporaire">Temporaire (Dépannage)</option>
                    <option value="Permanent">Permanent (Dotation)</option>
                </select>
            </div>

            <div>
                <label class="label-tiny">Date de Sortie (Optionnel)</label>
                <input type="datetime-local" name="custom_date_sortie" class="input-field">
            </div>

            <div>
                <label class="label-tiny">Accessoires fournis</label>
                <div class="flex flex-wrap gap-3 mt-2">
                    <label class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400"><input type="checkbox" name="accessoires" value="Chargeur" class="rounded text-blue-600 bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600"> Chargeur</label>
                    <label class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400"><input type="checkbox" name="accessoires" value="Souris" class="rounded text-blue-600 bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600"> Souris</label>
                    <label class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400"><input type="checkbox" name="accessoires" value="Sacoche" class="rounded text-blue-600 bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600"> Sacoche</label>
                </div>
            </div>

            <div class="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                <label class="label-tiny mb-2">État Sortie</label>
                <div class="grid grid-cols-3 gap-2">
                    <select name="etat_ecran" class="bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded p-1 text-xs text-slate-700 dark:text-slate-200"><option value="Bon">Écran OK</option><option value="Rayé">Rayé</option></select>
                    <select name="etat_clavier" class="bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded p-1 text-xs text-slate-700 dark:text-slate-200"><option value="Bon">Clavier OK</option><option value="Usé">Usé</option></select>
                    <select name="etat_coque" class="bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded p-1 text-xs text-slate-700 dark:text-slate-200"><option value="Bon">Coque OK</option><option value="Abîmé">Abîmé</option></select>
                </div>
            </div>

            <button type="submit" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl hover:bg-blue-500 transition shadow-lg text-xs uppercase tracking-widest mt-2">
                Valider la sortie
            </button>
        </form>
    </div>
</div>

<!-- MODAL RETOUR -->
<div id="retourModal" class="hidden fixed inset-0 bg-slate-900/60 dark:bg-slate-950/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100 border border-slate-100 dark:border-slate-700">
        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2">Retour Matériel</h3>
        <p id="retourInfoText" class="text-sm text-slate-500 dark:text-slate-400 mb-6"></p>
        
        <form id="retourForm" method="POST" class="space-y-4">
            <div>
                <label class="label-tiny">Date de Retour Réelle</label>
                <input type="datetime-local" name="custom_date_retour" class="input-field">
            </div>
            
            <div class="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                <label class="label-tiny mb-2">État Retour</label>
                <div class="grid grid-cols-3 gap-2">
                    <select name="etat_ecran_retour" class="bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded p-1 text-xs text-slate-700 dark:text-slate-200"><option value="Bon">Écran OK</option><option value="Rayé">Rayé</option><option value="Cassé">Cassé</option></select>
                    <select name="etat_clavier_retour" class="bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded p-1 text-xs text-slate-700 dark:text-slate-200"><option value="Bon">Clavier OK</option><option value="HS">HS</option></select>
                    <select name="etat_coque_retour" class="bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded p-1 text-xs text-slate-700 dark:text-slate-200"><option value="Bon">Coque OK</option><option value="Abîmé">Abîmé</option></select>
                </div>
            </div>

            <button type="submit" class="w-full bg-emerald-600 text-white font-black py-3 rounded-xl hover:bg-emerald-500 transition shadow-lg text-xs uppercase tracking-widest mt-2">
                Confirmer le retour
            </button>
        </form>
    </div>
</div>

<script>
    lucide.createIcons();

    function openRetourModal(id, materiel, emprunteur) {
        const modal = document.getElementById('retourModal');
        const form = document.getElementById('retourForm');
        const info = document.getElementById('retourInfoText');
        
        info.innerText = `${materiel} - Emprunté par ${emprunteur}`;
        form.action = `/prets/pret/${id}/retour`; 
        form.action = `/pret/${id}/retour`; // Fallback route

        modal.classList.remove('hidden');
    }
</script>

<style>
    .label-tiny { font-size: 10px; font-weight: 900; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.1em; margin-bottom: 4px; display: block; } 
    /* Dark mode override */
    .dark .label-tiny { color: #94a3b8; }

    .input-field { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 0.75rem; border-radius: 0.5rem; outline: none; transition: all 0.2s; color: #1e293b; } 
    .input-field:focus { border-color: #3b82f6; background-color: white; }

    /* Dark Mode Inputs */
    .dark .input-field { background-color: #1e293b; border-color: #334155; color: #f1f5f9; }
    .dark .input-field:focus { border-color: #60a5fa; background-color: #0f172a; }
</style>
{% endblock %}



================================================
FILE: app/templates/tickets.html
================================================
{% extends "base.html" %} <!-- Assurez-vous d'avoir un base.html, sinon retirez cette ligne -->

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Nouvelle Demande - {{ service.value }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-6">

    <div class="bg-white max-w-2xl w-full rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        
        <!-- Header coloré selon le service -->
        <div class="{% if service_name == 'INFO' %}bg-blue-600{% elif service_name == 'DAF' %}bg-purple-600{% elif service_name == 'TECH' %}bg-orange-600{% else %}bg-emerald-600{% endif %} p-6 text-white">
            <h1 class="text-2xl font-bold">Nouvelle Demande : {{ service.value }}</h1>
            <p class="text-white/80 text-sm mt-1">Remplissez ce formulaire pour soumettre votre demande.</p>
        </div>

        <form method="POST" class="p-8 space-y-6">
            
            <!-- Titre -->
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Objet de la demande</label>
                <input type="text" name="title" required 
                    class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition"
                    placeholder="Ex: Demande de nouvel écran...">
            </div>

            <!-- Champ Spécifique Informatique -->
            {% if service_name == 'INFO' %}
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Nom de la machine (Hostname)</label>
                <div class="flex gap-2">
                    <input type="text" name="hostname" id="hostname" 
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg font-mono text-sm"
                        placeholder="DESKTOP-XXXX">
                    <button type="button" onclick="alert('Fonction auto-detect à venir via script JS')" class="px-4 py-2 bg-slate-200 text-slate-600 rounded-lg text-xs font-bold uppercase">Detect</button>
                </div>
                <p class="text-xs text-slate-400 mt-1">Laissez vide si non applicable.</p>
            </div>
            {% endif %}

            <!-- Description -->
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Description détaillée</label>
                <textarea name="description" rows="5" required 
                    class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition"
                    placeholder="Décrivez votre besoin ou le problème rencontré..."></textarea>
            </div>

            <!-- Actions -->
            <div class="flex items-center justify-end gap-4 pt-4 border-t border-slate-100">
                <a href="{{ url_for('main.user_portal') }}" class="text-slate-500 font-medium hover:text-slate-700">Annuler</a>
                <button type="submit" class="bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 px-8 rounded-xl transition shadow-lg">
                    Envoyer la demande
                </button>
            </div>

        </form>
    </div>

</body>
</html>



================================================
FILE: app/templates/auth/login.html
================================================
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion - Intranet</title>
    <!-- Tailwind CSS (Local ou CDN pour le dev) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-slate-900 h-screen flex items-center justify-center">

    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
        <div class="text-center mb-8">
            <!-- REMPLACEMENT DU TITRE PAR UN LOGO -->
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo Entreprise" class="h-32 mx-auto mb-4 object-contain">
            <!-- Fallback text si l'image n'existe pas encore -->
            <!-- <h1 class="text-3xl font-bold text-slate-800">Intranet <span class="text-blue-600">Corp</span></h1> -->
            <p class="text-slate-500 mt-2">Portail unifié des services</p>
        </div>

        <!-- Messages Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-3 rounded-lg text-sm font-medium 
                        {% if category == 'success' %}bg-green-100 text-green-700
                        {% elif category == 'danger' %}bg-red-100 text-red-700
                        {% else %}bg-blue-100 text-blue-700{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('auth.login') }}" class="space-y-6">
            <div>
                <label for="username" class="block text-sm font-medium text-slate-700 mb-1">Identifiant Windows</label>
                <input type="text" name="username" id="username" required 
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                    placeholder="ex: astraore">
            </div>

            <div>
                <label for="password" class="block text-sm font-medium text-slate-700 mb-1">Mot de passe</label>
                <input type="password" name="password" id="password" required 
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                    placeholder="••••••••">
            </div>

            <button type="submit" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-200 transform hover:scale-[1.02]">
                Se connecter
            </button>
        </form>

        <!-- Aide pour le développeur (Visible uniquement en DEBUG ou pour tester) 
        <div class="mt-8 pt-6 border-t border-slate-100 text-center">
            <p class="text-xs text-slate-400 uppercase font-bold mb-3">Comptes de Test</p>
            <div class="flex flex-wrap justify-center gap-2">
                <span class="px-2 py-1 bg-slate-100 text-slate-600 text-xs rounded border cursor-pointer hover:bg-slate-200" onclick="fillLogin('user')">user</span>
                <span class="px-2 py-1 bg-slate-100 text-slate-600 text-xs rounded border cursor-pointer hover:bg-slate-200" onclick="fillLogin('manager')">manager</span>
                <span class="px-2 py-1 bg-slate-100 text-slate-600 text-xs rounded border cursor-pointer hover:bg-slate-200" onclick="fillLogin('admin')">admin</span>
                <span class="px-2 py-1 bg-blue-50 text-blue-600 text-xs rounded border border-blue-100 cursor-pointer hover:bg-blue-100" onclick="fillLogin('tech_info')">tech_info</span>
                <span class="px-2 py-1 bg-purple-50 text-purple-600 text-xs rounded border border-purple-100 cursor-pointer hover:bg-purple-100" onclick="fillLogin('tech_daf')">tech_daf</span>
            </div>
        </div>
    </div> --->

    <script>
        function fillLogin(user) {
            document.getElementById('username').value = user;
            document.getElementById('password').value = 'password';
        }
    </script>
</body>
</html>



================================================
FILE: app/templates/emails/notification.html
================================================
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: sans-serif; color: #1e293b; }
        .box { border: 1px solid #e2e8f0; padding: 20px; border-radius: 8px; max-width: 600px; margin: 0 auto; }
        .header { background-color: #0f172a; color: white; padding: 15px; border-radius: 8px 8px 0 0; text-align: center; }
        .content { padding: 20px; }
        .btn { display: inline-block; background-color: #2563eb; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin-top: 15px; }
        .info { background: #f1f5f9; padding: 10px; border-left: 4px solid #2563eb; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="box">
        <div class="header">
            <h2>Notification Intranet</h2>
        </div>
        <div class="content">
            <p>Bonjour <strong>{{ user.fullname }}</strong>,</p>
            <p>{{ message }}</p>
            
            {% if ticket %}
            <div class="info">
                <strong>Référence :</strong> {{ ticket.uid_public }}<br>
                <strong>Sujet :</strong> {{ ticket.title }}<br>
                <strong>Service :</strong> {{ ticket.target_service.value }}
            </div>
            {% endif %}

            <p>Connectez-vous pour traiter cette demande.</p>
            <a href="{{ link }}" class="btn">Accéder à l'Intranet</a>
        </div>
    </div>
</body>
</html>



================================================
FILE: app/templates/errors/catdance.html
================================================
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accès Refusé - Intranet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
    <style>
        .gif-container {
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            margin-bottom: 2rem;
            margin: 0 auto 2rem auto;
            max-width: 45%;
        }
    </style>

<body class="bg-slate-900 h-screen w-full flex flex-col items-center justify-center text-center overflow-hidden relative">
    <!-- Background Pattern -->
    <div class="absolute inset-0 opacity-10 pointer-events-none" 
         style="background-image: radial-gradient(#4f46e5 1px, transparent 1px); background-size: 30px 30px;">
    </div>

    <div class="z-10 max-w-2xl px-6">
        <h1 class="text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600 mb-4 animate-pulse">
            403
        </h1>
        <h2 class="text-2xl md:text-3xl font-bold text-white mb-8">
            Accès Interdit !
        </h2>

        <!-- Le GIF Catdance -->
        <div class="gif-container">
            <img src="{{ url_for('static', filename='img/good-morning.gif') }}" alt="Accès Refusé" class="w-full h-auto object-cover">
            <script type="text/javascript" async src="https://tenor.com/embed.js"></script>
        </div>

        <p class="text-slate-400 text-lg mb-8">
            Oups ! Vous n'avez pas les droits pour voir cette <span class="font-mono text-blue-400 font-bold">page</span>.<br>
            Contacter le service informatique.
            <br>
            <p class="text-white text-s mb-8">  PS : on ne vous aidera pas. </p>
        </p>
        <a href="{{ url_for('auth.login') }}" class="inline-flex items-center gap-2 px-8 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-full transition transform hover:scale-105 shadow-lg shadow-blue-500/30">
            <span>Retour à la connexion</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14" />
            </svg>
        </a>
    </div>

</body>
</html>



================================================
FILE: app/templates/fcpi/new_fcpi.html
================================================
{% extends "base.html" %}

{% block content %}
<div class="flex justify-center items-start min-h-[80vh] pt-10 pb-20 px-4">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 w-full max-w-4xl relative transition-colors duration-300">
        
        <a href="{{ url_for('main.user_portal') }}" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition">
            <i data-lucide="x" class="w-6 h-6"></i>
        </a>

        <div class="text-center mb-10">
            <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 bg-pink-50 dark:bg-pink-900/30 text-pink-600 dark:text-pink-400">
                <i data-lucide="user-plus" class="w-8 h-8"></i>
            </div>
            <h1 class="text-3xl font-black text-slate-800 dark:text-white tracking-tight mb-2">Fiche Agent Recruté (FCPI)</h1>
            <p class="text-slate-500 dark:text-slate-400">Formulaire unique pour toutes les démarches d'arrivée.</p>
        </div>

        <form method="POST" enctype="multipart/form-data" class="space-y-8">
            
            <!-- 1. DONNÉES AGENT -->
            <div class="bg-slate-50 dark:bg-slate-900/50 p-6 rounded-2xl border border-slate-100 dark:border-slate-700">
                <h2 class="text-sm font-black text-blue-600 dark:text-blue-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                    <i data-lucide="user" class="w-4 h-4"></i> Données de l'agent
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="label-tiny">Date d'entrée</label><input type="date" name="date_entree" class="input-field" required></div>
                    <div><label class="label-tiny">Unité Fonctionnelle (UF)</label><input type="text" name="uf" class="input-field" required></div>
                    <div><label class="label-tiny">Nom</label><input type="text" name="nom" class="input-field uppercase" required></div>
                    <div><label class="label-tiny">Prénom</label><input type="text" name="prenom" class="input-field capitalize" required></div>
                    <div><label class="label-tiny">Fonction</label><input type="text" name="fonction" class="input-field" required></div>
                    <div><label class="label-tiny">Service</label><input type="text" name="service" class="input-field" required></div>
                </div>
            </div>

            <!-- 2. DRH -->
            <div class="bg-slate-50 dark:bg-slate-900/50 p-6 rounded-2xl border border-slate-100 dark:border-slate-700">
                <h2 class="text-sm font-black text-purple-600 dark:text-purple-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                    <i data-lucide="briefcase" class="w-4 h-4"></i> Données RH
                </h2>
                
                <!-- Contractuel Toggle -->
                <div class="mb-6">
                    <label class="label-tiny">Statut Contractuel ?</label>
                    <div class="flex gap-4 mt-2">
                        <label class="flex items-center gap-2 cursor-pointer p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600">
                            <input type="radio" name="contractuel" value="oui" onclick="toggleContract(false)" class="text-purple-600"> 
                            <span class="text-sm font-bold text-slate-700 dark:text-slate-200">Oui</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600">
                            <input type="radio" name="contractuel" value="non" onclick="toggleContract(true)" checked class="text-purple-600"> 
                            <span class="text-sm font-bold text-slate-700 dark:text-slate-200">Non (Titulaire)</span>
                        </label>
                    </div>
                </div>

                <!-- Champs Contractuels (Cachés si Non) -->
                <div id="contract-fields" class="hidden grid grid-cols-2 gap-4 mb-6 bg-purple-50 dark:bg-purple-900/20 p-4 rounded-xl border border-purple-100 dark:border-purple-800">
                    <div><label class="label-tiny text-purple-600">Date début contrat</label><input type="date" name="date_debut_contrat" class="input-field"></div>
                    <div><label class="label-tiny text-purple-600">Date fin contrat</label><input type="date" name="date_fin_contrat" class="input-field"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="label-tiny">Condition Recrutement</label>
                        <select name="condition" class="input-field cursor-pointer">
                            <option value="Jour">Jour</option>
                            <option value="Nuit">Nuit</option>
                            <option value="Week-end">Week-end</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-tiny">Motif Recrutement</label>
                        <select name="motif" class="input-field cursor-pointer">
                            <option value="Vacant">Poste Vacant</option>
                            <option value="Remplacement">Remplacement</option>
                            <option value="Surcroit">Surcroît d'activité</option>
                        </select>
                    </div>
                </div>

                <div class="mt-6">
                    <label class="label-tiny">Temps de travail</label>
                    <div class="flex gap-4 items-center">
                        <select name="temps_travail" id="tempsSelect" onchange="togglePercent()" class="input-field cursor-pointer flex-1">
                            <option value="Plein">Temps Plein</option>
                            <option value="Partiel">Temps Partiel</option>
                            <option value="Non Complet">Temps Non Complet</option>
                        </select>
                        <div id="percentField" class="hidden w-1/3">
                            <input type="text" name="pourcentage" class="input-field" placeholder="%">
                        </div>
                    </div>
                </div>

                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="label-tiny">CV (PDF)</label>
                        <input type="file" name="cv_file" accept=".pdf" class="input-field bg-white dark:bg-slate-800 text-xs">
                    </div>
                    <div>
                        <label class="label-tiny">Fiche de Poste (PDF)</label>
                        <input type="file" name="fiche_poste_file" accept=".pdf" class="input-field bg-white dark:bg-slate-800 text-xs">
                    </div>
                </div>
                
                <div class="mt-6 p-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" name="simulation" value="oui" class="w-5 h-5 rounded text-purple-600 border-slate-300">
                        <span class="text-sm font-bold text-slate-700 dark:text-slate-200">Demander une simulation de salaire</span>
                    </label>
                </div>
            </div>

            <!-- 3. IMAGO -->
            <div class="bg-slate-50 dark:bg-slate-900/50 p-6 rounded-2xl border border-slate-100 dark:border-slate-700">
                <h2 class="text-sm font-black text-indigo-600 dark:text-indigo-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                    <i data-lucide="users" class="w-4 h-4"></i> Imago
                </h2>
                
                <label class="flex items-center gap-3 font-bold mb-4 cursor-pointer p-4 bg-white dark:bg-slate-800 rounded-xl border border-indigo-100 dark:border-indigo-900/50 hover:border-indigo-300 transition">
                    <input type="checkbox" name="imago" value="oui" onchange="document.getElementById('imagoField').classList.toggle('hidden')" class="w-5 h-5 text-indigo-600 rounded">
                    <span class="text-slate-800 dark:text-white">Besoin d'un compte Imago ?</span>
                </label>
                
                <div id="imagoField" class="hidden mt-4 animate-fadeIn">
                    <label class="label-tiny text-indigo-600 dark:text-indigo-400">Mobilité (Sites d'intervention)</label>
                    <input type="text" name="imago_mobilite" class="input-field" placeholder="Ex: Site A, Site B...">
                </div>
            </div>

            <!-- 4. INFORMATIQUE -->
            <div class="bg-slate-50 dark:bg-slate-900/50 p-6 rounded-2xl border border-slate-100 dark:border-slate-700">
                <h2 class="text-sm font-black text-blue-600 dark:text-blue-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                    <i data-lucide="monitor" class="w-4 h-4"></i> Informatique
                </h2>
                
                <label class="label-tiny mb-3">Matériel demandé</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <label class="flex items-center gap-2 p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600 cursor-pointer hover:border-blue-400 transition">
                        <input type="checkbox" name="materiel_type" value="Fixe" class="text-blue-600 rounded"> 
                        <span class="text-xs font-bold text-slate-600 dark:text-slate-300">Tél. Fixe</span>
                    </label>
                    <label class="flex items-center gap-2 p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600 cursor-pointer hover:border-blue-400 transition">
                        <input type="checkbox" name="materiel_type" value="Portable" class="text-blue-600 rounded"> 
                        <span class="text-xs font-bold text-slate-600 dark:text-slate-300">Tél. Portable</span>
                    </label>
                    <label class="flex items-center gap-2 p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600 cursor-pointer hover:border-blue-400 transition">
                        <input type="checkbox" name="materiel_type" value="UC" class="text-blue-600 rounded"> 
                        <span class="text-xs font-bold text-slate-600 dark:text-slate-300">PC Fixe</span>
                    </label>
                    <label class="flex items-center gap-2 p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600 cursor-pointer hover:border-blue-400 transition">
                        <input type="checkbox" name="materiel_type" value="Laptop" class="text-blue-600 rounded"> 
                        <span class="text-xs font-bold text-slate-600 dark:text-slate-300">PC Portable</span>
                    </label>
                </div>
                
                <label class="label-tiny">Accès Informatiques spécifiques</label>
                <textarea name="acces_info" rows="3" class="input-field" placeholder="Logiciels métiers, dossiers réseaux, droits spécifiques..."></textarea>
            </div>

            <!-- 5. BADGE & CLEFS -->
            <div class="bg-slate-50 dark:bg-slate-900/50 p-6 rounded-2xl border border-slate-100 dark:border-slate-700">
                <h2 class="text-sm font-black text-orange-600 dark:text-orange-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                    <i data-lucide="key" class="w-4 h-4"></i> Badge & Sécurité
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="label-tiny">Photo du professionnel (Facultatif)</label>
                        <input type="file" name="photo_file" accept="image/*" class="input-field bg-white dark:bg-slate-800 text-xs">
                    </div>
                    <div>
                        <label class="label-tiny">Localisation du poste</label>
                        <input type="text" name="localisation" class="input-field" placeholder="Ex: Bureau 204, 2ème étage">
                    </div>
                </div>
                <div class="mt-6">
                    <label class="label-tiny">Commentaire Sécurité / Accès</label>
                    <textarea name="commentaire_secu" rows="2" class="input-field" placeholder="Besoins spécifiques en clés ou accès badge..."></textarea>
                </div>
            </div>

            <!-- SUBMIT -->
            <button type="submit" class="w-full bg-slate-900 hover:bg-slate-800 dark:bg-pink-600 dark:hover:bg-pink-500 text-white font-black py-4 rounded-xl transition shadow-lg text-sm uppercase tracking-widest flex items-center justify-center gap-2">
                Envoyer la demande de recrutement <i data-lucide="send" class="w-5 h-5"></i>
            </button>

        </form>
    </div>
</div>

<script>
    function toggleContract(isTitulaire) {
        const fields = document.getElementById('contract-fields');
        if (isTitulaire) fields.classList.add('hidden');
        else fields.classList.remove('hidden');
    }
    function togglePercent() {
        const val = document.getElementById('tempsSelect').value;
        const field = document.getElementById('percentField');
        if (val === 'Plein') field.classList.add('hidden');
        else field.classList.remove('hidden');
    }
    lucide.createIcons();
</script>

<style>
    .label-tiny { font-size: 10px; font-weight: 900; text-transform: uppercase; color: #64748b; margin-bottom: 6px; display: block; letter-spacing: 0.1em; }
    .dark .label-tiny { color: #94a3b8; }
    .input-field { width: 100%; padding: 0.75rem; border-radius: 0.75rem; border: 1px solid #e2e8f0; background: #fff; color: #1e293b; outline: none; transition: all 0.2s; }
    .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .dark .input-field { background: #1e293b; border-color: #334155; color: #f1f5f9; }
    .dark .input-field:focus { border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
</style>
{% endblock %}



================================================
FILE: app/templates/fcpi/view_fcpi.html
================================================
{% extends "base.html" %}

{% block content %}
<div class="max-w-5xl mx-auto py-10 px-4">
    
    <!-- HEADER -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-black text-slate-800 dark:text-white uppercase tracking-tight">Fiche FCPI <span class="text-pink-600">#{{ rec.uid_public }}</span></h1>
            <p class="text-slate-500 dark:text-slate-400 font-bold text-xs mt-1 uppercase tracking-wide">
                Agent: {{ rec.nom_agent }} {{ rec.prenom_agent }} • Service: {{ rec.service_agent }}
            </p>
        </div>
        
        <div class="flex gap-3">
             <a href="{{ url_for('main.user_portal') }}" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 px-4 py-2 rounded-xl font-black text-xs uppercase shadow-sm flex items-center gap-2">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Retour
            </a>
            
            {% if rec.is_fully_completed %}
            <span class="px-4 py-2 rounded-xl font-black text-xs uppercase tracking-widest flex items-center gap-2 bg-emerald-600 text-white shadow-lg shadow-emerald-200">
                <i data-lucide="check-check" class="w-4 h-4"></i> Dossier Clôturé
            </span>
            {% else %}
            <span class="px-4 py-2 rounded-xl font-black text-xs uppercase tracking-widest flex items-center gap-2
                {% if rec.status.value == 'VALIDATION_RH_MANAGER' %}bg-orange-100 text-orange-700
                {% elif rec.status.value == 'VALIDATION_RH_DIRECTEUR' %}bg-purple-100 text-purple-700
                {% elif rec.status.value == 'REFUSE' %}bg-red-100 text-red-700
                {% else %}bg-blue-100 text-blue-700{% endif %}">
                {{ rec.status.value }}
            </span>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- MAIN CONTENT (Recap) -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- INFO AGENT -->
            <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700 relative overflow-hidden">
                
                <!-- PHOTO EN HAUT À DROITE -->
                {% if rec.file_photo %}
                <div class="absolute top-6 right-6">
                    <a href="{{ url_for('static', filename='uploads/fcpi/' + rec.uid_public + '/' + rec.file_photo) }}" target="_blank">
                        <img src="{{ url_for('static', filename='uploads/fcpi/' + rec.uid_public + '/' + rec.file_photo) }}" 
                             alt="Photo Agent" 
                             class="w-24 h-24 rounded-xl object-cover border-4 border-slate-100 dark:border-slate-600 shadow-lg hover:scale-105 transition">
                    </a>
                </div>
                {% endif %}

                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Informations Agent</h3>
                <div class="grid grid-cols-2 gap-y-4 text-sm pr-28"> <!-- Padding Right pour la photo -->
                    <div><span class="block text-slate-400 text-xs">Nom Prénom</span><span class="font-bold text-slate-800 dark:text-white">{{ rec.nom_agent }} {{ rec.prenom_agent }}</span></div>
                    <div><span class="block text-slate-400 text-xs">Date d'entrée</span><span class="font-bold text-slate-800 dark:text-white">{{ rec.date_entree.strftime('%d/%m/%Y') }}</span></div>
                    <div><span class="block text-slate-400 text-xs">Fonction</span><span class="font-bold text-slate-800 dark:text-white">{{ rec.fonction }}</span></div>
                    <div><span class="block text-slate-400 text-xs">Unité (UF)</span><span class="font-bold text-slate-800 dark:text-white">{{ rec.uf_agent }}</span></div>
                </div>
            </div>

            <!-- INFO RH -->
            <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700">
                <h3 class="text-xs font-black text-purple-400 uppercase tracking-widest mb-4">Données RH</h3>
                <div class="grid grid-cols-2 gap-y-4 text-sm">
                    <div><span class="block text-slate-400 text-xs">Type Contrat</span>
                        <span class="font-bold text-slate-800 dark:text-white">
                            {% if rec.contractuel %}Contractuel ({{ rec.date_debut_contrat.strftime('%d/%m/%Y') }} - {{ rec.date_fin_contrat.strftime('%d/%m/%Y') }})
                            {% else %}Titulaire{% endif %}
                        </span>
                    </div>
                    <div><span class="block text-slate-400 text-xs">Temps de travail</span>
                        <span class="font-bold text-slate-800 dark:text-white">{{ rec.temps_travail }} {% if rec.pourcentage_temps %}({{ rec.pourcentage_temps }}){% endif %}</span>
                    </div>
                    <div><span class="block text-slate-400 text-xs">Condition</span><span class="font-bold text-slate-800 dark:text-white">{{ rec.condition_recrutement }}</span></div>
                    <div><span class="block text-slate-400 text-xs">Motif</span><span class="font-bold text-slate-800 dark:text-white">{{ rec.motif_recrutement }}</span></div>
                    
                    <!-- AJOUT SIMULATION SALAIRE -->
                    <div><span class="block text-slate-400 text-xs">Simulation Salaire</span>
                        <span class="font-bold {{ 'text-purple-600' if rec.simulation_salaire else 'text-slate-800 dark:text-white' }}">
                            {{ 'DEMANDÉE' if rec.simulation_salaire else 'Non demandée' }}
                        </span>
                    </div>
                </div>
                
                {% if rec.file_cv or rec.file_fiche_poste %}
                <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 flex gap-4">
                    {% if rec.file_cv %}
                    <a href="{{ url_for('static', filename='uploads/fcpi/' + rec.uid_public + '/' + rec.file_cv) }}" target="_blank" class="flex items-center gap-2 text-xs font-bold text-blue-600 hover:underline"><i data-lucide="file-text" class="w-4 h-4"></i> Voir CV</a>
                    {% endif %}
                    {% if rec.file_fiche_poste %}
                    <a href="{{ url_for('static', filename='uploads/fcpi/' + rec.uid_public + '/' + rec.file_fiche_poste) }}" target="_blank" class="flex items-center gap-2 text-xs font-bold text-blue-600 hover:underline"><i data-lucide="file-text" class="w-4 h-4"></i> Voir Fiche Poste</a>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- BESOINS LOGISTIQUES -->
            <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700">
                <h3 class="text-xs font-black text-blue-400 uppercase tracking-widest mb-4">Logistique & IT</h3>
                <div class="space-y-4 text-sm">
                    <div>
                        <span class="block text-slate-400 text-xs">Matériel demandé</span>
                        <div class="flex gap-2 mt-1">
                            {% for m in rec.materiels_demandes.split(',') %}
                            <span class="bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded text-xs font-bold">{{ m }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    <div>
                        <span class="block text-slate-400 text-xs">Accès IT</span>
                        <p class="font-medium text-slate-800 dark:text-white bg-slate-50 dark:bg-slate-900 p-3 rounded-lg mt-1">{{ rec.acces_informatique }}</p>
                    </div>
                    <div>
                        <span class="block text-slate-400 text-xs">Sécurité / Badge</span>
                        <p class="font-medium text-slate-800 dark:text-white mt-1">{{ rec.localisation_poste }} <span class="text-slate-400">-</span> {{ rec.commentaire_securite }}</p>
                    </div>
                    {% if rec.imago_active %}
                    <div class="bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-lg border border-indigo-100 dark:border-indigo-800">
                        <span class="font-bold text-indigo-600 dark:text-indigo-400 text-xs uppercase flex items-center gap-2"><i data-lucide="users" class="w-3 h-3"></i> Compte Imago Requis</span>
                        <p class="text-xs text-indigo-800 dark:text-indigo-200 mt-1">Mobilité : {{ rec.imago_mobilite }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

        </div>

        <!-- SIDEBAR ACTIONS & SUIVI -->
        <div class="space-y-6">
            
            <!-- BOX AUTEUR -->
            <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center font-black text-slate-500">{{ rec.author.fullname[0] }}</div>
                    <div>
                        <p class="text-sm font-bold text-slate-900 dark:text-white">{{ rec.author.fullname }}</p>
                        <p class="text-xs text-slate-400 uppercase font-bold">Demandeur</p>
                    </div>
                </div>
                <p class="text-xs text-slate-400 mt-2">Créé le {{ rec.created_at.strftime('%d/%m/%Y à %H:%M') }}</p>
            </div>

            <!-- BOX VALIDATION (Si pas encore dispatché) -->
            {% if rec.status.value != 'DISPATCHE_AUX_SERVICES' and rec.status.value != 'REFUSE' %}
            <div class="bg-slate-900 dark:bg-blue-900 p-6 rounded-3xl shadow-xl text-white">
                <h3 class="text-xs font-black text-slate-400 dark:text-blue-300 uppercase tracking-widest mb-4">Validation Requise</h3>
                
                <form action="{{ url_for('fcpi.validate_fcpi', id=rec.id, action='validate') }}" method="POST" class="mb-4">
                    <button type="submit" onclick="return confirm('Valider cette demande ?')" class="w-full bg-emerald-500 hover:bg-emerald-400 text-white font-black py-3 rounded-xl shadow-lg shadow-emerald-900/20 transition uppercase text-xs tracking-widest flex items-center justify-center gap-2">
                        <i data-lucide="check" class="w-4 h-4"></i> Valider
                    </button>
                    <p class="text-[10px] text-slate-400 mt-2 text-center">
                        {% if rec.status.value == 'VALIDATION_RH_MANAGER' %}Vous validez en tant que Manager RH.{% else %}Vous validez en tant que Directeur RH.{% endif %}
                    </p>
                </form>

                <div class="border-t border-slate-700 my-4"></div>

                <form action="{{ url_for('fcpi.validate_fcpi', id=rec.id, action='refuse') }}" method="POST">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Motif du refus</label>
                    <textarea name="refusal_comment" class="w-full bg-slate-800 text-white text-xs p-3 rounded-lg border border-slate-700 mb-3 focus:outline-none focus:border-red-500" rows="2" placeholder="Expliquez la raison..." required></textarea>
                    <button type="submit" onclick="return confirm('Refuser cette demande ?')" class="w-full bg-red-600 hover:bg-red-500 text-white font-black py-3 rounded-xl shadow-lg transition uppercase text-xs tracking-widest flex items-center justify-center gap-2">
                        <i data-lucide="x" class="w-4 h-4"></i> Refuser
                    </button>
                </form>
            </div>
            {% endif %}

            <!-- BOX STATUS FINAL : SUIVI DES SERVICES -->
            {% if rec.status.value == 'DISPATCHE_AUX_SERVICES' %}
            <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xs font-black text-slate-400 dark:text-slate-300 uppercase tracking-widest">Suivi des Services</h3>
                    {% if rec.is_fully_completed %}
                    <span class="text-xs font-bold text-emerald-600 flex items-center gap-1"><i data-lucide="check-circle" class="w-3 h-3"></i> 100%</span>
                    {% else %}
                    <span class="text-xs font-bold text-blue-600 flex items-center gap-1"><i data-lucide="loader" class="w-3 h-3 animate-spin"></i> En cours</span>
                    {% endif %}
                </div>
                
                <div class="space-y-3">
                    {% for t in rec.get_child_tickets_objects() %}
                    <div class="flex items-center justify-between p-3 rounded-xl border transition
                        {% if t.status.value == 'TERMINE' %}bg-emerald-50 dark:bg-emerald-900/10 border-emerald-100 dark:border-emerald-800
                        {% else %}bg-slate-50 dark:bg-slate-700 border-slate-100 dark:border-slate-600{% endif %}">
                        
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center
                                {% if t.target_service.value == 'INFORMATIQUE' %}bg-blue-100 text-blue-600
                                {% elif t.target_service.value == 'SECU' %}bg-orange-100 text-orange-600
                                {% elif t.target_service.value == 'DRH' %}bg-purple-100 text-purple-600
                                {% else %}bg-slate-200 text-slate-600{% endif %}">
                                {% if t.target_service.value == 'INFORMATIQUE' %}<i data-lucide="monitor" class="w-4 h-4"></i>
                                {% elif t.target_service.value == 'SECU' %}<i data-lucide="key" class="w-4 h-4"></i>
                                {% elif t.target_service.value == 'DRH' %}<i data-lucide="briefcase" class="w-4 h-4"></i>
                                {% else %}<i data-lucide="tag" class="w-4 h-4"></i>{% endif %}
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-700 dark:text-slate-200">{{ t.target_service.value }}</p>
                                <a href="{{ url_for('tickets.view_ticket', ticket_uid=t.uid_public) }}" class="text-[10px] text-slate-400 hover:text-blue-500 hover:underline">#{{ t.uid_public }}</a>
                            </div>
                        </div>

                        <div>
                            {% if t.status.value == 'TERMINE' %}
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-emerald-500 text-white rounded-full">
                                <i data-lucide="check" class="w-3 h-3"></i>
                            </span>
                            {% else %}
                            <span class="text-[10px] font-bold text-slate-500 bg-white px-2 py-1 rounded border border-slate-200">En cours</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if rec.is_fully_completed %}
                <div class="mt-4 p-3 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-800 dark:text-emerald-200 rounded-xl text-center text-xs font-bold">
                    Tous les services ont validé.<br>Recrutement clôturé.
                </div>
                {% endif %}
            </div>
            {% endif %}

             {% if rec.status.value == 'REFUSE' %}
            <div class="bg-red-50 dark:bg-red-900/20 p-6 rounded-3xl border border-red-100 dark:border-red-800">
                <div class="flex items-center gap-3 mb-2 text-red-700 dark:text-red-400">
                    <i data-lucide="x-circle" class="w-6 h-6"></i>
                    <span class="font-black text-sm uppercase">Demande Refusée</span>
                </div>
                <p class="text-xs text-red-800 dark:text-red-200 italic">"{{ rec.refusal_reason }}"</p>
            </div>
            {% endif %}

        </div>
    </div>
</div>
<script>lucide.createIcons();</script>
{% endblock %}



================================================
FILE: app/templates/tickets/detail.html
================================================
{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto py-6 dark:bg-slate-950 transition-colors duration-300">
    <!-- Header -->
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-black text-slate-900 dark:text-white uppercase tracking-tight">Détail Ticket</h1>
            <p class="text-slate-500 dark:text-slate-400 font-bold text-xs mt-1 uppercase tracking-wide">Référence : <span class="font-mono text-blue-600 dark:text-blue-400">{{ ticket.uid_public }}</span></p>
        </div>
        {% if 'SOLVER' in current_user.role|string or 'ADMIN' in current_user.role|string %}
            <a href="{{ url_for('tickets.solver_dashboard') }}" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 px-4 py-2 rounded-xl font-black text-xs uppercase shadow-sm flex items-center gap-2 transition"><i data-lucide="arrow-left" class="w-4 h-4"></i> Retour Dashboard</a>
        {% else %}
            <a href="{{ url_for('main.user_portal') }}" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 px-4 py-2 rounded-xl font-black text-xs uppercase shadow-sm flex items-center gap-2 transition"><i data-lucide="arrow-left" class="w-4 h-4"></i> Retour Portail</a>
        {% endif %}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl border border-slate-100 dark:border-slate-700">
                <!-- Info Ticket Standard -->
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg {% if ticket.target_service.value == 'DAF' %}bg-purple-600 text-white{% else %}bg-blue-600 text-white{% endif %}">
                        {% if ticket.target_service.value == 'DAF' %}<i data-lucide="banknote" class="w-6 h-6"></i>{% else %}<i data-lucide="monitor" class="w-6 h-6"></i>{% endif %}
                    </div>
                    <div>
                        <h2 class="text-sm font-black text-slate-900 dark:text-white uppercase tracking-wide">{{ ticket.target_service.value }}</h2>
                        <span class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">{{ ticket.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                    </div>
                </div>
                <h3 class="text-lg font-black text-slate-900 dark:text-white leading-tight uppercase mb-4">{{ ticket.title }}</h3>
                <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-200 dark:border-slate-600 text-sm font-medium text-slate-600 dark:text-slate-300 mb-6">{{ ticket.description }}</div>
                
                <!-- COORDONNÉES -->
                <div class="grid grid-cols-2 gap-4 mb-6 pb-6 border-b border-slate-100 dark:border-slate-700">
                     <div><span class="text-[9px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest block mb-1">Service Demandeur</span><span class="text-xs font-bold text-slate-700 dark:text-slate-200 flex items-center gap-1"><i data-lucide="building" class="w-3 h-3 text-slate-400 dark:text-slate-500"></i> {{ ticket.service_demandeur or '-' }}</span></div>
                     <div><span class="text-[9px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest block mb-1">Tél / Poste</span><span class="text-xs font-bold text-slate-700 dark:text-slate-200 flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3 text-slate-400 dark:text-slate-500"></i> {{ ticket.tel_demandeur or '-' }}</span></div>
                </div>

                <!-- SPECIFIQUE DAF (DÉTAILS) -->
                {% if ticket.target_service.value == 'DAF' %}
                <div class="space-y-4 mb-4 bg-purple-50 dark:bg-purple-900/20 p-4 rounded-xl border border-purple-100 dark:border-purple-800">
                    <div class="flex justify-between items-center text-xs pb-2 border-b border-purple-200 dark:border-purple-700"><span class="font-bold text-purple-400 uppercase text-[10px]">Livraison</span><span class="font-black text-purple-900 dark:text-purple-100">{{ ticket.daf_lieu_livraison }}</span></div>
                    <div class="space-y-2 pt-2">
                        <p class="text-[10px] font-black text-purple-400 uppercase tracking-widest">Fournisseur</p>
                        <div class="text-xs font-bold text-slate-700 dark:text-slate-300">
                            <p>{{ ticket.daf_fournisseur_nom }}</p>
                            <p class="font-normal text-slate-500 dark:text-slate-400">{{ ticket.daf_fournisseur_tel }}</p>
                            <p class="font-normal text-slate-500 dark:text-slate-400">{{ ticket.daf_fournisseur_email }}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Tableau des articles (JSON) -->
                {% set lignes = ticket.get_daf_lignes() %}
                {% if lignes %}
                <div class="border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden mb-4">
                    <table class="w-full text-[10px] text-slate-600 dark:text-slate-300">
                        <thead class="bg-slate-50 dark:bg-slate-700 font-black uppercase text-slate-500 dark:text-slate-400"><tr><th class="p-2 text-left">Désignation</th><th class="p-2 text-center">Qté</th><th class="p-2 text-right">Total</th></tr></thead>
                        <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                            {% for l in lignes %}
                            <tr><td class="p-2">{{ l.designation }}</td><td class="p-2 text-center">{{ l.qte }}</td><td class="p-2 text-right font-bold">{{ l.total }} €</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                <!-- Fichiers Devis -->
                {% set files = ticket.get_daf_files() %}
                {% if files %}
                <div class="space-y-2">
                    <p class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest">Devis Joints</p>
                    {% for f in files %}
                    <a href="{{ url_for('static', filename='uploads/tickets/' + ticket.uid_public + '/' + f) }}" target="_blank" class="block bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-2 rounded-lg text-xs font-bold text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-slate-600 flex items-center gap-2">
                        <i data-lucide="file-text" class="w-4 h-4"></i> {{ f }}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% endif %}

                <!-- (Autres blocs Info... inchangés) -->
                
                 <!-- Statut -->
                <div class="flex justify-between items-center border-t border-slate-100 dark:border-slate-700 pt-4 mt-6">
                    <span class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest">Statut</span>
                    <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300">{{ ticket.status.value }}</span>
                </div>
            </div>

            <!-- Intervenants & Actions (Inchangés) -->
             <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-8 h-8 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center text-slate-500 dark:text-slate-300 font-black text-xs">{{ ticket.author.username[0]|upper }}</div>
                    <div>
                        <p class="text-sm font-bold text-slate-900 dark:text-white">{{ ticket.author.fullname }}</p>
                        <p class="text-[9px] text-slate-400 dark:text-slate-500 font-bold uppercase tracking-wide">Demandeur</p>
                    </div>
                </div>
                {% if ticket.solver %}
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center text-blue-600 dark:text-blue-400 font-black text-xs">{{ ticket.solver.username[0]|upper }}</div>
                    <div>
                        <p class="text-sm font-bold text-slate-900 dark:text-white">{{ ticket.solver.fullname }}</p>
                        <p class="text-[9px] text-blue-500 dark:text-blue-400 font-bold uppercase tracking-wide">Technicien</p>
                    </div>
                </div>
                {% endif %}
            </div>
            
            {% if current_user.role.value == 'SOLVER' and ticket.status.value != 'TERMINE' %}
            <div class="bg-slate-900 dark:bg-slate-700 p-6 rounded-3xl text-white shadow-2xl">
                <h3 class="text-[10px] font-black text-slate-400 dark:text-slate-300 uppercase tracking-widest mb-4">Actions Rapides</h3>
                {% if not ticket.solver %}
                <a href="{{ url_for('tickets.take_ticket', ticket_id=ticket.id) }}" class="block w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-xl text-center font-black text-xs uppercase tracking-widest transition">Prendre en charge</a>
                {% else %}
                <a href="{{ url_for('tickets.close_ticket', ticket_id=ticket.id) }}" onclick="return confirm('Clôturer le ticket ?')" class="block w-full py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl text-center font-black text-xs uppercase tracking-widest transition">Terminer le ticket</a>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- CHAT (Inchangé) -->
        <div class="lg:col-span-2 flex flex-col h-[750px] bg-white dark:bg-slate-800 rounded-3xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden relative">
            <div class="p-5 border-b border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 flex justify-between items-center z-10">
                <h3 class="font-black text-slate-800 dark:text-white uppercase text-xs tracking-widest flex items-center gap-2"><i data-lucide="message-circle" class="w-4 h-4 text-blue-600 dark:text-blue-400"></i> Fil de discussion</h3>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50/50 dark:bg-slate-900/50" id="chatContainer">
                <div class="flex justify-center"><span class="bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-400 dark:text-slate-300 px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-widest shadow-sm">Ticket ouvert le {{ ticket.created_at.strftime('%d/%m à %H:%M') }}</span></div>
                {% for msg in ticket.messages %}
                <div class="flex flex-col {% if msg.author_id == current_user.id %}items-end{% else %}items-start{% endif %} animate-fadeIn">
                    <div class="max-w-[80%] {% if msg.author_id == current_user.id %}bg-slate-900 dark:bg-blue-600 text-white rounded-tr-none{% else %}bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 rounded-tl-none{% endif %} px-5 py-4 rounded-2xl shadow-sm">
                        <p class="text-sm font-bold">{{ msg.content }}</p>
                    </div>
                    <span class="text-[9px] font-black text-slate-400 dark:text-slate-500 mt-2 px-2 uppercase tracking-wide">{{ msg.author.fullname }} • {{ msg.timestamp.strftime('%H:%M') }}</span>
                </div>
                {% else %}
                <div class="flex flex-col items-center justify-center h-full opacity-40"><i data-lucide="message-square" class="w-12 h-12 text-slate-300 dark:text-slate-600 mb-2"></i><p class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">Aucun message</p></div>
                {% endfor %}
            </div>
            {% if ticket.status.value != 'TERMINE' and ticket.status.value != 'REFUSE' %}
            <div class="p-4 bg-white dark:bg-slate-800 border-t border-slate-100 dark:border-slate-700">
                <form method="POST" class="flex gap-3">
                    <input type="text" name="message" class="flex-1 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-5 py-4 text-sm font-bold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 focus:border-blue-500 outline-none transition" placeholder="Écrivez votre message..." autocomplete="off" required>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-xl transition shadow-lg shadow-blue-200 dark:shadow-none group"><i data-lucide="send" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i></button>
                </form>
            </div>
            {% else %}
            <div class="p-6 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-200 dark:border-slate-700 text-center"><p class="text-xs font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest flex items-center justify-center gap-2"><i data-lucide="lock" class="w-4 h-4"></i> Discussion close</p></div>
            {% endif %}
        </div>
    </div>
</div>
<script>
    lucide.createIcons();
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.scrollTop = chatContainer.scrollHeight;
</script>
{% endblock %}



================================================
FILE: app/templates/tickets/historique_tickets.html
================================================
{% extends "base.html" %}

{% block content %}
<div class="flex flex-col gap-8 p-6 bg-slate-50 dark:bg-slate-950 min-h-screen transition-colors duration-300">

    <!-- En-tête -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-3xl font-black text-slate-900 dark:text-white uppercase tracking-tight">Historique Tickets</h1>
            <p class="text-slate-500 dark:text-slate-400 font-bold text-xs mt-1 uppercase tracking-wide">Archives des demandes traitées</p>
        </div>
        <div class="flex gap-3 flex-wrap">
            <a href="{{ url_for('tickets.solver_dashboard') }}" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 px-4 py-3 rounded-xl font-black text-xs uppercase shadow-sm flex items-center gap-2 transition">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Retour Dashboard
            </a>
            <!-- BOUTON EXPORT -->
            <a href="{{ url_for('tickets.export_history') }}" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg flex items-center gap-2 transition">
                <i data-lucide="download" class="w-4 h-4"></i> Exporter Excel
            </a>
            <!-- BOUTON AJOUT MANUEL -->
            <button onclick="document.getElementById('manualTicketModal').classList.remove('hidden')" class="bg-slate-900 dark:bg-blue-600 hover:bg-slate-700 dark:hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg flex items-center gap-2 transition hover:-translate-y-1">
                <i data-lucide="edit" class="w-4 h-4"></i> Ajout Manuel
            </button>
        </div>
    </div>

    <!-- Tableau des Archives -->
    <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-slate-600 dark:text-slate-300">
                <thead class="bg-slate-50 dark:bg-slate-700 border-b border-slate-200 dark:border-slate-600">
                    <tr class="text-slate-500 dark:text-slate-400 font-black uppercase text-[10px] tracking-wider">
                        <th class="px-6 py-4">Réf</th>
                        <th class="px-6 py-4">Date</th>
                        <th class="px-6 py-4">Demandeur</th>
                        <th class="px-6 py-4">Service Cible</th>
                        <th class="px-6 py-4">Sujet</th>
                        <th class="px-6 py-4">Résolu par</th>
                        <th class="px-6 py-4 text-right">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 dark:divide-slate-700 font-medium text-slate-700 dark:text-slate-300">
                    {% for ticket in tickets %}
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                        <td class="px-6 py-4 font-mono text-xs text-slate-400 dark:text-slate-500">{{ ticket.uid_public }}</td>
                        <td class="px-6 py-4 text-xs">{{ ticket.created_at.strftime('%d/%m/%Y') }}</td>
                        <td class="px-6 py-4">
                            {% if ticket.new_user_fullname and 'Manuel' in ticket.description %}
                                <span class="text-blue-600 dark:text-blue-400 font-bold" title="Ajout Manuel">{{ ticket.new_user_fullname }}</span>
                            {% else %}
                                {{ ticket.author.fullname }}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <span class="bg-slate-100 dark:bg-slate-900 text-slate-500 dark:text-slate-400 text-[10px] font-black px-2 py-1 rounded uppercase">
                                {{ ticket.target_service.value }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-slate-800 dark:text-white">{{ ticket.title|truncate(40) }}</td>
                        <td class="px-6 py-4 text-xs text-slate-500 dark:text-slate-400">
                            {% if ticket.solver %}
                                {{ ticket.solver.fullname }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <a href="{{ url_for('tickets.view_ticket', ticket_uid=ticket.uid_public) }}" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-xs font-bold uppercase">Voir</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="p-12 text-center text-slate-400 dark:text-slate-500 italic">Aucune archive trouvée.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- MODAL AJOUT MANUEL -->
<div id="manualTicketModal" class="hidden fixed inset-0 bg-slate-900/60 dark:bg-slate-950/80 z-50 flex items-center justify-center backdrop-blur-sm transition-opacity">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl w-full max-w-lg m-4 shadow-2xl relative border border-slate-100 dark:border-slate-700">
        <button onclick="document.getElementById('manualTicketModal').classList.add('hidden')" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition">
            <i data-lucide="x" class="w-6 h-6"></i>
        </button>
        
        <div class="mb-6">
            <h3 class="text-2xl font-black text-slate-900 dark:text-white uppercase tracking-tight mb-1">Ajout Manuel</h3>
            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wide">Archivage d'une demande passée</p>
        </div>

        <form method="POST" class="space-y-4">
            <div>
                <label class="label-tiny">Titre</label>
                <input type="text" name="title" class="input-field" required placeholder="Ex: Remplacement souris">
            </div>

            <div>
                <label class="label-tiny">Nom du Demandeur (Texte libre)</label>
                <input type="text" name="user_name" class="input-field" required placeholder="Ex: M. Dupont (Compta)">
            </div>

            <div>
                <label class="label-tiny">Date de réception</label>
                <input type="datetime-local" name="date_creation" class="input-field">
            </div>

            <div>
                <label class="label-tiny">Description / Résolution</label>
                <textarea name="description" rows="3" class="input-field" placeholder="Détails du problème et de la solution apportée..."></textarea>
            </div>

            <button type="submit" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl hover:bg-blue-500 transition shadow-lg text-xs uppercase tracking-widest mt-2">
                Enregistrer & Archiver
            </button>
        </form>
    </div>
</div>

<script>
    lucide.createIcons();
</script>
<style>
    .label-tiny { font-size: 10px; font-weight: 900; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.1em; margin-bottom: 4px; display: block; } 
    /* Dark mode override */
    .dark .label-tiny { color: #94a3b8; }

    .input-field { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 0.75rem; border-radius: 0.5rem; outline: none; transition: all 0.2s; color: #1e293b; } 
    .input-field:focus { border-color: #3b82f6; background-color: white; }

    /* Dark Mode Inputs */
    .dark .input-field { background-color: #1e293b; border-color: #334155; color: #f1f5f9; }
    .dark .input-field:focus { border-color: #60a5fa; background-color: #0f172a; }
</style>
{% endblock %}



================================================
FILE: app/templates/tickets/manager_dashboard.html
================================================
{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-slate-800 dark:text-white">Validation Hiérarchique</h1>
            <p class="text-slate-500 dark:text-slate-400 mt-2">Gérez les demandes de vos équipes et de votre service.</p>
        </div>
        <div class="flex gap-2">
            <span class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-bold">
                <i data-lucide="shield" class="w-4 h-4 inline mr-1"></i> 
                {{ current_user.role.value }}
            </span>
        </div>
    </div>

    <!-- TABS (Avec Alpine.js fonctionnel) -->
    <div x-data="{ activeTab: 'n1' }" class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden border border-slate-200 dark:border-slate-700 min-h-[600px]">
        
        <!-- Tab Headers -->
        <div class="flex border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50">
            <!-- Onglet N1 -->
            <button @click="activeTab = 'n1'" 
                :class="{ 'border-b-2 border-blue-500 text-blue-600 bg-white dark:bg-slate-800 dark:text-blue-400': activeTab === 'n1', 'text-slate-500 hover:text-slate-700 dark:text-slate-400': activeTab !== 'n1' }"
                class="flex-1 py-4 text-center font-bold text-sm transition relative">
                Validation Équipe (N1)
                {% if tickets_n1 %}
                <span class="absolute top-3 right-4 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center animate-pulse">{{ tickets_n1|length }}</span>
                {% endif %}
            </button>
            
            <!-- Onglet N2 -->
            <button @click="activeTab = 'n2'" 
                :class="{ 'border-b-2 border-purple-500 text-purple-600 bg-white dark:bg-slate-800 dark:text-purple-400': activeTab === 'n2', 'text-slate-500 hover:text-slate-700 dark:text-slate-400': activeTab !== 'n2' }"
                class="flex-1 py-4 text-center font-bold text-sm transition relative">
                Validation Tech/Budget (N2)
                {% if tickets_n2 %}
                <span class="absolute top-3 right-4 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center animate-pulse">{{ tickets_n2|length }}</span>
                {% endif %}
            </button>

            <!-- Onglet FCPI (AJOUTÉ) -->
            <button @click="activeTab = 'fcpi'" 
                :class="{ 'border-b-2 border-pink-500 text-pink-600 bg-white dark:bg-slate-800 dark:text-pink-400': activeTab === 'fcpi', 'text-slate-500 hover:text-slate-700 dark:text-slate-400': activeTab !== 'fcpi' }"
                class="flex-1 py-4 text-center font-bold text-sm transition relative">
                Recrutements (FCPI)
                {% if fcpi_requests %}
                <span class="absolute top-3 right-4 w-5 h-5 bg-pink-500 text-white text-xs rounded-full flex items-center justify-center animate-pulse">{{ fcpi_requests|length }}</span>
                {% endif %}
            </button>
        </div>

        <!-- TAB CONTENT N1 (Mes demandes d'équipe) -->
        <div x-show="activeTab === 'n1'" class="p-6 animate-fadeIn">
            {% if tickets_n1 %}
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-xs font-bold text-slate-500 uppercase border-b border-slate-200 dark:border-slate-700">
                            <th class="pb-3 pl-2">Réf</th>
                            <th class="pb-3">Demandeur</th>
                            <th class="pb-3">Sujet</th>
                            <th class="pb-3">Cible</th>
                            <th class="pb-3">Date</th>
                            <th class="pb-3 text-right pr-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                        {% for t in tickets_n1 %}
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition group">
                            <td class="py-4 pl-2 font-mono text-xs text-slate-500">{{ t.uid_public }}</td>
                            <td class="py-4">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs mr-3">
                                        {{ t.author.fullname[:2].upper() }}
                                    </div>
                                    <div>
                                        <div class="font-bold text-slate-700 dark:text-slate-200 text-sm">{{ t.author.fullname }}</div>
                                        <div class="text-xs text-slate-400">{{ t.service_demandeur }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="py-4">
                                <span class="block font-medium text-slate-800 dark:text-slate-300">{{ t.title }}</span>
                                <span class="text-xs text-slate-400 truncate max-w-[200px] block">{{ t.description[:50] }}...</span>
                            </td>
                            <td class="py-4">
                                <span class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-xs font-bold text-slate-600 dark:text-slate-300">
                                    {{ t.target_service.value }}
                                </span>
                            </td>
                            <td class="py-4 text-xs text-slate-400">{{ t.created_at.strftime('%d/%m %H:%M') }}</td>
                            <td class="py-4 text-right pr-2">
                                <div class="flex justify-end gap-2">
                                    <a href="{{ url_for('tickets.view_ticket', ticket_uid=t.uid_public) }}" class="p-2 text-slate-400 hover:text-blue-500 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg shadow-sm hover:shadow transition">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                    </a>
                                    <a href="{{ url_for('tickets.manager_action', ticket_id=t.id, action='validate') }}" class="px-3 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-xs font-bold shadow-md shadow-emerald-500/20 transition flex items-center">
                                        <i data-lucide="check" class="w-3 h-3 mr-1"></i> Valider
                                    </a>
                                    <a href="{{ url_for('tickets.manager_action', ticket_id=t.id, action='refuse') }}" onclick="return confirm('Refuser cette demande ?')" class="px-3 py-2 bg-white border border-red-200 text-red-500 hover:bg-red-50 rounded-lg text-xs font-bold transition">
                                        Refuser
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="flex flex-col items-center justify-center py-20 text-slate-400">
                <i data-lucide="check-circle" class="w-16 h-16 mb-4 opacity-20"></i>
                <p>Aucune demande en attente de votre validation N1.</p>
            </div>
            {% endif %}
        </div>

        <!-- TAB CONTENT N2 (Mes validations techniques) -->
        <div x-show="activeTab === 'n2'" class="p-6 animate-fadeIn" style="display: none;">
            {% if tickets_n2 %}
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-xs font-bold text-slate-500 uppercase border-b border-slate-200 dark:border-slate-700">
                            <th class="pb-3 pl-2">Réf</th>
                            <th class="pb-3">Type</th>
                            <th class="pb-3">Demandeur</th>
                            <th class="pb-3">Statut Actuel</th>
                            <th class="pb-3 text-right pr-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                        {% for t in tickets_n2 %}
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                            <td class="py-4 pl-2 font-mono text-xs text-slate-500">{{ t.uid_public }}</td>
                            <td class="py-4">
                                <span class="font-bold text-sm block">{{ t.title }}</span>
                                {% if t.target_service.value == 'DAF' and t.category_ticket == 'Bon de Commande' %}
                                <span class="text-xs text-purple-500 font-bold bg-purple-50 px-1 rounded">Bon de Commande</span>
                                {% endif %}
                            </td>
                            <td class="py-4 text-sm text-slate-600 dark:text-slate-300">
                                {{ t.author.fullname }} <br>
                                <span class="text-xs text-slate-400">{{ t.service_demandeur }}</span>
                            </td>
                            <td class="py-4">
                                {% if t.status.value == 'SIGNATURE_DIRECTEUR' %}
                                <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-bold border border-purple-200">
                                    <i data-lucide="pen-tool" class="w-3 h-3 inline"></i> Signature Requise
                                </span>
                                {% else %}
                                <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs font-bold border border-orange-200">
                                    Validation Requise
                                </span>
                                {% endif %}
                            </td>
                            <td class="py-4 text-right pr-2">
                                <div class="flex justify-end gap-2">
                                    <a href="{{ url_for('tickets.view_ticket', ticket_uid=t.uid_public) }}" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-md text-xs font-bold transition flex items-center">
                                        <i data-lucide="search" class="w-3 h-3 mr-2"></i> Examiner
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="flex flex-col items-center justify-center py-20 text-slate-400">
                <i data-lucide="check-circle" class="w-16 h-16 mb-4 opacity-20"></i>
                <p>Aucune validation technique en attente.</p>
            </div>
            {% endif %}
        </div>

        <!-- TAB CONTENT FCPI (LE VOICI !) -->
        <div x-show="activeTab === 'fcpi'" class="p-6 animate-fadeIn" style="display: none;">
            {% if fcpi_requests %}
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-xs font-bold text-slate-500 uppercase border-b border-slate-200 dark:border-slate-700">
                            <th class="pb-3 pl-2">Réf</th>
                            <th class="pb-3">Candidat / Agent</th>
                            <th class="pb-3">Date Entrée</th>
                            <th class="pb-3">Statut</th>
                            <th class="pb-3 text-right pr-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                        {% for r in fcpi_requests %}
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                            <td class="py-4 pl-2 font-mono text-xs text-pink-500 font-bold">{{ r.uid_public }}</td>
                            <td class="py-4">
                                <span class="block font-bold text-slate-800 dark:text-white">{{ r.nom_agent }} {{ r.prenom_agent }}</span>
                                <span class="text-xs text-slate-400">{{ r.service_agent }} - {{ r.fonction }}</span>
                            </td>
                            <td class="py-4 text-sm font-bold text-slate-700 dark:text-slate-300">
                                {{ r.date_entree.strftime('%d/%m/%Y') }}
                            </td>
                            <td class="py-4">
                                <span class="px-2 py-1 bg-pink-100 text-pink-700 rounded text-xs font-bold border border-pink-200">
                                    {{ r.status.value }}
                                </span>
                            </td>
                            <td class="py-4 text-right pr-2">
                                <a href="{{ url_for('fcpi.view_fcpi', id=r.id) }}" class="px-4 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded-lg shadow-md text-xs font-bold transition inline-flex items-center">
                                    <i data-lucide="search" class="w-3 h-3 mr-2"></i> Examiner
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="flex flex-col items-center justify-center py-20 text-slate-400">
                <i data-lucide="user-plus" class="w-16 h-16 mb-4 opacity-20"></i>
                <p>Aucune demande de recrutement en attente.</p>
            </div>
            {% endif %}
        </div>

    </div>
</div>
{% endblock %}



================================================
FILE: app/templates/tickets/new_fcpi.html
================================================
{% extends "base.html" %}

{% block content %}
<div class="flex justify-center items-start min-h-[80vh] pt-10 pb-20 px-4">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 w-full max-w-4xl relative transition-colors duration-300">
        
        <a href="{{ url_for('main.user_portal') }}" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition">
            <i data-lucide="x" class="w-6 h-6"></i>
        </a>

        <div class="text-center mb-8">
            <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400">
                <i data-lucide="users" class="w-8 h-8"></i>
            </div>
            <h1 class="text-3xl font-black text-slate-800 dark:text-white tracking-tight mb-2">Fiche Création Poste & Intégration</h1>
            <p class="text-slate-500 dark:text-slate-400">Processus de recrutement et d'onboarding.</p>
        </div>

        <form method="POST" enctype="multipart/form-data" class="space-y-8">
            
            <!-- 1. IDENTITÉ AGENT -->
            <div class="bg-slate-50 dark:bg-slate-900/50 p-6 rounded-2xl border border-slate-200 dark:border-slate-700">
                <h3 class="font-bold text-slate-700 dark:text-white mb-4 flex items-center"><i data-lucide="user" class="w-5 h-5 mr-2"></i> Données de l'agent</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="label-tiny">Date d'entrée</label>
                        <input type="date" name="fcpi_date_entree" class="input-field" required>
                    </div>
                    <div>
                        <label class="label-tiny">Service</label>
                        <input type="text" name="fcpi_service" class="input-field" required>
                    </div>
                    <div>
                        <label class="label-tiny">Nom</label>
                        <input type="text" name="fcpi_nom" class="input-field" required>
                    </div>
                    <div>
                        <label class="label-tiny">Prénom</label>
                        <input type="text" name="fcpi_prenom" class="input-field" required>
                    </div>
                    <div>
                        <label class="label-tiny">Fonction</label>
                        <input type="text" name="fcpi_fonction" class="input-field" required>
                    </div>
                    <div>
                        <label class="label-tiny">Unité Fonctionnelle (UF)</label>
                        <input type="text" name="fcpi_uf" class="input-field">
                    </div>
                </div>
            </div>

            <!-- 2. CONTRAT RH -->
            <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-2xl border border-blue-200 dark:border-blue-800">
                <h3 class="font-bold text-blue-800 dark:text-blue-300 mb-4 flex items-center"><i data-lucide="briefcase" class="w-5 h-5 mr-2"></i> Données Contractuelles (DRH)</h3>
                
                <div class="mb-4">
                    <label class="label-tiny text-blue-600">Type de contrat</label>
                    <select name="fcpi_contractuel" id="contractuel" onchange="toggleDates()" class="input-field cursor-pointer">
                        <option value="Oui">Contractuel (CDD/CDI)</option>
                        <option value="Non">Titulaire / Autre</option>
                    </select>
                </div>

                <div id="dates_contrat" class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="label-tiny">Début contrat</label>
                        <input type="date" name="fcpi_debut_contrat" class="input-field">
                    </div>
                    <div>
                        <label class="label-tiny">Fin contrat</label>
                        <input type="date" name="fcpi_fin_contrat" class="input-field">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="label-tiny">Conditions</label>
                        <select name="fcpi_condition" class="input-field">
                            <option value="Jour">Jour</option>
                            <option value="Nuit">Nuit</option>
                            <option value="Week-end">Week-end</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-tiny">Temps travail</label>
                        <select name="fcpi_temps" id="temps" onchange="togglePourcentage()" class="input-field">
                            <option value="Plein">Temps Plein</option>
                            <option value="Partiel">Temps Partiel</option>
                            <option value="Non complet">Temps Non Complet</option>
                        </select>
                    </div>
                    <div id="pourcentage_div" class="hidden">
                        <label class="label-tiny">Pourcentage (%)</label>
                        <input type="text" name="fcpi_pourcentage" class="input-field" placeholder="Ex: 80%">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="label-tiny">Motif Recrutement</label>
                    <select name="fcpi_motif" class="input-field">
                        <option value="Vacant">Poste Vacant</option>
                        <option value="Remplacement">Remplacement</option>
                        <option value="Surcroit">Surcroît d'activité</option>
                    </select>
                </div>

                <div class="flex items-center gap-2 mb-4">
                    <input type="checkbox" name="fcpi_simulation" class="w-5 h-5 text-blue-600 rounded">
                    <span class="text-sm text-slate-700 dark:text-slate-300 font-bold">Demander une simulation de salaire</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="label-tiny">CV (PDF)</label>
                        <input type="file" name="fcpi_cv" accept=".pdf" class="input-field text-sm">
                    </div>
                    <div>
                        <label class="label-tiny">Fiche de Poste (PDF)</label>
                        <input type="file" name="fcpi_fiche_poste" accept=".pdf" class="input-field text-sm">
                    </div>
                </div>
            </div>

            <!-- 3. LOGISTIQUE & SECU -->
            <div class="bg-orange-50 dark:bg-orange-900/20 p-6 rounded-2xl border border-orange-200 dark:border-orange-800">
                <h3 class="font-bold text-orange-800 dark:text-orange-300 mb-4 flex items-center"><i data-lucide="key" class="w-5 h-5 mr-2"></i> Badges, Clefs & Locaux</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="label-tiny">Localisation Poste de Travail</label>
                        <input type="text" name="fcpi_localisation" class="input-field" placeholder="Bureau, Etage...">
                    </div>
                    <div>
                        <label class="label-tiny">Photo (Facultatif)</label>
                        <input type="file" name="fcpi_photo" accept="image/*" class="input-field text-sm">
                    </div>
                </div>
                <div>
                    <label class="label-tiny">Commentaire Badge/Clefs</label>
                    <textarea name="fcpi_badge_com" rows="2" class="input-field" placeholder="Droits d'accès spécifiques..."></textarea>
                </div>
            </div>

            <!-- 4. IMAGO -->
            <div class="bg-purple-50 dark:bg-purple-900/20 p-6 rounded-2xl border border-purple-200 dark:border-purple-800">
                <h3 class="font-bold text-purple-800 dark:text-purple-300 mb-4 flex items-center"><i data-lucide="smartphone" class="w-5 h-5 mr-2"></i> Imago</h3>
                <div class="flex items-center gap-4 mb-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="fcpi_imago" id="imago_check" onchange="toggleImago()" class="w-5 h-5 text-purple-600 rounded">
                        <span class="font-bold text-slate-700 dark:text-slate-300">Besoin Imago (Mobilité)</span>
                    </label>
                </div>
                <div id="imago_sites" class="hidden">
                    <label class="label-tiny">Sites d'intervention</label>
                    <input type="text" name="fcpi_imago_sites" class="input-field" placeholder="Lister les sites...">
                </div>
            </div>

            <!-- 5. INFORMATIQUE -->
            <div class="bg-slate-100 dark:bg-slate-700 p-6 rounded-2xl border border-slate-300 dark:border-slate-600">
                <h3 class="font-bold text-slate-700 dark:text-white mb-4 flex items-center"><i data-lucide="monitor" class="w-5 h-5 mr-2"></i> Informatique</h3>
                
                <label class="label-tiny mb-2">Matériel requis</label>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <label class="flex items-center gap-2"><input type="checkbox" name="fcpi_materiel" value="Tel Fixe" class="rounded"> Tel Fixe</label>
                    <label class="flex items-center gap-2"><input type="checkbox" name="fcpi_materiel" value="Tel Portable" class="rounded"> Tel Portable</label>
                    <label class="flex items-center gap-2"><input type="checkbox" name="fcpi_materiel" value="PC Fixe" class="rounded"> PC Fixe</label>
                    <label class="flex items-center gap-2"><input type="checkbox" name="fcpi_materiel" value="PC Portable" class="rounded"> PC Portable</label>
                </div>

                <div>
                    <label class="label-tiny">Besoins accès informatique (Dossiers, Logiciels...)</label>
                    <textarea name="fcpi_acces" rows="3" class="input-field"></textarea>
                </div>
            </div>

            <button type="submit" class="w-full py-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl shadow-lg flex justify-center items-center transform transition hover:scale-[1.01]">
                <span>Soumettre la demande RH</span>
                <i data-lucide="send" class="ml-2 w-5 h-5"></i>
            </button>

        </form>
    </div>
</div>

<script>
    function toggleDates() {
        const val = document.getElementById('contractuel').value;
        const div = document.getElementById('dates_contrat');
        if (val === 'Non') div.classList.remove('hidden');
        else div.classList.add('hidden'); // Ajuster selon logique inverse si besoin
    }
    
    function togglePourcentage() {
        const val = document.getElementById('temps').value;
        const div = document.getElementById('pourcentage_div');
        if (val !== 'Plein') div.classList.remove('hidden');
        else div.classList.add('hidden');
    }

    function toggleImago() {
        const checked = document.getElementById('imago_check').checked;
        const div = document.getElementById('imago_sites');
        if (checked) div.classList.remove('hidden');
        else div.classList.add('hidden');
    }
</script>

<style>
    .label-tiny { font-size: 10px; font-weight: 900; text-transform: uppercase; color: #94a3b8; margin-bottom: 6px; display: block; letter-spacing: 0.1em; }
    .input-field { width: 100%; background-color: white; border: 1px solid #cbd5e1; padding: 0.75rem; border-radius: 0.5rem; outline: none; }
    .dark .input-field { background-color: #1e293b; border-color: #475569; color: white; }
</style>
{% endblock %}



================================================
FILE: app/templates/tickets/new_ticket.html
================================================
{% extends "base.html" %}

{% block content %}
<div class="flex justify-center items-start min-h-[80vh] pt-10 pb-20 px-4">

    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 w-full max-w-3xl relative transition-colors duration-300">
        
        <a href="{{ url_for('main.user_portal') }}" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition">
            <i data-lucide="x" class="w-6 h-6"></i>
        </a>

        <div class="text-center mb-8">
            <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 
                {% if service_name == 'INFO' %}bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400
                {% elif service_name == 'DAF' %}bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400
                {% elif service_name == 'TECH' %}bg-orange-50 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400
                {% else %}bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400{% endif %}">
                
                {% if service_name == 'INFO' %}<i data-lucide="monitor" class="w-8 h-8"></i>
                {% elif service_name == 'DAF' %}<i data-lucide="banknote" class="w-8 h-8"></i>
                {% elif service_name == 'TECH' %}<i data-lucide="wrench" class="w-8 h-8"></i>
                {% else %}<i data-lucide="file-plus" class="w-8 h-8"></i>{% endif %}
            </div>
            <h1 class="text-3xl font-black text-slate-800 dark:text-white tracking-tight mb-2">Nouvelle Demande <span class="text-blue-600 dark:text-blue-400">{{ service.value }}</span></h1>
            <p class="text-slate-500 dark:text-slate-400">Remplissez les informations ci-dessous.</p>
        </div>

        <form method="POST" enctype="multipart/form-data" class="space-y-6">
            
            <!-- SÉLECTEUR SERVICE DEMANDEUR (Si User a plusieurs GU) -->
            {% if user_origins|length > 1 %}
            <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-lg border border-yellow-500 dark:border-yellow-600 mb-6">
                <label class="block text-slate-700 dark:text-slate-300 text-sm font-bold mb-2">Pour quel service faites-vous cette demande ?</label>
                <select name="selected_origin" class="w-full bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 rounded p-2 border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-blue-500">
                    {% for origin in user_origins %}
                    <option value="{{ origin }}">GU-{{ origin }}</option>
                    {% endfor %}
                </select>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">En tant que Directeur/Manager multi-services, veuillez préciser l'origine.</p>
            </div>
            {% else %}
                <!-- Champ caché si un seul service -->
                {% if user_origins %}
                <input type="hidden" name="selected_origin" value="{{ user_origins[0] }}">
                {% endif %}
            {% endif %}

            <!-- TYPE DE DEMANDE -->
            <div>
                <label class="label-tiny">Type de demande</label>
                <select name="category_ticket" id="category_ticket" onchange="toggleFormFields()" class="input-field cursor-pointer">
                    <!-- Option Standard affichée UNIQUEMENT si ce n'est ni INFO ni DAF -->
                    {% if service_name not in ['INFO', 'DAF'] %}
                    <option value="Standard">Demande Standard</option>
                    {% endif %}

                    {% if service_name == 'INFO' %}
                    <option value="Incident Standard">Incident / Panne (Internet, PC...)</option>
                    <!-- Options Nouvel Utilisateur et Matériel retirées -->
                    {% endif %}
                    {% if service_name == 'DAF' %}
                    <option value="Bon de Commande">Bon de Commande</option>
                    {% endif %}
                </select>
            </div>

            <!-- CHAMPS COMMUNS (Masqués pour DAF Bon de Commande) -->
            <div id="common-fields" class="space-y-4">
                <div>
                    <label class="label-tiny">Titre de la demande</label>
                    <input type="text" name="title" class="input-field" placeholder="Ex: Problème d'impression...">
                </div>
                <div>
                    <label class="label-tiny">Description détaillée</label>
                    <textarea name="description" rows="4" class="input-field" placeholder="Décrivez votre besoin..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label-tiny">Service/Bureau</label>
                        <input type="text" name="hostname" class="input-field" placeholder="Informatique">
                    </div>
                    <div>
                        <label class="label-tiny">Téléphone de contact</label>
                        <input type="text" name="tel_demandeur" class="input-field" placeholder="06...">
                    </div>
                </div>
            </div>

            <!-- FORMULAIRE BON DE COMMANDE (DAF ONLY) -->
            {% if service_name == 'DAF' %}
            <div id="daf-fields" class="hidden space-y-6">
                
                <!-- BLOC 1 : INFORMATIONS ADMINISTRATIVES -->
                <div class="bg-purple-50 dark:bg-purple-900/20 p-6 rounded-2xl border border-purple-100 dark:border-purple-900/50 space-y-4">
                    <h3 class="font-bold text-purple-800 dark:text-purple-300 mb-4 flex items-center">
                        <i data-lucide="info" class="w-5 h-5 mr-2"></i> Infos Commande
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label-tiny">Unité Fonctionnelle (UF)</label>
                            <select name="daf_uf" class="input-field cursor-pointer">
                                <option value="">-- Sélectionner UF --</option>
                                <option value="UF-DIRECTION">Direction</option>
                                <option value="UF-IT">Informatique</option>
                                <option value="UF-RH">Ressources Humaines</option>
                                <option value="UF-COMMERCE">Commerce</option>
                                <option value="UF-TECHNIQUE">Technique</option>
                            </select>
                        </div>
                        <div>
                            <label class="label-tiny">Budget Affecté</label>
                            <select name="daf_budget" class="input-field cursor-pointer">
                                <option value="">-- Sélectionner Budget --</option>
                                <option value="INVESTISSEMENT">Investissement (CAPEX)</option>
                                <option value="FONCTIONNEMENT">Fonctionnement (OPEX)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="label-tiny">Lieu de livraison</label>
                        <input type="text" name="daf_lieu_livraison" placeholder="Livraison" class="input-field bg-white dark:bg-slate-700">
                    </div>
                </div>

                <!-- BLOC 2 : FOURNISSEUR -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4">Informations Fournisseur</h3>
                    
                    <!-- Toggle Nouveau Fournisseur -->
                    <div class="mb-4 flex items-center gap-4 bg-slate-50 dark:bg-slate-900/50 p-3 rounded-xl border border-slate-100 dark:border-slate-600">
                        <span class="text-sm font-bold text-slate-600 dark:text-slate-400">Fournisseur déjà référencé ?</span>
                        <div class="flex gap-4 ml-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="supplier_status" value="existing" checked onchange="toggleSupplier(false)" class="text-purple-600 focus:ring-purple-500 w-4 h-4">
                                <span class="text-sm font-bold text-slate-700 dark:text-slate-200">Oui</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="supplier_status" value="new" onchange="toggleSupplier(true)" class="text-purple-600 focus:ring-purple-500 w-4 h-4">
                                <span class="text-sm font-bold text-slate-700 dark:text-slate-200">Non (Nouveau)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Champs Fournisseur Standard -->
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" name="daf_fournisseur_nom" placeholder="Nom du fournisseur" class="input-field bg-white dark:bg-slate-700" required>
                        <input type="email" name="daf_fournisseur_email" placeholder="Email Contact" class="input-field bg-white dark:bg-slate-700">
                    </div>

                    <!-- Champs Spécifiques Nouveau Fournisseur (Masqués par défaut) -->
                    <div id="new-supplier-fields" class="hidden mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 grid grid-cols-1 md:grid-cols-2 gap-4 animate-fadeIn">
                        <div>
                            <label class="label-tiny text-purple-600 dark:text-purple-400">Numéro SIRET</label>
                            <input type="text" name="daf_siret" placeholder="14 chiffres" class="input-field bg-white dark:bg-slate-700">
                        </div>
                        <div>
                            <label class="label-tiny text-purple-600 dark:text-purple-400">Téléphone (avec commentaire)</label>
                            <input type="text" name="daf_fournisseur_tel" placeholder="Ex: 0102030405 (M. Dupont)" class="input-field bg-white dark:bg-slate-700">
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label class="label-tiny text-purple-600 dark:text-purple-400 flex items-center gap-2">
                                <i data-lucide="upload" class="w-3 h-3"></i> Joindre RIB (PDF Obligatoire)
                            </label>
                            <input type="file" name="daf_rib" accept=".pdf" class="input-field bg-white dark:bg-slate-700">
                        </div>
                    </div>
                </div>

                <!-- BLOC 3 : DÉTAILS COMMANDE & FICHIERS -->
                <div class="bg-slate-50 dark:bg-slate-700 p-6 rounded-2xl border border-slate-200 dark:border-slate-600">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4">Détails de la commande</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left" id="dafLinesTable">
                            <thead class="bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-300 uppercase">
                                <tr>
                                    <th class="p-2">Désignation</th>
                                    <th class="p-2 w-24">Réf</th>
                                    <th class="p-2 w-16">Qté</th>
                                    <th class="p-2 w-24">P.U (€)</th>
                                    <th class="p-2 w-24">Total</th>
                                </tr>
                            </thead>
                            <tbody id="linesContainer" class="divide-y divide-slate-200 dark:divide-slate-600">
                                <!-- Ligne initiale -->
                                <tr>
                                    <td class="p-2"><input type="text" name="daf_designation_1" class="w-full bg-white dark:bg-slate-800 dark:text-white border border-slate-300 dark:border-slate-500 rounded p-1"></td>
                                    <td class="p-2"><input type="text" name="daf_ref_1" class="w-full bg-white dark:bg-slate-800 dark:text-white border border-slate-300 dark:border-slate-500 rounded p-1"></td>
                                    <td class="p-2"><input type="number" name="daf_qte_1" id="qte_1" oninput="calcTotal(1)" class="w-full bg-white dark:bg-slate-800 dark:text-white border border-slate-300 dark:border-slate-500 rounded p-1"></td>
                                    <td class="p-2"><input type="number" step="0.01" name="daf_pu_1" id="pu_1" oninput="calcTotal(1)" class="w-full bg-white dark:bg-slate-800 dark:text-white border border-slate-300 dark:border-slate-500 rounded p-1"></td>
                                    <td class="p-2"><input type="text" id="total_1" name="daf_total_1" readonly class="w-full bg-slate-100 dark:bg-slate-600 dark:text-white border-none rounded p-1 text-right font-mono"></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5" class="p-2">
                                        <button type="button" onclick="addDafLine()" class="text-xs font-bold uppercase text-blue-600 hover:text-blue-800 flex items-center gap-1">
                                            <i data-lucide="plus-circle" class="w-4 h-4"></i> Ajouter une ligne
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-right font-bold p-2 text-slate-700 dark:text-slate-300">TOTAL ESTIMÉ :</td>
                                    <td class="p-2 font-bold text-right text-slate-900 dark:text-white" id="grandTotal">0.00 €</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex justify-between items-center">
                        <div>
                            <label class="label-tiny">Type de prix</label>
                            <div class="flex space-x-4">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="radio" name="daf_type_prix" value="HT" checked class="form-radio text-purple-600">
                                    <span class="text-slate-700 dark:text-slate-300">Hors Taxe (HT)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="radio" name="daf_type_prix" value="TTC" class="form-radio text-purple-600">
                                    <span class="text-slate-700 dark:text-slate-300">TTC</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <label class="label-tiny">Commentaire général</label>
                        <textarea name="description_daf" rows="2" class="input-field bg-white dark:bg-slate-800" placeholder="Précisions"></textarea>
                    </div>

                    <div class="mt-4">
                        <label class="label-tiny">Devis (PDF)</label>
                        <input type="file" name="devis_1" accept=".pdf" class="input-field bg-white dark:bg-slate-800 dark:text-slate-300 mb-2">
                        <input type="file" name="devis_2" accept=".pdf" class="input-field bg-white dark:bg-slate-800 dark:text-slate-300">
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- BOUTON ENVOYER -->
            <button type="submit" class="w-full py-4 bg-slate-900 hover:bg-slate-800 dark:bg-blue-600 dark:hover:bg-blue-500 text-white font-bold rounded-xl transition transform hover:scale-[1.01] shadow-lg flex justify-center items-center">
                <span>Envoyer la demande</span>
                <i data-lucide="send" class="ml-2 w-5 h-5"></i>
            </button>
        </form>
    </div>
</div>

<script>
    function toggleFormFields() {
        const category = document.getElementById('category_ticket').value;
        const common = document.getElementById('common-fields');
        // Anciens champs Nouvel Utilisateur et Matériel supprimés
        const daf = document.getElementById('daf-fields');

        // Reset
        if(daf) daf.classList.add('hidden');
        if(common) common.classList.remove('hidden');

        // DAF Special
        if (category === 'Bon de Commande') {
            if(daf) daf.classList.remove('hidden');
            if(common) common.classList.add('hidden'); // On cache titre/desc pour bon de commande pur
        } 
        // INFO Special
        else {
           // Plus de logique spécifique ici pour l'instant
        }
    }

    // Gestion de l'affichage Nouveau Fournisseur
    function toggleSupplier(isNew) {
        const block = document.getElementById('new-supplier-fields');
        if (isNew) {
            block.classList.remove('hidden');
        } else {
            block.classList.add('hidden');
        }
    }

    // Gestion dynamique des lignes DAF
    let lineCount = 1;

    function addDafLine() {
        lineCount++;
        const container = document.getElementById('linesContainer');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td class="p-2"><input type="text" name="daf_designation_${lineCount}" class="w-full bg-white dark:bg-slate-800 dark:text-white border border-slate-300 dark:border-slate-500 rounded p-1"></td>
            <td class="p-2"><input type="text" name="daf_ref_${lineCount}" class="w-full bg-white dark:bg-slate-800 dark:text-white border border-slate-300 dark:border-slate-500 rounded p-1"></td>
            <td class="p-2"><input type="number" name="daf_qte_${lineCount}" id="qte_${lineCount}" oninput="calcTotal(${lineCount})" class="w-full bg-white dark:bg-slate-800 dark:text-white border border-slate-300 dark:border-slate-500 rounded p-1"></td>
            <td class="p-2"><input type="number" step="0.01" name="daf_pu_${lineCount}" id="pu_${lineCount}" oninput="calcTotal(${lineCount})" class="w-full bg-white dark:bg-slate-800 dark:text-white border border-slate-300 dark:border-slate-500 rounded p-1"></td>
            <td class="p-2"><input type="text" id="total_${lineCount}" name="daf_total_${lineCount}" readonly class="w-full bg-slate-100 dark:bg-slate-600 dark:text-white border-none rounded p-1 text-right font-mono"></td>
        `;
        container.appendChild(newRow);
    }

    function calcTotal(i) {
        const qte = parseFloat(document.getElementById('qte_' + i).value) || 0;
        const pu = parseFloat(document.getElementById('pu_' + i).value) || 0;
        const total = qte * pu;
        document.getElementById('total_' + i).value = total.toFixed(2);
        
        let grandTotal = 0;
        // On boucle jusqu'au nombre actuel de lignes
        for(let j=1; j<=lineCount; j++) {
            const el = document.getElementById('total_' + j);
            if(el) {
                const val = parseFloat(el.value) || 0;
                grandTotal += val;
            }
        }
        document.getElementById('grandTotal').innerText = grandTotal.toFixed(2) + ' €';
    }

    // Initialisation au chargement de la page pour ajuster l'affichage (important pour DAF)
    document.addEventListener('DOMContentLoaded', toggleFormFields);
</script>

<style>
    .label-tiny { font-size: 10px; font-weight: 900; text-transform: uppercase; color: #94a3b8; margin-bottom: 6px; display: block; letter-spacing: 0.1em; }
    /* Dark mode override pour label */
    .dark .label-tiny { color: #94a3b8; }
    
    .input-field { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.75rem; outline: none; transition: all 0.2s; color: #1e293b; }
    .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); background-color: white; }
    
    /* Dark Mode Inputs */
    .dark .input-field { background-color: #1e293b; border-color: #334155; color: #f1f5f9; }
    .dark .input-field:focus { border-color: #60a5fa; background-color: #0f172a; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
</style>
{% endblock %}



================================================
FILE: app/templates/tickets/service_dashboard.html
================================================
{% extends "base.html" %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-4 gap-8 pb-20 p-6 bg-slate-100 dark:bg-slate-900 min-h-screen transition-colors duration-300">
    
    <!-- SECTION PRINCIPALE (GAUCHE) -->
    <div class="lg:col-span-3 flex flex-col gap-8">
        
        <!-- HEADER -->
        <div class="flex flex-col gap-4">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4">
                <div>
                    <h1 class="text-3xl font-black text-slate-900 dark:text-white uppercase tracking-tight">
                        Dashboard 
                        <span class="text-blue-600 dark:text-blue-400">
                            {% for svc in current_user.get_allowed_services() %}
                                {{ svc }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </span>
                    </h1>
                    <div class="anim-greeting text-slate-500 dark:text-slate-400 font-bold text-sm mt-1 flex items-center gap-2">
                        <span class="text-xl">👋</span> Bonjour <span class="text-blue-600 dark:text-blue-400">{{ current_user.fullname }}</span> !
                    </div>
                </div>
                
                <div class="flex flex-wrap items-center gap-3">
                    <div class="hidden sm:block bg-white dark:bg-slate-800 px-6 py-3 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm text-sm font-bold text-slate-600 dark:text-slate-300 capitalize" id="liveClock">--:--:--</div>
                </div>
            </div>

            <!-- BARRE D'OUTILS TECH -->
            <div class="flex flex-wrap gap-3 bg-white dark:bg-slate-800 p-3 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm">
                <a href="{{ url_for('tickets.historique_tickets') }}" class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 rounded-lg text-xs font-bold uppercase tracking-wide transition">
                    <i data-lucide="archive" class="w-4 h-4 text-blue-500 dark:text-blue-400"></i> Historique / Ajout Manuel
                </a>
                
                {% if 'INFO' in current_user.get_allowed_services() or 'INFORMATIQUE' in current_user.get_allowed_services() %}
                <a href="{{ url_for('inventaire.liste') }}" class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 rounded-lg text-xs font-bold uppercase tracking-wide transition">
                    <i data-lucide="package" class="w-4 h-4 text-orange-500 dark:text-orange-400"></i> Stock & Inventaire
                </a>
                <a href="{{ url_for('prets.liste_prets') }}" class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 rounded-lg text-xs font-bold uppercase tracking-wide transition">
                    <i data-lucide="arrow-right-left" class="w-4 h-4 text-purple-500 dark:text-purple-400"></i> Gestion des Prêts
                </a>
                {% endif %}
            </div>
        </div>

        <!-- STATS CARDS -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- À Traiter -->
            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition group">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-xl group-hover:scale-110 transition"><i data-lucide="inbox" class="w-6 h-6"></i></div>
                    <span class="bg-orange-50 dark:bg-orange-900/50 text-orange-600 dark:text-orange-300 text-[10px] font-black uppercase px-2 py-1 rounded-lg">Prioritaire</span>
                </div>
                <div class="text-3xl font-black text-slate-800 dark:text-white mb-1">{{ stats.pending }}</div>
                <div class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">Tickets à attribuer</div>
            </div>

            <!-- En Cours (Mes Tickets) -->
            <div class="bg-blue-600 dark:bg-blue-700 p-6 rounded-2xl shadow-lg shadow-blue-200 dark:shadow-none transform hover:-translate-y-1 transition text-white relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full blur-2xl"></div>
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-white/20 rounded-xl backdrop-blur-sm"><i data-lucide="play-circle" class="w-6 h-6"></i></div>
                    <span class="bg-white/20 text-white text-[10px] font-black uppercase px-2 py-1 rounded-lg">En cours</span>
                </div>
                <div class="text-3xl font-black mb-1">{{ stats.active }}</div>
                <div class="text-xs font-bold text-blue-100 uppercase tracking-wider">Mes Dossiers</div>
            </div>

            <!-- Terminés (Global) -->
            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition group">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-xl group-hover:scale-110 transition"><i data-lucide="check-circle" class="w-6 h-6"></i></div>
                    <span class="bg-emerald-50 dark:bg-emerald-900/50 text-emerald-600 dark:text-emerald-300 text-[10px] font-black uppercase px-2 py-1 rounded-lg">Total</span>
                </div>
                <div class="text-3xl font-black text-slate-800 dark:text-white mb-1">{{ stats.done }}</div>
                <div class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">Tickets Clôturés</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- LISTE DES TICKETS ATTRIBUÉS (EN COURS) -->
            <div class="lg:col-span-2 bg-white dark:bg-slate-800 rounded-3xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden flex flex-col h-[600px]">
                <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                    <h2 class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <i data-lucide="activity" class="w-5 h-5 text-blue-500"></i> Mes Tickets en cours
                    </h2>
                </div>
                
                <div class="divide-y divide-slate-100 dark:divide-slate-700 overflow-y-auto flex-1">
                    {% if mine %}
                        {% for ticket in mine %}
                        <div class="p-5 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition group relative">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="font-mono text-[10px] text-slate-400 bg-slate-100 dark:bg-slate-900 px-1.5 py-0.5 rounded">#{{ ticket.uid_public }}</span>
                                    <span class="bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 text-[10px] font-bold px-2 py-0.5 rounded-full uppercase">{{ ticket.category_ticket }}</span>
                                </div>
                                <span class="text-[10px] font-bold text-slate-400">{{ ticket.created_at.strftime('%d/%m %H:%M') }}</span>
                            </div>
                            
                            <h3 class="font-bold text-slate-800 dark:text-slate-200 mb-1 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition">{{ ticket.title }}</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mb-3 line-clamp-2">{{ ticket.description }}</p>
                            
                            <div class="flex justify-between items-center mt-3">
                                <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 font-medium">
                                    <div class="w-6 h-6 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-[10px] font-bold text-slate-600 dark:text-slate-300">
                                        {{ ticket.author.fullname[:1] }}
                                    </div>
                                    {{ ticket.author.fullname }}
                                    {% if ticket.tel_demandeur %}<span class="text-slate-300">|</span> <i data-lucide="phone" class="w-3 h-3"></i> {{ ticket.tel_demandeur }}{% endif %}
                                </div>
                                
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <a href="{{ url_for('tickets.view_ticket', ticket_uid=ticket.uid_public) }}" class="bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 px-3 py-1.5 rounded-lg text-xs font-bold uppercase hover:bg-slate-50 dark:hover:bg-slate-600 transition">
                                        Voir
                                    </a>
                                    <a href="{{ url_for('tickets.close_ticket', ticket_id=ticket.id) }}" class="bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold uppercase hover:bg-green-700 transition shadow-sm">
                                        Clôturer
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="h-full flex flex-col items-center justify-center text-center p-12">
                            <div class="w-16 h-16 bg-slate-50 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="thumbs-up" class="w-8 h-8 text-slate-300 dark:text-slate-500"></i>
                            </div>
                            <p class="text-slate-500 dark:text-slate-400 font-medium">Aucun ticket en cours.</p>
                            <p class="text-slate-400 dark:text-slate-500 text-xs mt-1">Prenez-en un dans la file d'attente !</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- FILE D'ATTENTE (POOL) -->
            <div class="bg-white dark:bg-slate-800 rounded-3xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden flex flex-col h-[600px]">
                <div class="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/50 backdrop-blur flex justify-between items-center sticky top-0 z-10">
                    <h2 class="font-bold text-slate-800 dark:text-white text-sm uppercase tracking-wide flex items-center gap-2">
                        <span class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></span> File d'attente
                    </h2>
                    <span class="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs font-bold px-2 py-0.5 rounded-full">{{ stats.pending }}</span>
                </div>

                <div class="overflow-y-auto flex-1 p-3 space-y-3 bg-slate-50/30 dark:bg-slate-900/20 scrollbar-hide">
                    {% for ticket in pool_standard %}
                    <div class="bg-white dark:bg-slate-700 p-4 rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm hover:shadow-md hover:border-orange-200 dark:hover:border-orange-500 transition group cursor-default">
                        <div class="flex justify-between mb-2">
                            <span class="text-[10px] font-bold text-orange-500 bg-orange-50 dark:bg-orange-900/30 px-2 py-0.5 rounded uppercase tracking-wider">Standard</span>
                            <span class="text-[10px] font-mono text-slate-400 dark:text-slate-500">#{{ ticket.uid_public }}</span>
                        </div>
                        <h4 class="font-bold text-sm text-slate-800 dark:text-slate-200 leading-tight mb-1">{{ ticket.title|truncate(40) }}</h4>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">{{ ticket.service_demandeur }} • {{ ticket.author.fullname }}</p>
                        
                        <a href="{{ url_for('tickets.take_ticket', ticket_id=ticket.id) }}" class="flex items-center justify-center w-full py-2 bg-slate-50 dark:bg-slate-600 text-slate-600 dark:text-slate-300 text-xs font-bold uppercase rounded-lg hover:bg-orange-500 hover:text-white transition gap-2 group-hover:shadow-md">
                            <i data-lucide="download" class="w-3 h-3"></i> Prendre en charge
                        </a>
                    </div>
                    {% endfor %}
                    
                    {% for ticket in pool_users %}
                    <div class="bg-white dark:bg-slate-700 p-4 rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm hover:shadow-md hover:border-blue-200 dark:hover:border-blue-500 transition group">
                        <div class="flex justify-between mb-2">
                            <span class="text-[10px] font-bold text-blue-500 bg-blue-50 dark:bg-blue-900/30 px-2 py-0.5 rounded uppercase tracking-wider">Arrivée</span>
                            <span class="text-[10px] font-mono text-slate-400 dark:text-slate-500">#{{ ticket.uid_public }}</span>
                        </div>
                        <h4 class="font-bold text-sm text-slate-800 dark:text-slate-200 leading-tight mb-1">Nouvel Utilisateur</h4>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">{{ ticket.new_user_fullname }} ({{ ticket.new_user_service }})</p>
                        <a href="{{ url_for('tickets.take_ticket', ticket_id=ticket.id) }}" class="flex items-center justify-center w-full py-2 bg-slate-50 dark:bg-slate-600 text-slate-600 dark:text-slate-300 text-xs font-bold uppercase rounded-lg hover:bg-blue-600 hover:text-white transition gap-2">
                            <i data-lucide="download" class="w-3 h-3"></i> Prendre
                        </a>
                    </div>
                    {% endfor %}

                    {% for ticket in pool_bons %}
                    <div class="bg-white dark:bg-slate-700 p-4 rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm hover:shadow-md hover:border-purple-200 dark:hover:border-purple-500 transition group">
                        <div class="flex justify-between mb-2">
                            <span class="text-[10px] font-bold text-purple-500 bg-purple-50 dark:bg-purple-900/30 px-2 py-0.5 rounded uppercase tracking-wider">DAF</span>
                            <span class="text-[10px] font-mono text-slate-400 dark:text-slate-500">#{{ ticket.uid_public }}</span>
                        </div>
                        <h4 class="font-bold text-sm text-slate-800 dark:text-slate-200 leading-tight mb-1">Bon de Commande</h4>
                        <p class="text-xs text-purple-600 dark:text-purple-400 mb-2 truncate">{{ ticket.daf_fournisseur_nom }}</p>
                        <a href="{{ url_for('tickets.take_ticket', ticket_id=ticket.id) }}" class="flex items-center justify-center w-full py-2 bg-slate-50 dark:bg-slate-600 text-slate-600 dark:text-slate-300 text-xs font-bold uppercase rounded-lg hover:bg-purple-600 hover:text-white transition gap-2">
                            <i data-lucide="download" class="w-3 h-3"></i> Traiter
                        </a>
                    </div>
                    {% endfor %}

                    {% if not pool_standard and not pool_users and not pool_materiel and not pool_bons %}
                    <div class="h-full flex flex-col items-center justify-center opacity-40">
                        <i data-lucide="check-circle" class="w-12 h-12 text-slate-300 dark:text-slate-600 mb-2"></i>
                        <p class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase">Tout est calme</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- SIDEBAR DROITE (GRAPHIQUES & CHAT) -->
    <div class="hidden lg:flex flex-col gap-6">
        
        <!-- Graphique (Taille Réduite) -->
        <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 shadow-sm">
            <h3 class="font-bold text-slate-700 dark:text-slate-300 text-sm uppercase mb-4 text-center">Répartition</h3>
            <div class="h-32">
                <canvas id="ticketChart"></canvas>
            </div>
        </div>

        <!-- Chat Équipe -->
        <div class="bg-white dark:bg-slate-800 rounded-3xl border border-slate-200 dark:border-slate-700 shadow-sm flex-1 flex flex-col overflow-hidden h-[400px]">
            <div class="p-4 bg-slate-900 dark:bg-slate-950 text-white flex justify-between items-center">
                <span class="text-xs font-bold uppercase tracking-wider flex items-center gap-2"><i data-lucide="message-circle" class="w-4 h-4"></i> Chat Équipe</span>
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            </div>
            <div class="flex-1 bg-slate-50 dark:bg-slate-900 p-3 overflow-y-auto space-y-3" id="teamChatBox">
                <div class="text-xs text-center text-slate-400 italic">Connexion au chat...</div>
            </div>
            <div class="p-3 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700">
                <form id="teamChatForm" class="flex gap-2">
                    <input type="text" id="teamMsgInput" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg px-3 py-2 text-xs font-bold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Message d'équipe..." autocomplete="off">
                    <button type="submit" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition"><i data-lucide="send" class="w-4 h-4"></i></button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    lucide.createIcons();
    setInterval(() => { const d = new Date(); document.getElementById('liveClock').innerText = d.toLocaleTimeString(); }, 1000);

    const ctx = document.getElementById('ticketChart').getContext('2d');
    const ticketChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['À Traiter', 'En Cours', 'Terminés'],
            datasets: [{
                data: [{{ stats.pending }}, {{ stats.active }}, {{ stats.done }}],
                backgroundColor: ['#f97316', '#2563eb', '#10b981'],
                borderWidth: 0
            }]
        },
        options: { 
            cutout: '70%', 
            plugins: { legend: { display: false } },
            maintainAspectRatio: false
        }
    });

    // Chat Logic
    const chatBox = document.getElementById('teamChatBox');
    
    async function loadChat() {
        try {
            // CORRECTION URL: Utilisation de url_for pour être sûr du chemin
            const res = await fetch("{{ url_for('api.get_team_messages') }}");
            if (!res.ok) throw new Error('Chat API Error ' + res.status);
            
            const msgs = await res.json();
            chatBox.innerHTML = '';
            if (msgs.length === 0) {
                chatBox.innerHTML = '<div class="text-xs text-center text-slate-400 italic">Aucun message pour ce service.</div>';
                return;
            }

            msgs.forEach(m => {
                const isMe = m.is_me;
                chatBox.innerHTML += `
                    <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                        <span class="text-[9px] text-slate-400 mb-0.5 px-1">${m.user} • ${m.time}</span>
                        <div class="${isMe ? 'bg-blue-600 text-white' : 'bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300'} px-3 py-2 rounded-xl text-xs max-w-[80%] shadow-sm">
                            ${m.content}
                        </div>
                    </div>
                `;
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        } catch(e) {
            console.error(e);
            chatBox.innerHTML = '<div class="text-xs text-center text-red-400">Erreur de chargement du chat.</div>';
        }
    }

    document.getElementById('teamChatForm').onsubmit = async (e) => {
        e.preventDefault();
        const input = document.getElementById('teamMsgInput');
        if(!input.value.trim()) return;
        
        try {
            // CORRECTION URL POST
            const res = await fetch("{{ url_for('api.post_team_message') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({content: input.value})
            });
            if (!res.ok) throw new Error('Post failed');
            input.value = '';
            loadChat();
        } catch (e) {
            console.error("Post error", e);
            alert("Erreur lors de l'envoi du message.");
        }
    };

    setInterval(loadChat, 5000); 
    loadChat(); 
</script>
{% endblock %}



================================================
FILE: app/templates/tickets/solver_dashboard.html
================================================
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Espace Résolution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-slate-100 min-h-screen">

    <!-- Navbar Solver -->
    <nav class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center sticky top-0 z-20">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-1.5 rounded">
                <i data-lucide="wrench" class="w-5 h-5"></i>
            </div>
            <!-- CORRECTION CRITIQUE: Boucle sur les services autorisés -->
            <span class="font-bold">Espace Technicien <span class="opacity-50 mx-2">|</span> 
                {% for svc in current_user.get_allowed_services() %}
                    {{ svc }}{% if not loop.last %}, {% endif %}
                {% endfor %}
            </span>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-sm font-medium opacity-70">{{ current_user.fullname }}</span>
            <a href="{{ url_for('main.user_portal') }}" class="bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg text-sm transition">
                <i data-lucide="log-out" class="w-4 h-4 inline mr-1"></i> Quitter
            </a>
        </div>
    </nav>

    <div class="container mx-auto p-6 flex gap-6 h-[calc(100vh-80px)]">
        
        <!-- COLONNE GAUCHE : Pool & Menu -->
        <div class="w-1/4 flex flex-col gap-6 overflow-hidden">
            
            <!-- Stats Rapides -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center">
                    <span class="block text-2xl font-bold text-blue-600">{{ stats.active }}</span>
                    <span class="text-xs text-slate-500 uppercase font-bold tracking-wide">Mes Tickets</span>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center">
                    <span class="block text-2xl font-bold text-slate-700">{{ stats.pending }}</span>
                    <span class="text-xs text-slate-500 uppercase font-bold tracking-wide">En Attente</span>
                </div>
            </div>

            <!-- Pool Tickets (Non Attribués) -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 flex flex-col overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                    <h2 class="font-bold text-slate-700 flex items-center">
                        <i data-lucide="inbox" class="w-4 h-4 mr-2 text-slate-400"></i> File d'attente
                    </h2>
                    <span class="bg-red-100 text-red-600 text-xs font-bold px-2 py-0.5 rounded-full">{{ stats.pending }}</span>
                </div>
                
                <div class="overflow-y-auto p-2 space-y-2 flex-1 scrollbar-hide">
                    {% if pool_standard or pool_users or pool_materiel or pool_bons %}
                        
                        <!-- Catégorie: Incidents / Standard -->
                        {% for ticket in pool_standard %}
                        <div class="group bg-white hover:bg-blue-50 p-3 rounded-lg border border-slate-100 hover:border-blue-200 transition cursor-pointer relative">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-[10px] font-mono text-slate-400">#{{ ticket.uid_public }}</span>
                                <span class="bg-slate-100 text-slate-500 text-[10px] px-1.5 rounded">{{ ticket.created_at.strftime('%H:%M') }}</span>
                            </div>
                            <h3 class="font-bold text-sm text-slate-800 leading-tight mb-1">{{ ticket.title|truncate(30) }}</h3>
                            <p class="text-xs text-slate-500 mb-2 truncate">{{ ticket.author.fullname }} • {{ ticket.service_demandeur }}</p>
                            <a href="{{ url_for('tickets.take_ticket', ticket_id=ticket.id) }}" class="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 bg-blue-600 text-white p-1.5 rounded-md shadow-lg transition transform scale-90 hover:scale-100">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </a>
                        </div>
                        {% endfor %}

                        <!-- Autres catégories -->
                        {% for ticket in pool_users %}
                        <div class="group bg-blue-50 hover:bg-blue-100 p-3 rounded-lg border border-blue-100 transition cursor-pointer relative">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-[10px] font-mono text-blue-400">#{{ ticket.uid_public }}</span>
                                <span class="bg-white text-blue-600 text-[10px] px-1.5 rounded font-bold">USER</span>
                            </div>
                            <h3 class="font-bold text-sm text-blue-900 leading-tight mb-1">Nouvel Arrivant</h3>
                            <p class="text-xs text-blue-600 mb-2 truncate">{{ ticket.new_user_fullname }}</p>
                            <a href="{{ url_for('tickets.take_ticket', ticket_id=ticket.id) }}" class="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 bg-blue-600 text-white p-1.5 rounded-md shadow-lg transition">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </a>
                        </div>
                        {% endfor %}

                        {% for ticket in pool_bons %}
                        <div class="group bg-purple-50 hover:bg-purple-100 p-3 rounded-lg border border-purple-100 transition cursor-pointer relative">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-[10px] font-mono text-purple-400">#{{ ticket.uid_public }}</span>
                                <span class="bg-white text-purple-600 text-[10px] px-1.5 rounded font-bold">DAF</span>
                            </div>
                            <h3 class="font-bold text-sm text-purple-900 leading-tight mb-1">Bon de Commande</h3>
                            <p class="text-xs text-purple-600 mb-2 truncate">{{ ticket.daf_fournisseur_nom }}</p>
                            <a href="{{ url_for('tickets.take_ticket', ticket_id=ticket.id) }}" class="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 bg-purple-600 text-white p-1.5 rounded-md shadow-lg transition">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </a>
                        </div>
                        {% endfor %}

                    {% else %}
                        <div class="text-center py-8 opacity-50">
                            <i data-lucide="coffee" class="w-8 h-8 mx-auto mb-2 text-slate-300"></i>
                            <p class="text-xs text-slate-400">Aucun ticket en attente.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- COLONNE DROITE : Espace de Travail -->
        <div class="w-3/4 flex flex-col gap-6">
            
            <!-- Mes Tickets En Cours -->
            <div class="flex-1 overflow-y-auto pr-2 space-y-4">
                <h2 class="font-bold text-lg text-slate-800 flex items-center mb-4">
                    <i data-lucide="play-circle" class="w-5 h-5 mr-2 text-blue-500"></i> En cours de traitement
                </h2>

                {% for ticket in mine %}
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition">
                    <div class="flex">
                        <!-- Bandeau Latéral -->
                        <div class="w-2 bg-blue-500"></div>
                        
                        <!-- Contenu -->
                        <div class="flex-1 p-5">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800">{{ ticket.title }}</h3>
                                    <p class="text-sm text-slate-500">
                                        Par <span class="font-semibold text-slate-700">{{ ticket.author.fullname }}</span> 
                                        ({{ ticket.service_demandeur }}) 
                                        <span class="mx-2">•</span> 
                                        <span class="font-mono text-xs bg-slate-100 px-1 rounded">{{ ticket.uid_public }}</span>
                                    </p>
                                </div>
                                <div class="flex gap-2">
                                    <a href="{{ url_for('tickets.view_ticket', ticket_uid=ticket.uid_public) }}" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg text-sm font-medium transition flex items-center">
                                        <i data-lucide="eye" class="w-4 h-4 mr-1.5"></i> Détails
                                    </a>
                                    <!-- Menu Actions -->
                                    <div class="relative group">
                                        <button class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg text-sm font-medium transition">
                                            Actions
                                        </button>
                                        <div class="absolute right-0 mt-2 w-48 bg-white border border-slate-100 rounded-lg shadow-xl hidden group-hover:block z-10 p-1">
                                            <a href="{{ url_for('tickets.close_ticket', ticket_id=ticket.id) }}" class="block px-4 py-2 text-sm text-green-600 hover:bg-green-50 rounded flex items-center">
                                                <i data-lucide="check" class="w-4 h-4 mr-2"></i> Clôturer
                                            </a>
                                            
                                            <!-- Formulaire Transfert Rapide -->
                                            <div class="border-t border-slate-100 mt-1 pt-1 px-4 py-2">
                                                <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Transférer à</p>
                                                <form action="{{ url_for('tickets.transfer_ticket', ticket_id=ticket.id) }}" method="POST">
                                                    <select name="target_service" onchange="this.form.submit()" class="w-full text-xs bg-slate-50 border border-slate-200 rounded p-1">
                                                        <option value="">-- Service --</option>
                                                        {% for s in services %}
                                                            {% if s.name not in current_user.get_allowed_services() %}
                                                            <option value="{{ s.name }}">{{ s.value }}</option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                </form>
                                            </div>

                                            <!-- Formulaire Assignation Rapide -->
                                            <div class="border-t border-slate-100 mt-1 pt-1 px-4 py-2">
                                                <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Assigner à</p>
                                                <form action="{{ url_for('tickets.assign_ticket', ticket_id=ticket.id) }}" method="POST">
                                                    <select name="solver_id" onchange="this.form.submit()" class="w-full text-xs bg-slate-50 border border-slate-200 rounded p-1">
                                                        <option value="">-- Collègue --</option>
                                                        {% for s in solvers %}
                                                            {% if s.id != current_user.id %}
                                                            <option value="{{ s.id }}">{{ s.fullname }}</option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-slate-50 rounded-lg p-3 text-sm text-slate-600 mb-4 border border-slate-100">
                                {{ ticket.description|truncate(150) }}
                            </div>

                            <div class="flex items-center justify-between text-xs text-slate-500">
                                <div class="flex gap-4">
                                    {% if ticket.tel_demandeur %}
                                    <span class="flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> {{ ticket.tel_demandeur }}</span>
                                    {% endif %}
                                    {% if ticket.hostname %}
                                    <div class="flex items-center gap-2 bg-slate-100 px-3 py-1 rounded text-xs font-mono text-slate-600">
                                        <i data-lucide="monitor" class="w-3 h-3"></i> {{ ticket.hostname }}
                                    </div>
                                    {% endif %}
                                </div>
                                <!-- Zone Chat (Placeholder pour la V2) -->
                                <div class="w-1/3 border-l border-slate-100 pl-4 flex flex-col justify-center items-center text-center">
                                    <div class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 mb-2">
                                        <i data-lucide="message-square" class="w-5 h-5"></i>
                                    </div>
                                    <p class="text-xs text-slate-400">Chat avec {{ ticket.author.fullname }}<br>(À venir)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-12 bg-white rounded-xl border border-dashed border-slate-300">
                    <p class="text-slate-500 font-medium">Vous n'avez aucun ticket en cours.</p>
                    <p class="text-slate-400 text-sm">Prenez-en un dans la file d'attente !</p>
                </div>
                {% endfor %}
            </div>

        </div>
    </div>

    <script>lucide.createIcons();</script>
</body>
</html>



================================================
FILE: migrations/README
================================================
Single-database configuration for Flask.



================================================
FILE: migrations/alembic.ini
================================================
# A generic, single database configuration.

[alembic]
# template used to generate migration files
# file_template = %%(rev)s_%%(slug)s

# set to 'true' to run the environment during
# the 'revision' command, regardless of autogenerate
# revision_environment = false


# Logging configuration
[loggers]
keys = root,sqlalchemy,alembic,flask_migrate

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console
qualname =

[logger_sqlalchemy]
level = WARN
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[logger_flask_migrate]
level = INFO
handlers =
qualname = flask_migrate

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S



================================================
FILE: migrations/env.py
================================================
import logging
from logging.config import fileConfig

from flask import current_app

from alembic import context

# this is the Alembic Config object, which provides
# access to the values within the .ini file in use.
config = context.config

# Interpret the config file for Python logging.
# This line sets up loggers basically.
fileConfig(config.config_file_name)
logger = logging.getLogger('alembic.env')


def get_engine():
    try:
        # this works with Flask-SQLAlchemy<3 and Alchemical
        return current_app.extensions['migrate'].db.get_engine()
    except (TypeError, AttributeError):
        # this works with Flask-SQLAlchemy>=3
        return current_app.extensions['migrate'].db.engine


def get_engine_url():
    try:
        return get_engine().url.render_as_string(hide_password=False).replace(
            '%', '%%')
    except AttributeError:
        return str(get_engine().url).replace('%', '%%')


# add your model's MetaData object here
# for 'autogenerate' support
# from myapp import mymodel
# target_metadata = mymodel.Base.metadata
config.set_main_option('sqlalchemy.url', get_engine_url())
target_db = current_app.extensions['migrate'].db

# other values from the config, defined by the needs of env.py,
# can be acquired:
# my_important_option = config.get_main_option("my_important_option")
# ... etc.


def get_metadata():
    if hasattr(target_db, 'metadatas'):
        return target_db.metadatas[None]
    return target_db.metadata


def run_migrations_offline():
    """Run migrations in 'offline' mode.

    This configures the context with just a URL
    and not an Engine, though an Engine is acceptable
    here as well.  By skipping the Engine creation
    we don't even need a DBAPI to be available.

    Calls to context.execute() here emit the given string to the
    script output.

    """
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url, target_metadata=get_metadata(), literal_binds=True
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online():
    """Run migrations in 'online' mode.

    In this scenario we need to create an Engine
    and associate a connection with the context.

    """

    # this callback is used to prevent an auto-migration from being generated
    # when there are no changes to the schema
    # reference: http://alembic.zzzcomputing.com/en/latest/cookbook.html
    def process_revision_directives(context, revision, directives):
        if getattr(config.cmd_opts, 'autogenerate', False):
            script = directives[0]
            if script.upgrade_ops.is_empty():
                directives[:] = []
                logger.info('No changes in schema detected.')

    conf_args = current_app.extensions['migrate'].configure_args
    if conf_args.get("process_revision_directives") is None:
        conf_args["process_revision_directives"] = process_revision_directives

    connectable = get_engine()

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=get_metadata(),
            **conf_args
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()



================================================
FILE: migrations/script.py.mako
================================================
"""${message}

Revision ID: ${up_revision}
Revises: ${down_revision | comma,n}
Create Date: ${create_date}

"""
from alembic import op
import sqlalchemy as sa
${imports if imports else ""}

# revision identifiers, used by Alembic.
revision = ${repr(up_revision)}
down_revision = ${repr(down_revision)}
branch_labels = ${repr(branch_labels)}
depends_on = ${repr(depends_on)}


def upgrade():
    ${upgrades if upgrades else "pass"}


def downgrade():
    ${downgrades if downgrades else "pass"}



================================================
FILE: migrations/versions/068a52b5c548_maj_formulaire_daf.py
================================================
"""Maj formulaire DAF

Revision ID: 068a52b5c548
Revises: 114d53f55048
Create Date: 2026-01-19 10:20:08.069476

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '068a52b5c548'
down_revision = '114d53f55048'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('recruitments',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uid_public', sa.String(length=20), nullable=True),
    sa.Column('author_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('status', sa.Enum('WAITING_RH_MGR', 'WAITING_RH_DIR', 'REFUSED', 'DISPATCHED', 'DONE', name='recruitmentstatus'), nullable=True),
    sa.Column('date_entree', sa.DateTime(), nullable=True),
    sa.Column('nom_agent', sa.String(length=100), nullable=True),
    sa.Column('prenom_agent', sa.String(length=100), nullable=True),
    sa.Column('fonction', sa.String(length=100), nullable=True),
    sa.Column('service_agent', sa.String(length=100), nullable=True),
    sa.Column('uf_agent', sa.String(length=50), nullable=True),
    sa.Column('contractuel', sa.Boolean(), nullable=True),
    sa.Column('date_debut_contrat', sa.DateTime(), nullable=True),
    sa.Column('date_fin_contrat', sa.DateTime(), nullable=True),
    sa.Column('condition_recrutement', sa.String(length=50), nullable=True),
    sa.Column('temps_travail', sa.String(length=50), nullable=True),
    sa.Column('pourcentage_temps', sa.String(length=20), nullable=True),
    sa.Column('motif_recrutement', sa.String(length=50), nullable=True),
    sa.Column('simulation_salaire', sa.Boolean(), nullable=True),
    sa.Column('localisation_poste', sa.String(length=100), nullable=True),
    sa.Column('commentaire_securite', sa.Text(), nullable=True),
    sa.Column('imago_active', sa.Boolean(), nullable=True),
    sa.Column('imago_mobilite', sa.String(length=200), nullable=True),
    sa.Column('materiels_demandes', sa.String(length=255), nullable=True),
    sa.Column('acces_informatique', sa.Text(), nullable=True),
    sa.Column('file_cv', sa.String(length=255), nullable=True),
    sa.Column('file_fiche_poste', sa.String(length=255), nullable=True),
    sa.Column('file_photo', sa.String(length=255), nullable=True),
    sa.Column('refusal_reason', sa.Text(), nullable=True),
    sa.Column('child_tickets_ids', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['author_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('recruitments', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_recruitments_uid_public'), ['uid_public'], unique=True)

    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.drop_column('fcpi_date_entree')
        batch_op.drop_column('fcpi_nom')
        batch_op.drop_column('fcpi_badge_commentaire')
        batch_op.drop_column('fcpi_imago_sites')
        batch_op.drop_column('fcpi_statut_secu')
        batch_op.drop_column('fcpi_temps_travail')
        batch_op.drop_column('fcpi_service')
        batch_op.drop_column('fcpi_contractuel')
        batch_op.drop_column('fcpi_date_fin_contrat')
        batch_op.drop_column('fcpi_date_debut_contrat')
        batch_op.drop_column('fcpi_imago_active')
        batch_op.drop_column('fcpi_simulation_salaire')
        batch_op.drop_column('fcpi_acces_info')
        batch_op.drop_column('fcpi_materiel_json')
        batch_op.drop_column('fcpi_pourcentage')
        batch_op.drop_column('fcpi_prenom')
        batch_op.drop_column('fcpi_statut_info')
        batch_op.drop_column('fcpi_statut_imago')
        batch_op.drop_column('fcpi_condition')
        batch_op.drop_column('fcpi_motif')
        batch_op.drop_column('fcpi_file_photo')
        batch_op.drop_column('fcpi_file_poste')
        batch_op.drop_column('fcpi_fonction')
        batch_op.drop_column('fcpi_statut_drh')
        batch_op.drop_column('fcpi_uf')
        batch_op.drop_column('fcpi_file_cv')
        batch_op.drop_column('fcpi_localisation')

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.add_column(sa.Column('fcpi_localisation', sa.VARCHAR(length=150), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_file_cv', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_uf', sa.VARCHAR(length=50), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_drh', sa.VARCHAR(length=20), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_fonction', sa.VARCHAR(length=100), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_file_poste', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_file_photo', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_motif', sa.VARCHAR(length=50), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_condition', sa.VARCHAR(length=50), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_imago', sa.VARCHAR(length=20), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_info', sa.VARCHAR(length=20), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_prenom', sa.VARCHAR(length=100), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_pourcentage', sa.VARCHAR(length=10), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_materiel_json', sa.TEXT(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_acces_info', sa.TEXT(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_simulation_salaire', sa.BOOLEAN(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_imago_active', sa.BOOLEAN(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_date_debut_contrat', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_date_fin_contrat', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_contractuel', sa.VARCHAR(length=10), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_service', sa.VARCHAR(length=100), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_temps_travail', sa.VARCHAR(length=50), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_secu', sa.VARCHAR(length=20), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_imago_sites', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_badge_commentaire', sa.TEXT(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_nom', sa.VARCHAR(length=100), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_date_entree', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))

    with op.batch_alter_table('recruitments', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_recruitments_uid_public'))

    op.drop_table('recruitments')
    # ### end Alembic commands ###



================================================
FILE: migrations/versions/0901c63adb4b_maj_formulaire_daf.py
================================================
"""Maj formulaire DAF

Revision ID: 0901c63adb4b
Revises: 118a1f52bf93
Create Date: 2026-01-16 12:31:40.070487

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '0901c63adb4b'
down_revision = '118a1f52bf93'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.add_column(sa.Column('daf_solver_file', sa.String(length=255), nullable=True))
        batch_op.add_column(sa.Column('daf_signed_file', sa.String(length=255), nullable=True))

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.drop_column('daf_signed_file')
        batch_op.drop_column('daf_solver_file')

    # ### end Alembic commands ###



================================================
FILE: migrations/versions/114d53f55048_creation_formulaire_fcpi.py
================================================
"""Creation formulaire FCPI

Revision ID: 114d53f55048
Revises: bf90708aee1c
Create Date: 2026-01-16 15:55:37.552888

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '114d53f55048'
down_revision = 'bf90708aee1c'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.add_column(sa.Column('fcpi_date_entree', sa.DateTime(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_nom', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('fcpi_prenom', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('fcpi_fonction', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('fcpi_service', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('fcpi_uf', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('fcpi_contractuel', sa.String(length=10), nullable=True))
        batch_op.add_column(sa.Column('fcpi_date_debut_contrat', sa.DateTime(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_date_fin_contrat', sa.DateTime(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_condition', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('fcpi_temps_travail', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('fcpi_pourcentage', sa.String(length=10), nullable=True))
        batch_op.add_column(sa.Column('fcpi_motif', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('fcpi_simulation_salaire', sa.Boolean(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_localisation', sa.String(length=150), nullable=True))
        batch_op.add_column(sa.Column('fcpi_badge_commentaire', sa.Text(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_imago_active', sa.Boolean(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_imago_sites', sa.String(length=255), nullable=True))
        batch_op.add_column(sa.Column('fcpi_acces_info', sa.Text(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_materiel_json', sa.Text(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_file_cv', sa.String(length=255), nullable=True))
        batch_op.add_column(sa.Column('fcpi_file_poste', sa.String(length=255), nullable=True))
        batch_op.add_column(sa.Column('fcpi_file_photo', sa.String(length=255), nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_drh', sa.String(length=20), nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_secu', sa.String(length=20), nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_info', sa.String(length=20), nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_imago', sa.String(length=20), nullable=True))

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.drop_column('fcpi_statut_imago')
        batch_op.drop_column('fcpi_statut_info')
        batch_op.drop_column('fcpi_statut_secu')
        batch_op.drop_column('fcpi_statut_drh')
        batch_op.drop_column('fcpi_file_photo')
        batch_op.drop_column('fcpi_file_poste')
        batch_op.drop_column('fcpi_file_cv')
        batch_op.drop_column('fcpi_materiel_json')
        batch_op.drop_column('fcpi_acces_info')
        batch_op.drop_column('fcpi_imago_sites')
        batch_op.drop_column('fcpi_imago_active')
        batch_op.drop_column('fcpi_badge_commentaire')
        batch_op.drop_column('fcpi_localisation')
        batch_op.drop_column('fcpi_simulation_salaire')
        batch_op.drop_column('fcpi_motif')
        batch_op.drop_column('fcpi_pourcentage')
        batch_op.drop_column('fcpi_temps_travail')
        batch_op.drop_column('fcpi_condition')
        batch_op.drop_column('fcpi_date_fin_contrat')
        batch_op.drop_column('fcpi_date_debut_contrat')
        batch_op.drop_column('fcpi_contractuel')
        batch_op.drop_column('fcpi_uf')
        batch_op.drop_column('fcpi_service')
        batch_op.drop_column('fcpi_fonction')
        batch_op.drop_column('fcpi_prenom')
        batch_op.drop_column('fcpi_nom')
        batch_op.drop_column('fcpi_date_entree')

    # ### end Alembic commands ###



================================================
FILE: migrations/versions/118a1f52bf93_maj_formulaire_daf.py
================================================
"""Maj formulaire DAF

Revision ID: 118a1f52bf93
Revises: 2eecb37fbc37
Create Date: 2026-01-16 11:17:44.884755

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '118a1f52bf93'
down_revision = '2eecb37fbc37'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.add_column(sa.Column('daf_uf', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('daf_budget_affecte', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('daf_new_supplier', sa.Boolean(), nullable=True))
        batch_op.add_column(sa.Column('daf_siret', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('daf_fournisseur_tel_comment', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('daf_rib_file', sa.String(length=255), nullable=True))

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.drop_column('daf_rib_file')
        batch_op.drop_column('daf_fournisseur_tel_comment')
        batch_op.drop_column('daf_siret')
        batch_op.drop_column('daf_new_supplier')
        batch_op.drop_column('daf_budget_affecte')
        batch_op.drop_column('daf_uf')

    # ### end Alembic commands ###



================================================
FILE: migrations/versions/153533dd96a0_maj_formulaire_daf.py
================================================
"""Maj formulaire DAF

Revision ID: 153533dd96a0
Revises: 4acfea4b356b
Create Date: 2026-01-16 13:58:18.712033

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '153533dd96a0'
down_revision = '4acfea4b356b'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.drop_column('daf_uf')
        batch_op.drop_column('daf_rib_file')
        batch_op.drop_column('daf_budget_line')
        batch_op.drop_column('daf_signed_file')
        batch_op.drop_column('daf_fournisseur_is_new')
        batch_op.drop_column('daf_solver_file')
        batch_op.drop_column('daf_siret')

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.add_column(sa.Column('daf_siret', sa.VARCHAR(length=50), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('daf_solver_file', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('daf_fournisseur_is_new', sa.BOOLEAN(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('daf_signed_file', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('daf_budget_line', sa.VARCHAR(length=100), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('daf_rib_file', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('daf_uf', sa.VARCHAR(length=50), autoincrement=False, nullable=True))

    # ### end Alembic commands ###



================================================
FILE: migrations/versions/2eecb37fbc37_ajout_groupes_json_et_workflow_n2.py
================================================
"""Ajout groupes JSON et workflow N2

Revision ID: 2eecb37fbc37
Revises: faea908d11f5
Create Date: 2026-01-13 11:05:40.578128

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '2eecb37fbc37'
down_revision = 'faea908d11f5'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.add_column(sa.Column('origin_services_json', sa.Text(), nullable=True))
        batch_op.add_column(sa.Column('allowed_services_json', sa.Text(), nullable=True))
        batch_op.add_column(sa.Column('location', sa.String(length=100), nullable=True))
        batch_op.drop_column('service_department')

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.add_column(sa.Column('service_department', postgresql.ENUM('INFO', 'DAF', 'GEN', 'TECH', 'ENLEV', name='servicetype'), autoincrement=False, nullable=True))
        batch_op.drop_column('location')
        batch_op.drop_column('allowed_services_json')
        batch_op.drop_column('origin_services_json')

    # ### end Alembic commands ###



================================================
FILE: migrations/versions/4acfea4b356b_maj_formulaire_daf.py
================================================
"""Maj formulaire DAF

Revision ID: 4acfea4b356b
Revises: 0901c63adb4b
Create Date: 2026-01-16 13:35:55.525552

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '4acfea4b356b'
down_revision = '0901c63adb4b'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.add_column(sa.Column('daf_budget_line', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('daf_fournisseur_is_new', sa.Boolean(), nullable=True))
        batch_op.drop_column('daf_budget_affecte')
        batch_op.drop_column('daf_fournisseur_tel_comment')
        batch_op.drop_column('daf_new_supplier')

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.add_column(sa.Column('daf_new_supplier', sa.BOOLEAN(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('daf_fournisseur_tel_comment', sa.VARCHAR(length=100), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('daf_budget_affecte', sa.VARCHAR(length=100), autoincrement=False, nullable=True))
        batch_op.drop_column('daf_fournisseur_is_new')
        batch_op.drop_column('daf_budget_line')

    # ### end Alembic commands ###



================================================
FILE: migrations/versions/a0c4c67305ee_creation_formulaire_fcpi.py
================================================
"""Creation formulaire FCPI

Revision ID: a0c4c67305ee
Revises: f94c753e54db
Create Date: 2026-01-16 15:49:19.587110

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = 'a0c4c67305ee'
down_revision = 'f94c753e54db'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.add_column(sa.Column('fcpi_date_entree', sa.DateTime(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_nom', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('fcpi_prenom', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('fcpi_fonction', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('fcpi_service', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('fcpi_uf', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('fcpi_contractuel', sa.String(length=10), nullable=True))
        batch_op.add_column(sa.Column('fcpi_date_debut_contrat', sa.DateTime(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_date_fin_contrat', sa.DateTime(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_condition', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('fcpi_temps_travail', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('fcpi_pourcentage', sa.String(length=10), nullable=True))
        batch_op.add_column(sa.Column('fcpi_motif', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('fcpi_simulation_salaire', sa.Boolean(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_localisation', sa.String(length=150), nullable=True))
        batch_op.add_column(sa.Column('fcpi_badge_commentaire', sa.Text(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_imago_active', sa.Boolean(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_imago_sites', sa.String(length=255), nullable=True))
        batch_op.add_column(sa.Column('fcpi_acces_info', sa.Text(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_materiel_json', sa.Text(), nullable=True))
        batch_op.add_column(sa.Column('fcpi_file_cv', sa.String(length=255), nullable=True))
        batch_op.add_column(sa.Column('fcpi_file_poste', sa.String(length=255), nullable=True))
        batch_op.add_column(sa.Column('fcpi_file_photo', sa.String(length=255), nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_drh', sa.String(length=20), nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_secu', sa.String(length=20), nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_info', sa.String(length=20), nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_imago', sa.String(length=20), nullable=True))

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.drop_column('fcpi_statut_imago')
        batch_op.drop_column('fcpi_statut_info')
        batch_op.drop_column('fcpi_statut_secu')
        batch_op.drop_column('fcpi_statut_drh')
        batch_op.drop_column('fcpi_file_photo')
        batch_op.drop_column('fcpi_file_poste')
        batch_op.drop_column('fcpi_file_cv')
        batch_op.drop_column('fcpi_materiel_json')
        batch_op.drop_column('fcpi_acces_info')
        batch_op.drop_column('fcpi_imago_sites')
        batch_op.drop_column('fcpi_imago_active')
        batch_op.drop_column('fcpi_badge_commentaire')
        batch_op.drop_column('fcpi_localisation')
        batch_op.drop_column('fcpi_simulation_salaire')
        batch_op.drop_column('fcpi_motif')
        batch_op.drop_column('fcpi_pourcentage')
        batch_op.drop_column('fcpi_temps_travail')
        batch_op.drop_column('fcpi_condition')
        batch_op.drop_column('fcpi_date_fin_contrat')
        batch_op.drop_column('fcpi_date_debut_contrat')
        batch_op.drop_column('fcpi_contractuel')
        batch_op.drop_column('fcpi_uf')
        batch_op.drop_column('fcpi_service')
        batch_op.drop_column('fcpi_fonction')
        batch_op.drop_column('fcpi_prenom')
        batch_op.drop_column('fcpi_nom')
        batch_op.drop_column('fcpi_date_entree')

    # ### end Alembic commands ###



================================================
FILE: migrations/versions/a7f8fe4f2491_maj_formulaire_fcpi.py
================================================
"""Maj formulaire FCPI

Revision ID: a7f8fe4f2491
Revises: 068a52b5c548
Create Date: 2026-01-19 12:10:27.134769

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = 'a7f8fe4f2491'
down_revision = '068a52b5c548'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.alter_column('uid_public',
               existing_type=sa.VARCHAR(length=20),
               type_=sa.String(length=30),
               existing_nullable=True)

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.alter_column('uid_public',
               existing_type=sa.String(length=30),
               type_=sa.VARCHAR(length=20),
               existing_nullable=True)

    # ### end Alembic commands ###



================================================
FILE: migrations/versions/bf90708aee1c_creation_formulaire_fcpi.py
================================================
"""Creation formulaire FCPI

Revision ID: bf90708aee1c
Revises: a0c4c67305ee
Create Date: 2026-01-16 15:54:49.211063

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = 'bf90708aee1c'
down_revision = 'a0c4c67305ee'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.drop_column('fcpi_file_poste')
        batch_op.drop_column('fcpi_temps_travail')
        batch_op.drop_column('fcpi_statut_imago')
        batch_op.drop_column('fcpi_badge_commentaire')
        batch_op.drop_column('fcpi_fonction')
        batch_op.drop_column('fcpi_statut_secu')
        batch_op.drop_column('fcpi_acces_info')
        batch_op.drop_column('fcpi_imago_sites')
        batch_op.drop_column('fcpi_simulation_salaire')
        batch_op.drop_column('fcpi_motif')
        batch_op.drop_column('fcpi_pourcentage')
        batch_op.drop_column('fcpi_contractuel')
        batch_op.drop_column('fcpi_date_entree')
        batch_op.drop_column('fcpi_file_cv')
        batch_op.drop_column('fcpi_date_fin_contrat')
        batch_op.drop_column('fcpi_statut_drh')
        batch_op.drop_column('fcpi_file_photo')
        batch_op.drop_column('fcpi_localisation')
        batch_op.drop_column('fcpi_statut_info')
        batch_op.drop_column('fcpi_prenom')
        batch_op.drop_column('fcpi_service')
        batch_op.drop_column('fcpi_nom')
        batch_op.drop_column('fcpi_materiel_json')
        batch_op.drop_column('fcpi_uf')
        batch_op.drop_column('fcpi_imago_active')
        batch_op.drop_column('fcpi_condition')
        batch_op.drop_column('fcpi_date_debut_contrat')

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.add_column(sa.Column('fcpi_date_debut_contrat', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_condition', sa.VARCHAR(length=50), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_imago_active', sa.BOOLEAN(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_uf', sa.VARCHAR(length=50), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_materiel_json', sa.TEXT(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_nom', sa.VARCHAR(length=100), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_service', sa.VARCHAR(length=100), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_prenom', sa.VARCHAR(length=100), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_info', sa.VARCHAR(length=20), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_localisation', sa.VARCHAR(length=150), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_file_photo', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_drh', sa.VARCHAR(length=20), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_date_fin_contrat', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_file_cv', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_date_entree', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_contractuel', sa.VARCHAR(length=10), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_pourcentage', sa.VARCHAR(length=10), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_motif', sa.VARCHAR(length=50), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_simulation_salaire', sa.BOOLEAN(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_imago_sites', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_acces_info', sa.TEXT(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_secu', sa.VARCHAR(length=20), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_fonction', sa.VARCHAR(length=100), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_badge_commentaire', sa.TEXT(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_statut_imago', sa.VARCHAR(length=20), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_temps_travail', sa.VARCHAR(length=50), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('fcpi_file_poste', sa.VARCHAR(length=255), autoincrement=False, nullable=True))

    # ### end Alembic commands ###



================================================
FILE: migrations/versions/f94c753e54db_maj_formulaire_daf.py
================================================
"""Maj formulaire DAF

Revision ID: f94c753e54db
Revises: 153533dd96a0
Create Date: 2026-01-16 14:02:24.366110

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = 'f94c753e54db'
down_revision = '153533dd96a0'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.add_column(sa.Column('daf_uf', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('daf_budget_affecte', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('daf_new_supplier', sa.Boolean(), nullable=True))
        batch_op.add_column(sa.Column('daf_siret', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('daf_fournisseur_tel_comment', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('daf_rib_file', sa.String(length=255), nullable=True))
        batch_op.add_column(sa.Column('daf_solver_file', sa.String(length=255), nullable=True))
        batch_op.add_column(sa.Column('daf_signed_file', sa.String(length=255), nullable=True))

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.drop_column('daf_signed_file')
        batch_op.drop_column('daf_solver_file')
        batch_op.drop_column('daf_rib_file')
        batch_op.drop_column('daf_fournisseur_tel_comment')
        batch_op.drop_column('daf_siret')
        batch_op.drop_column('daf_new_supplier')
        batch_op.drop_column('daf_budget_affecte')
        batch_op.drop_column('daf_uf')

    # ### end Alembic commands ###



================================================
FILE: migrations/versions/faea908d11f5_reset_full_schema.py
================================================
"""Reset Full Schema

Revision ID: faea908d11f5
Revises: 
Create Date: 2025-12-30 10:34:50.150292

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = 'faea908d11f5'
down_revision = None
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('materiels',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('categorie', sa.String(length=50), nullable=True),
    sa.Column('modele', sa.String(length=100), nullable=True),
    sa.Column('sn', sa.String(length=100), nullable=True),
    sa.Column('hostname', sa.String(length=100), nullable=True),
    sa.Column('imei', sa.String(length=100), nullable=True),
    sa.Column('statut', sa.String(length=50), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('sn')
    )
    op.create_table('users',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('username', sa.String(length=64), nullable=True),
    sa.Column('fullname', sa.String(length=120), nullable=True),
    sa.Column('email', sa.String(length=120), nullable=True),
    sa.Column('role', sa.Enum('USER', 'MANAGER', 'ADMIN', 'SOLVER', name='userrole'), nullable=True),
    sa.Column('service_department', sa.Enum('INFO', 'DAF', 'GEN', 'TECH', 'ENLEV', name='servicetype'), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_users_username'), ['username'], unique=True)

    op.create_table('notifications',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('message', sa.String(length=255), nullable=False),
    sa.Column('category', sa.String(length=20), nullable=True),
    sa.Column('link', sa.String(length=255), nullable=True),
    sa.Column('is_read', sa.Boolean(), nullable=True),
    sa.Column('timestamp', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('prets',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('materiel_id', sa.Integer(), nullable=True),
    sa.Column('technicien_id', sa.Integer(), nullable=True),
    sa.Column('nom_emprunteur', sa.String(length=100), nullable=True),
    sa.Column('prenom_emprunteur', sa.String(length=100), nullable=True),
    sa.Column('service_emprunteur', sa.String(length=100), nullable=True),
    sa.Column('date_sortie', sa.DateTime(), nullable=True),
    sa.Column('date_retour_prevue', sa.DateTime(), nullable=True),
    sa.Column('date_retour_reelle', sa.DateTime(), nullable=True),
    sa.Column('statut_dossier', sa.String(length=20), nullable=True),
    sa.Column('type_pret', sa.String(length=50), nullable=True),
    sa.Column('accessoires', sa.String(length=255), nullable=True),
    sa.Column('etat_ecran_sortie', sa.String(length=50), nullable=True),
    sa.Column('etat_clavier_sortie', sa.String(length=50), nullable=True),
    sa.Column('etat_coque_sortie', sa.String(length=50), nullable=True),
    sa.Column('etat_ecran_retour', sa.String(length=50), nullable=True),
    sa.Column('etat_clavier_retour', sa.String(length=50), nullable=True),
    sa.Column('etat_coque_retour', sa.String(length=50), nullable=True),
    sa.ForeignKeyConstraint(['materiel_id'], ['materiels.id'], ),
    sa.ForeignKeyConstraint(['technicien_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('team_messages',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('service', sa.Enum('INFO', 'DAF', 'GEN', 'TECH', 'ENLEV', name='servicetype'), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('timestamp', sa.DateTime(), nullable=True),
    sa.Column('author_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['author_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('tickets',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uid_public', sa.String(length=20), nullable=True),
    sa.Column('title', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=False),
    sa.Column('author_id', sa.Integer(), nullable=True),
    sa.Column('target_service', sa.Enum('INFO', 'DAF', 'GEN', 'TECH', 'ENLEV', name='servicetype'), nullable=False),
    sa.Column('status', sa.Enum('DRAFT', 'VALIDATION', 'PENDING', 'IN_PROGRESS', 'REFUSED', 'DONE', name='ticketstatus'), nullable=True),
    sa.Column('solver_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('closed_at', sa.DateTime(), nullable=True),
    sa.Column('category_ticket', sa.String(length=50), nullable=True),
    sa.Column('hostname', sa.String(length=64), nullable=True),
    sa.Column('service_demandeur', sa.String(length=100), nullable=True),
    sa.Column('tel_demandeur', sa.String(length=20), nullable=True),
    sa.Column('lieu_installation', sa.String(length=100), nullable=True),
    sa.Column('new_user_fullname', sa.String(length=150), nullable=True),
    sa.Column('new_user_service', sa.String(length=100), nullable=True),
    sa.Column('new_user_acces', sa.String(length=255), nullable=True),
    sa.Column('new_user_date', sa.DateTime(), nullable=True),
    sa.Column('materiel_list', sa.Text(), nullable=True),
    sa.Column('destinataire_materiel', sa.String(length=150), nullable=True),
    sa.Column('service_destinataire', sa.String(length=100), nullable=True),
    sa.Column('daf_lieu_livraison', sa.String(length=100), nullable=True),
    sa.Column('daf_fournisseur_nom', sa.String(length=100), nullable=True),
    sa.Column('daf_fournisseur_tel', sa.String(length=50), nullable=True),
    sa.Column('daf_fournisseur_fax', sa.String(length=50), nullable=True),
    sa.Column('daf_fournisseur_email', sa.String(length=100), nullable=True),
    sa.Column('daf_type_prix', sa.String(length=10), nullable=True),
    sa.Column('daf_lignes_json', sa.Text(), nullable=True),
    sa.Column('daf_files_json', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['author_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['solver_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_tickets_uid_public'), ['uid_public'], unique=True)

    op.create_table('ticket_messages',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('timestamp', sa.DateTime(), nullable=True),
    sa.Column('ticket_id', sa.Integer(), nullable=True),
    sa.Column('author_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['author_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['ticket_id'], ['tickets.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('ticket_messages')
    with op.batch_alter_table('tickets', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_tickets_uid_public'))

    op.drop_table('tickets')
    op.drop_table('team_messages')
    op.drop_table('prets')
    op.drop_table('notifications')
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_users_username'))

    op.drop_table('users')
    op.drop_table('materiels')
    # ### end Alembic commands ###


