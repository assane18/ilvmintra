{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto py-8">
    
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-black text-slate-900 uppercase tracking-tight">Gestion Utilisateurs</h1>
            <p class="text-slate-500 font-bold text-xs mt-1 uppercase tracking-wide">Administration des accès & Rôles</p>
        </div>
        <div class="bg-blue-50 text-blue-700 px-4 py-2 rounded-xl font-bold text-xs shadow-sm border border-blue-100">
            {{ users|length }} Comptes actifs
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <table class="w-full text-left text-sm">
            <thead class="bg-slate-50 border-b border-slate-200">
                <tr class="text-slate-500 font-black uppercase text-[10px] tracking-wider">
                    <th class="px-6 py-4">Utilisateur</th>
                    <th class="px-6 py-4">Email / Login</th>
                    <th class="px-6 py-4">Rôle</th>
                    <th class="px-6 py-4">Service</th>
                    <th class="px-6 py-4 text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 font-medium text-slate-700">
                {% for user in users %}
                <tr class="hover:bg-slate-50 transition group">
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-900">{{ user.fullname }}</div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold mt-0.5">ID: {{ user.id }}</div>
                    </td>
                    <td class="px-6 py-4 text-slate-500 font-mono text-xs">{{ user.username }}</td>
                    <td class="px-6 py-4">
                        <span class="inline-block px-2 py-1 rounded text-[10px] font-black uppercase tracking-wide 
                            {% if 'ADMIN' in user.role.value %}bg-purple-100 text-purple-700
                            {% elif 'SOLVER' in user.role.value %}bg-blue-100 text-blue-700
                            {% elif 'MANAGER' in user.role.value %}bg-orange-100 text-orange-700
                            {% else %}bg-slate-100 text-slate-600{% endif %}">
                            {{ user.role.value }}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        {% if user.service_department %}
                            <span class="font-bold text-slate-600 text-xs flex items-center gap-1">
                                <span class="w-2 h-2 rounded-full bg-slate-300"></span>
                                {{ user.service_department.value }}
                            </span>
                        {% else %}
                            <span class="text-slate-300 italic text-xs">-</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-right flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition">
                        <!-- Bouton Modifier -->
                        <button onclick="openEditModal('{{ user.id }}', '{{ user.fullname }}', '{{ user.role.value }}', '{{ user.service_department.value if user.service_department else 'None' }}')" 
                            class="text-blue-600 hover:text-blue-800 bg-blue-50 p-2 rounded-lg transition" title="Modifier">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                        </button>
                        
                        <!-- Bouton Supprimer -->
                        {% if user.id != current_user.id %}
                        <a href="{{ url_for('users.delete_user', id=user.id) }}" onclick="return confirm('Supprimer définitivement ce compte ?')" 
                           class="text-red-400 hover:text-red-600 bg-red-50 p-2 rounded-lg transition" title="Supprimer">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<!-- MODAL EDITION (Caché par défaut) -->
<div id="editUserModal" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm transition-opacity">
    <div class="bg-white p-8 rounded-3xl w-full max-w-lg m-4 shadow-2xl relative">
        <button onclick="document.getElementById('editUserModal').classList.add('hidden')" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 transition">
            <i data-lucide="x" class="w-6 h-6"></i>
        </button>
        
        <h3 class="text-xl font-black text-slate-900 uppercase tracking-tight mb-6 flex items-center gap-2">
            <i data-lucide="user-cog" class="text-blue-600"></i> Modifier Utilisateur
        </h3>

        <form id="editUserForm" method="POST" class="space-y-5">
            
            <div>
                <label class="label-tiny">Nom Complet</label>
                <input type="text" name="fullname" id="editFullname" class="input-field" required>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label-tiny">Rôle Système</label>
                    <select name="role" id="editRole" class="input-field">
                        {% for r in roles %}
                        <option value="{{ r }}">{{ r }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="label-tiny">Service (Si Tech)</label>
                    <select name="service" id="editService" class="input-field">
                        <option value="None">Aucun (User)</option>
                        {% for s in services %}
                        <option value="{{ s }}">{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <button type="submit" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl hover:bg-blue-600 transition shadow-lg text-xs uppercase tracking-widest mt-4">
                Enregistrer les modifications
            </button>
        </form>
    </div>
</div>

<script>
    lucide.createIcons();

    function openEditModal(id, fullname, role, service) {
        // Injection des données dans le formulaire
        document.getElementById('editUserForm').action = `/admin/users/edit/${id}`;
        document.getElementById('editFullname').value = fullname;
        document.getElementById('editRole').value = role;
        
        // Sélection du service (ou None)
        const serviceSelect = document.getElementById('editService');
        serviceSelect.value = service && service !== 'None' ? service : 'None';
        
        document.getElementById('editUserModal').classList.remove('hidden');
    }
</script>
{% endblock %}
