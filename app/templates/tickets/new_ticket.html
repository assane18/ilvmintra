{% extends "base.html" %}

{% block content %}
<div class="flex justify-center items-start min-h-[80vh] pt-10 pb-20">

    <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-200 w-full max-w-3xl relative">
        
        <a href="{{ url_for('main.user_portal') }}" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 transition">
            <i data-lucide="x" class="w-6 h-6"></i>
        </a>

        <div class="text-center mb-8">
            <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 
                {% if service_name == 'INFO' %}bg-blue-50 text-blue-600
                {% elif service_name == 'DAF' %}bg-purple-50 text-purple-600
                {% elif service_name == 'TECH' %}bg-orange-50 text-orange-600
                {% else %}bg-emerald-50 text-emerald-600{% endif %}">
                
                {% if service_name == 'INFO' %}<i data-lucide="monitor" class="w-8 h-8"></i>
                {% elif service_name == 'DAF' %}<i data-lucide="banknote" class="w-8 h-8"></i>
                {% elif service_name == 'TECH' %}<i data-lucide="wrench" class="w-8 h-8"></i>
                {% else %}<i data-lucide="file-plus" class="w-8 h-8"></i>{% endif %}
            </div>
            <h1 class="text-3xl font-black text-slate-800 tracking-tight mb-2">Nouvelle Demande <span class="text-blue-600">{{ service.value }}</span></h1>
            <p class="text-slate-500">Remplissez les informations ci-dessous.</p>
        </div>

        <form method="POST" enctype="multipart/form-data" class="space-y-6">
            
            <!-- SÉLECTEUR SERVICE DEMANDEUR (Si User a plusieurs GU) -->
            {% if user_origins|length > 1 %}
            <div class="bg-slate-50 p-4 rounded-lg border border-yellow-500 mb-6">
                <label class="block text-slate-700 text-sm font-bold mb-2">Pour quel service faites-vous cette demande ?</label>
                <select name="selected_origin" class="w-full bg-white text-slate-800 rounded p-2 border border-slate-300 focus:ring-2 focus:ring-blue-500">
                    {% for origin in user_origins %}
                    <option value="{{ origin }}">GU-{{ origin }}</option>
                    {% endfor %}
                </select>
                <p class="text-xs text-slate-500 mt-1">En tant que Directeur/Manager multi-services, veuillez préciser l'origine.</p>
            </div>
            {% else %}
                <!-- Champ caché si un seul service -->
                {% if user_origins %}
                <input type="hidden" name="selected_origin" value="{{ user_origins[0] }}">
                {% endif %}
            {% endif %}

            <!-- TYPE DE DEMANDE -->
            <div>
                <label class="label-tiny">Type de demande</label>
                <select name="category_ticket" id="category_ticket" onchange="toggleFormFields()" class="input-field cursor-pointer">
                    <option value="Standard">Demande / Incident Standard</option>
                    {% if service_name == 'INFO' %}
                    <option value="Nouvel Utilisateur">Création Nouvel Utilisateur</option>
                    <option value="Matériel">Demande de Matériel</option>
                    {% endif %}
                    {% if service_name == 'DAF' %}
                    <option value="Bon de Commande">Bon de Commande</option>
                    {% endif %}
                </select>
            </div>

            <!-- CHAMPS COMMUNS -->
            <div id="common-fields" class="space-y-4">
                <div>
                    <label class="label-tiny">Titre de la demande</label>
                    <input type="text" name="title" class="input-field" placeholder="Ex: Problème d'impression...">
                </div>
                <div>
                    <label class="label-tiny">Description détaillée</label>
                    <textarea name="description" rows="4" class="input-field" placeholder="Décrivez votre besoin..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label-tiny">Nom de la machine (Hostname)</label>
                        <input type="text" name="hostname" class="input-field" placeholder="Auto-détection si vide">
                    </div>
                    <div>
                        <label class="label-tiny">Téléphone de contact</label>
                        <input type="text" name="tel_demandeur" class="input-field" placeholder="06...">
                    </div>
                </div>
            </div>

            <!-- FORMULAIRE NOUVEL UTILISATEUR (INFO ONLY) -->
            <div id="new-user-fields" class="hidden bg-blue-50 p-6 rounded-2xl border border-blue-100 space-y-4">
                <h3 class="font-bold text-blue-800 mb-4 flex items-center"><i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> Fiche Nouvel Arrivant</h3>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" name="new_user_nom" placeholder="Nom" class="input-field bg-white">
                    <input type="text" name="new_user_prenom" placeholder="Prénom" class="input-field bg-white">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label-tiny">Date d'arrivée</label>
                        <input type="date" name="new_user_date" class="input-field bg-white">
                    </div>
                    <div>
                        <label class="label-tiny">Service affecté</label>
                        <input type="text" name="new_user_service" class="input-field bg-white">
                    </div>
                </div>
                <div>
                    <label class="label-tiny">Besoins d'accès (Dossiers, Logiciels...)</label>
                    <textarea name="new_user_acces" rows="3" class="input-field bg-white" placeholder="Ex: Accès dossier Compta, Logiciel SAGE..."></textarea>
                </div>
            </div>

            <!-- FORMULAIRE MATÉRIEL (INFO ONLY) -->
            <div id="materiel-fields" class="hidden bg-orange-50 p-6 rounded-2xl border border-orange-100 space-y-4">
                <h3 class="font-bold text-orange-800 mb-4 flex items-center"><i data-lucide="monitor" class="w-5 h-5 mr-2"></i> Demande de Matériel</h3>
                <textarea name="materiel_list" rows="3" class="input-field bg-white" placeholder="Ex: 1 PC Portable, 1 Écran 24 pouces..."></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" name="destinataire_materiel" placeholder="Pour qui ?" class="input-field bg-white">
                    <input type="text" name="lieu_installation_mat" placeholder="Lieu d'installation" class="input-field bg-white">
                </div>
            </div>

            <!-- FORMULAIRE BON DE COMMANDE (DAF ONLY) -->
            {% if service_name == 'DAF' %}
            <div id="daf-fields" class="hidden space-y-6">
                <div class="bg-purple-50 p-6 rounded-2xl border border-purple-100 space-y-4">
                    <h3 class="font-bold text-purple-800 mb-4">Informations Fournisseur</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" name="daf_fournisseur_nom" placeholder="Nom Fournisseur" class="input-field bg-white">
                        <input type="email" name="daf_fournisseur_email" placeholder="Email" class="input-field bg-white">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" name="daf_fournisseur_tel" placeholder="Téléphone" class="input-field bg-white">
                        <input type="text" name="daf_fournisseur_fax" placeholder="Fax (Optionnel)" class="input-field bg-white">
                    </div>
                </div>

                <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-4">Détails de la commande</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-200 text-slate-700 uppercase">
                                <tr>
                                    <th class="p-2">Désignation</th>
                                    <th class="p-2 w-24">Réf</th>
                                    <th class="p-2 w-16">Qté</th>
                                    <th class="p-2 w-24">P.U (€)</th>
                                    <th class="p-2 w-24">Total</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200">
                                {% for i in range(1, 6) %}
                                <tr>
                                    <td class="p-2"><input type="text" name="daf_designation_{{i}}" class="w-full bg-white border border-slate-300 rounded p-1"></td>
                                    <td class="p-2"><input type="text" name="daf_ref_{{i}}" class="w-full bg-white border border-slate-300 rounded p-1"></td>
                                    <td class="p-2"><input type="number" name="daf_qte_{{i}}" id="qte_{{i}}" oninput="calcTotal({{i}})" class="w-full bg-white border border-slate-300 rounded p-1"></td>
                                    <td class="p-2"><input type="number" step="0.01" name="daf_pu_{{i}}" id="pu_{{i}}" oninput="calcTotal({{i}})" class="w-full bg-white border border-slate-300 rounded p-1"></td>
                                    <td class="p-2"><input type="text" id="total_{{i}}" name="daf_total_{{i}}" readonly class="w-full bg-slate-100 border-none rounded p-1 text-right font-mono"></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-right font-bold p-2">TOTAL ESTIMÉ :</td>
                                    <td class="p-2 font-bold text-right" id="grandTotal">0.00 €</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="mt-4">
                        <label class="label-tiny">Type de prix</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="daf_type_prix" value="HT" checked class="form-radio text-purple-600">
                                <span>Hors Taxe (HT)</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="daf_type_prix" value="TTC" class="form-radio text-purple-600">
                                <span>TTC</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-4">Pièces Jointes (Devis)</h3>
                    <input type="file" name="devis_1" class="input-field bg-white mb-2">
                    <input type="file" name="devis_2" class="input-field bg-white">
                </div>
            </div>
            {% endif %}

            <!-- BOUTON ENVOYER -->
            <button type="submit" class="w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800 transition transform hover:scale-[1.01] shadow-lg flex justify-center items-center">
                <span>Envoyer la demande</span>
                <i data-lucide="send" class="ml-2 w-5 h-5"></i>
            </button>
        </form>
    </div>
</div>

<script>
    function toggleFormFields() {
        const category = document.getElementById('category_ticket').value;
        const common = document.getElementById('common-fields');
        const newUser = document.getElementById('new-user-fields');
        const materiel = document.getElementById('materiel-fields');
        const daf = document.getElementById('daf-fields');

        // Reset
        if(newUser) newUser.classList.add('hidden');
        if(materiel) materiel.classList.add('hidden');
        if(daf) daf.classList.add('hidden');
        if(common) common.classList.remove('hidden');

        // DAF Special
        if (category === 'Bon de Commande') {
            if(daf) daf.classList.remove('hidden');
            if(common) common.classList.add('hidden'); // On cache titre/desc pour bon de commande pur
        } 
        // INFO Special
        else {
            if (category === 'Nouvel Utilisateur' && newUser) newUser.classList.remove('hidden');
            if (category === 'Matériel' && materiel) materiel.classList.remove('hidden');
        }
    }

    function calcTotal(i) {
        const qte = parseFloat(document.getElementById('qte_' + i).value) || 0;
        const pu = parseFloat(document.getElementById('pu_' + i).value) || 0;
        const total = qte * pu;
        document.getElementById('total_' + i).value = total.toFixed(2);
        
        let grandTotal = 0;
        for(let j=1; j<=5; j++) {
            const val = parseFloat(document.getElementById('total_' + j).value) || 0;
            grandTotal += val;
        }
        document.getElementById('grandTotal').innerText = grandTotal.toFixed(2) + ' €';
    }
</script>

<style>
    .label-tiny { font-size: 10px; font-weight: 900; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.1em; margin-bottom: 6px; display: block; } 
    .input-field { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.75rem; outline: none; transition: all 0.2s; }
    .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); background-color: white; }
</style>
{% endblock %}
