{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-slate-800 dark:text-white">Validation Hiérarchique</h1>
            <p class="text-slate-500 dark:text-slate-400 mt-2">Gérez les demandes de vos équipes et de votre service.</p>
        </div>
        <div class="flex gap-2">
            <span class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-bold">
                <i data-lucide="shield" class="w-4 h-4 inline mr-1"></i> 
                {{ current_user.role.value }}
            </span>
        </div>
    </div>

    <!-- TABS -->
    <div x-data="{ activeTab: 'n1' }" class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden border border-slate-200 dark:border-slate-700 min-h-[600px]">
        
        <!-- Tab Headers -->
        <div class="flex border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50">
            <button @click="activeTab = 'n1'" 
                :class="{ 'border-b-2 border-blue-500 text-blue-600 bg-white dark:bg-slate-800 dark:text-blue-400': activeTab === 'n1', 'text-slate-500 hover:text-slate-700 dark:text-slate-400': activeTab !== 'n1' }"
                class="flex-1 py-4 text-center font-bold text-sm transition relative">
                Validation Équipe (N1)
                {% if tickets_n1 %}
                <span class="absolute top-3 right-4 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center animate-pulse">{{ tickets_n1|length }}</span>
                {% endif %}
            </button>
            
            <button @click="activeTab = 'n2'" 
                :class="{ 'border-b-2 border-purple-500 text-purple-600 bg-white dark:bg-slate-800 dark:text-purple-400': activeTab === 'n2', 'text-slate-500 hover:text-slate-700 dark:text-slate-400': activeTab !== 'n2' }"
                class="flex-1 py-4 text-center font-bold text-sm transition relative">
                Validation Tech/Budget (N2)
                {% if tickets_n2 %}
                <span class="absolute top-3 right-4 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center animate-pulse">{{ tickets_n2|length }}</span>
                {% endif %}
            </button>

            <button @click="activeTab = 'fcpi'" 
                :class="{ 'border-b-2 border-pink-500 text-pink-600 bg-white dark:bg-slate-800 dark:text-pink-400': activeTab === 'fcpi', 'text-slate-500 hover:text-slate-700 dark:text-slate-400': activeTab !== 'fcpi' }"
                class="flex-1 py-4 text-center font-bold text-sm transition relative">
                Recrutements (FCPI)
                {% if fcpi_requests %}
                <span class="absolute top-3 right-4 w-5 h-5 bg-pink-500 text-white text-xs rounded-full flex items-center justify-center animate-pulse">{{ fcpi_requests|length }}</span>
                {% endif %}
            </button>
        </div>

        <!-- TAB N1 -->
        <div x-show="activeTab === 'n1'" class="p-6 animate-fadeIn">
            {% if tickets_n1 %}
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-xs font-bold text-slate-500 uppercase border-b border-slate-200 dark:border-slate-700">
                            <th class="pb-3 pl-2">Réf</th>
                            <th class="pb-3">Demandeur</th>
                            <th class="pb-3">Sujet</th>
                            <th class="pb-3">Cible</th>
                            <th class="pb-3 text-right pr-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                        {% for t in tickets_n1 %}
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                            <td class="py-4 pl-2 font-mono text-xs text-slate-500">{{ t.uid_public }}</td>
                            <td class="py-4 font-bold text-sm">{{ t.author.fullname }}</td>
                            <td class="py-4">{{ t.title }}</td>
                            <td class="py-4"><span class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-xs font-bold">{{ t.target_service.value }}</span></td>
                            <td class="py-4 text-right pr-2 flex justify-end gap-2">
                                <a href="{{ url_for('tickets.view_ticket', ticket_uid=t.uid_public) }}" class="p-2 text-slate-400 hover:text-blue-500 border rounded-lg"><i data-lucide="eye" class="w-4 h-4"></i></a>
                                <a href="{{ url_for('tickets.manager_action', ticket_id=t.id, action='validate') }}" class="px-3 py-2 bg-emerald-500 text-white rounded-lg text-xs font-bold flex items-center hover:bg-emerald-600"><i data-lucide="check" class="w-3 h-3 mr-1"></i> Valider</a>
                                <button onclick="openRefusalModal('{{ t.id }}', '{{ t.uid_public }}')" class="px-3 py-2 bg-white border border-red-200 text-red-500 hover:bg-red-50 rounded-lg text-xs font-bold">Refuser</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center py-20 text-slate-400">Aucune demande.</p>
            {% endif %}
        </div>

        <!-- TAB N2 -->
        <div x-show="activeTab === 'n2'" class="p-6 animate-fadeIn" style="display: none;">
            {% if tickets_n2 %}
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-xs font-bold text-slate-500 uppercase border-b border-slate-200 dark:border-slate-700">
                            <th class="pb-3 pl-2">Réf</th>
                            <th class="pb-3">Type</th>
                            <th class="pb-3">Demandeur</th>
                            <th class="pb-3">Statut</th>
                            <th class="pb-3 text-right pr-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                        {% for t in tickets_n2 %}
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                            <td class="py-4 pl-2 font-mono text-xs text-slate-500">{{ t.uid_public }}</td>
                            <td class="py-4">
                                <span class="font-bold text-sm block">{{ t.title }}</span>
                                {% if t.category_ticket == 'Demande Matériel' %}
                                <span class="text-xs text-teal-500 font-bold bg-teal-50 px-1 rounded">Matériel</span>
                                {% elif t.category_ticket == 'Bon de Commande' %}
                                <span class="text-xs text-purple-500 font-bold bg-purple-50 px-1 rounded">Bon de Commande</span>
                                {% endif %}
                            </td>
                            <td class="py-4 text-sm">{{ t.author.fullname }}</td>
                            <td class="py-4">
                                <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs font-bold border border-orange-200">Validation Requise</span>
                            </td>
                            <td class="py-4 text-right pr-2 flex justify-end gap-2">
                                <a href="{{ url_for('tickets.view_ticket', ticket_uid=t.uid_public) }}" class="p-2 text-slate-400 hover:text-blue-500 border rounded-lg"><i data-lucide="eye" class="w-4 h-4"></i></a>
                                <a href="{{ url_for('tickets.manager_action', ticket_id=t.id, action='validate') }}" class="px-3 py-2 bg-emerald-500 text-white rounded-lg text-xs font-bold flex items-center hover:bg-emerald-600"><i data-lucide="check" class="w-3 h-3 mr-1"></i> Valider</a>
                                <button onclick="openRefusalModal('{{ t.id }}', '{{ t.uid_public }}')" class="px-3 py-2 bg-white border border-red-200 text-red-500 hover:bg-red-50 rounded-lg text-xs font-bold">Refuser</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center py-20 text-slate-400">Aucune validation technique.</p>
            {% endif %}
        </div>
        
        <!-- TAB FCPI (Inchangé) -->
        <div x-show="activeTab === 'fcpi'" class="p-6 animate-fadeIn" style="display: none;">
             {% if fcpi_requests %}
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-xs font-bold text-slate-500 uppercase border-b border-slate-200 dark:border-slate-700">
                            <th class="pb-3 pl-2">Réf</th>
                            <th class="pb-3">Candidat</th>
                            <th class="pb-3 text-right pr-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in fcpi_requests %}
                        <tr>
                            <td class="py-4 pl-2 font-mono text-xs text-pink-500 font-bold">{{ r.uid_public }}</td>
                            <td class="py-4 font-bold">{{ r.nom_agent }}</td>
                            <td class="py-4 text-right pr-2">
                                <a href="{{ url_for('fcpi.view_fcpi', id=r.id) }}" class="px-4 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded-lg text-xs font-bold">Examiner</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center py-20 text-slate-400">Aucun recrutement.</p>
            {% endif %}
        </div>

    </div>
</div>

<!-- MODALE DE REFUS -->
<div id="refusalModal" class="hidden fixed inset-0 bg-slate-900/60 dark:bg-slate-950/80 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl w-full max-w-md shadow-2xl relative border border-slate-100 dark:border-slate-700">
        <h3 class="text-xl font-black text-slate-900 dark:text-white uppercase tracking-tight mb-4">Refuser le ticket <span id="refusalRef" class="text-red-500"></span></h3>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Merci d'indiquer le motif du refus. Il sera notifié au demandeur.</p>
        
        <form id="refusalForm" method="POST">
            <textarea name="refusal_reason" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-red-500 mb-4" rows="3" placeholder="Motif du refus..." required></textarea>
            
            <div class="flex gap-3">
                <button type="button" onclick="document.getElementById('refusalModal').classList.add('hidden')" class="flex-1 py-3 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold rounded-xl text-xs uppercase">Annuler</button>
                <button type="submit" class="flex-1 py-3 bg-red-600 text-white font-bold rounded-xl text-xs uppercase hover:bg-red-700">Confirmer Refus</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openRefusalModal(id, uid) {
        document.getElementById('refusalRef').innerText = uid;
        const form = document.getElementById('refusalForm');
        // Génère l'URL correcte : manager/action/ID/refuse
        form.action = "{{ url_for('tickets.manager_dashboard') }}".replace('manager/dashboard', 'manager/action/' + id + '/refuse');
        document.getElementById('refusalModal').classList.remove('hidden');
    }
    lucide.createIcons();
</script>
{% endblock %}
