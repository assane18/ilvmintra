<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ILVM - Intranet</title>
    <!-- Tailwind CSS (avec support Dark Mode) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b', // Couleur sombre custom
                            950: '#020617', // Tr√®s sombre
                        }
                    }
                }
            }
        }
    </script>
    <!--  LES ONGLETS üëá -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Ic√¥nes Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Vos styles personnalis√©s conserv√©s */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        .alert-error { background-color: #fee2e2; border-left: 4px solid #ef4444; color: #b91c1c; }
        .alert-success { background-color: #d1fae5; border-left: 4px solid #10b981; color: #047857; }
        .alert-warning { background-color: #ffedd5; border-left: 4px solid #f97316; color: #c2410c; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .anim-greeting { animation: fadeInUp 0.5s ease-out forwards; }
        
        /* Styles sp√©cifiques Dark Mode pour les alertes */
        .dark .alert-error { background-color: #450a0a; border-left-color: #ef4444; color: #fca5a5; }
        .dark .alert-success { background-color: #022c22; border-left-color: #10b981; color: #6ee7b7; }
        .dark .alert-warning { background-color: #431407; border-left-color: #f97316; color: #fdba74; }
    </style>
    
    <!-- Script d'initialisation du th√®me (avant chargement du body pour √©viter le flash) -->
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-slate-50 font-sans text-slate-900 antialiased selection:bg-blue-100 selection:text-blue-900 dark:bg-slate-950 dark:text-slate-100 dark:selection:bg-blue-900 dark:selection:text-blue-100 transition-colors duration-300">

    <!-- Flash Messages (Notifications) -->
    <div class="fixed top-4 right-4 z-50 w-96 space-y-2 pointer-events-none">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="pointer-events-auto shadow-lg rounded-lg p-4 mb-2 flex items-start transform transition-all duration-300 hover:scale-105 bg-white dark:bg-slate-800 border border-transparent
                    {% if category == 'danger' %}alert-error{% elif category == 'success' %}alert-success{% else %}alert-warning{% endif %}">
                    <div class="flex-1">
                        <p class="font-bold text-sm">{{ 'Succ√®s' if category == 'success' else 'Attention' }}</p>
                        <p class="text-sm opacity-90">{{ message }}</p>
                    </div>
                    <button onclick="this.parentElement.remove()" class="ml-3 text-current opacity-50 hover:opacity-100 focus:outline-none">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Navigation Bar (Optionnelle, visible sauf sur Login) -->
    {% if current_user.is_authenticated and request.endpoint != 'auth.login' %}
    <nav class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center sticky top-0 z-40 shadow-sm dark:bg-slate-900 dark:border-slate-800 transition-colors duration-300">
        <div class="flex items-center gap-4">
            <a href="{{ url_for('main.user_portal') }}" class="flex items-center gap-2 group">
             <!--   <div class="bg-blue-600 text-white p-1.5 rounded-lg group-hover:bg-blue-700 transition">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i>
                </div> -->
                <span class="font-black text-xl tracking-tighter text-blue-500 italic flex items-center gap-2">
                    <i data-lucide="layout-dashboard"></i> ILVM<span class="text-white">DASHBOARD</span>
                </span>
            </a>
            
            <!-- Liens contextuels VISIBLES POUR TOUS (S√©curit√© g√©r√©e par redirection backend) -->
            <div class="hidden md:flex gap-1 ml-6">
                <!-- Bouton Espace Tech (Visible pour tous) -->
                <a href="{{ url_for('tickets.solver_dashboard') }}" class="px-3 py-1.5 rounded-md text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-blue-50 transition flex items-center gap-2 dark:text-slate-300 dark:hover:text-blue-400 dark:hover:bg-slate-800">
                    <i data-lucide="wrench" class="w-4 h-4"></i> Espace Tech
                </a>
                
                <!-- Bouton Validation (Visible pour tous) -->
                <a href="{{ url_for('tickets.manager_dashboard') }}" class="px-3 py-1.5 rounded-md text-sm font-medium text-slate-600 hover:text-purple-600 hover:bg-purple-50 transition flex items-center gap-2 dark:text-slate-300 dark:hover:text-purple-400 dark:hover:bg-slate-800">
                    <i data-lucide="check-circle" class="w-4 h-4"></i> Validation
                </a>
            </div>
        </div>

        <div class="flex items-center gap-4">
            
            <!-- BOUTON DARK MODE -->
            <button id="theme-toggle" class="p-2 text-slate-400 hover:text-yellow-500 hover:bg-slate-100 dark:hover:bg-slate-800 dark:hover:text-yellow-300 rounded-lg transition" title="Changer le th√®me">
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
            </button>

            <!-- Notifications -->
            <div class="relative" id="notif-container">
                <button onclick="toggleNotifs()" class="relative p-2 text-slate-400 hover:text-blue-600 transition rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 dark:hover:text-blue-400">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span id="notif-badge" class="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full hidden"></span>
                </button>
                
                <!-- Dropdown Notifs -->
                <div id="notif-dropdown" class="absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-2xl border border-slate-100 hidden transform origin-top-right transition-all z-50 dark:bg-slate-800 dark:border-slate-700">
                    <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl dark:bg-slate-700 dark:border-slate-600">
                        <span class="text-xs font-bold text-slate-500 uppercase tracking-wider dark:text-slate-300">Notifications</span>
                        <button onclick="markAllRead()" class="text-xs text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">Tout marquer lu</button>
                    </div>
                    <div id="notif-list" class="max-h-64 overflow-y-auto scrollbar-hide p-1 space-y-1">
                        <!-- JS injectera ici -->
                        <div class="p-4 text-center text-slate-400 text-xs italic">Chargement...</div>
                    </div>
                </div>
            </div>

            <!-- User Menu -->
            <div class="flex items-center gap-3 pl-4 border-l border-slate-200 dark:border-slate-700">
                <div class="text-right hidden sm:block">
                    <p class="text-sm font-bold text-slate-700 leading-none dark:text-slate-200">{{ current_user.fullname }}</p>
                    <p class="text-[10px] text-slate-400 font-mono mt-1 uppercase">{{ current_user.role.value }}</p>
                </div>
                <a href="{{ url_for('auth.logout') }}" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition dark:hover:bg-slate-800" title="D√©connexion">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </a>
            </div>
        </div>
    </nav>
    {% endif %}

    <!-- Main Content -->
    <main class="min-h-screen bg-slate-50 dark:bg-slate-950 transition-colors duration-300">
        {% block content %}{% endblock %}
    </main>

    <!-- Init Lucide Icons -->
    <script>
        lucide.createIcons();

        // --- GESTION DARK MODE ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeIconSun = document.querySelector('.dark\\:block'); // Soleil
        const themeIconMoon = document.querySelector('.dark\\:hidden'); // Lune

        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', function() {
                // Bascule la classe dark sur html
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.theme = 'light';
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.theme = 'dark';
                }
            });
        }

        // --- GESTION NOTIFICATIONS (CORRIG√â) ---
        const notifBadge = document.getElementById('notif-badge');
        const notifDropdown = document.getElementById('notif-dropdown');
        const notifList = document.getElementById('notif-list');

        function toggleNotifs() {
            if (notifDropdown.classList.contains('hidden')) {
                notifDropdown.classList.remove('hidden');
                loadNotifications();
            } else {
                notifDropdown.classList.add('hidden');
            }
        }

        async function checkNotificationCount() {
            try {
                // CORRECTION : Utilisation de url_for pour la bonne route API
                const res = await fetch("{{ url_for('api.get_notifications_count') }}");
                const data = await res.json();
                if (data.count > 0) {
                    notifBadge.classList.remove('hidden');
                } else {
                    notifBadge.classList.add('hidden');
                }
            } catch (e) { console.error("Notif error", e); }
        }

        // V√©rif toutes les 30s
        if(document.getElementById('notif-container')) {
            setInterval(checkNotificationCount, 30000);
            checkNotificationCount();
        }

        async function loadNotifications() {
            try {
                // CORRECTION : Utilisation de url_for
                const res = await fetch("{{ url_for('api.get_notifications') }}");
                const data = await res.json();
                notifList.innerHTML = '';
                
                if (data.notifications.length === 0) {
                    notifList.innerHTML = '<div class="p-4 text-center text-slate-400 text-xs dark:text-slate-500">Aucune notification.</div>';
                    return;
                }

                data.notifications.forEach(n => {
                    const item = document.createElement('div');
                    // Adaptation Dark Mode pour les items de notif
                    item.className = `p-3 rounded-lg hover:bg-slate-50 cursor-pointer transition border-l-2 dark:hover:bg-slate-700 ${n.is_read ? 'border-transparent opacity-50' : 'border-blue-500 bg-blue-50/50 dark:bg-blue-900/20'}`;
                    
                    let colorClass = 'bg-blue-500';
                    if (n.category === 'success') colorClass = 'bg-green-500';
                    if (n.category === 'warning' || n.category === 'danger') colorClass = 'bg-red-500';

                    item.innerHTML = `
                        <div class="flex gap-3 items-start">
                            <div class="w-2 h-2 mt-1.5 rounded-full ${colorClass}"></div>
                            <div class="flex-1">
                                <p class="text-xs font-bold text-slate-700 leading-tight dark:text-slate-200">${n.message}</p>
                                <p class="text-[10px] text-slate-400 mt-1">${new Date(n.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                            </div>
                        </div>
                    `;
                    item.onclick = () => {
                        markRead(n.id);
                        if (n.link) window.location.href = n.link;
                    };
                    notifList.appendChild(item);
                });
            } catch (e) {
                notifList.innerHTML = '<div class="p-4 text-center text-red-400 text-xs">Erreur de chargement.</div>';
            }
        }

        async function markRead(id) {
            // CORRECTION URL
            await fetch(`/api/notifications/read/${id}`, { method: 'POST' });
            checkNotificationCount();
        }

        async function markAllRead() {
            // CORRECTION URL (url_for serait mieux mais ici c'est plus complexe √† injecter dans une string template JS pur, le hardcode relatif marche souvent si api_bp n'a pas de pr√©fixe complexe)
            await fetch("{{ url_for('api.mark_all_read') }}", { method: 'POST' });
            checkNotificationCount();
            notifDropdown.classList.add('hidden');
        }
    </script>
</body>
</html>
